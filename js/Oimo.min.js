function mtri(t,i,s){return{a:t,b:i,c:s}}function tricheck(t,i,s,h){var e=.5*(-s.y*h.x+i.y*(-s.x+h.x)+i.x*(s.y-h.y)+s.x*h.y),o=e<0?-1:1,a=(i.y*h.x-i.x*h.y+(h.y-i.y)*t.x+(i.x-h.x)*t.y)*o,n=(i.x*s.y-i.y*s.x+(i.y-s.y)*t.x+(s.x-i.x)*t.y)*o;return a>0&&n>0&&a+n<2*e*o}function pt(t,i){return{x:t,y:i}}var OIMO={REVISION:"1.2",nextID:0,proxyID:0,BR_NULL:0,BR_BRUTE_FORCE:1,BR_SWEEP_AND_PRUNE:2,BR_BOUNDING_VOLUME_TREE:3,BODY_NULL:0,BODY_DYNAMIC:1,BODY_STATIC:2,SHAPE_NULL:0,SHAPE_SPHERE:1,SHAPE_BOX:2,SHAPE_CYLINDER:3,SHAPE_TETRA:4,JOINT_NULL:0,JOINT_DISTANCE:1,JOINT_BALL_AND_SOCKET:2,JOINT_HINGE:3,JOINT_WHEEL:4,JOINT_SLIDER:5,JOINT_PRISMATIC:6,WORLD_SCALE:100,INV_SCALE:.01,AABB_PROX:.005,sqrt:Math.sqrt,abs:Math.abs,floor:Math.floor,cos:Math.cos,sin:Math.sin,acos:Math.acos,asin:Math.asin,atan2:Math.atan2,round:Math.round,pow:Math.pow,max:Math.max,min:Math.min,random:Math.random,lerp:function(t,i,s){return t+(i-t)*s},rand:function(t,i){return OIMO.lerp(t,i,OIMO.random())},randInt:function(t,i,s){return 1*OIMO.lerp(t,i,OIMO.random()).toFixed(s||0)},"int":function(t){return~~t},fix:function(t,i){return t.toFixed(i||3,10)},clamp:function(t,i,s){return OIMO.max(i,OIMO.min(s,t))},degtorad:.017453292519943295,radtodeg:57.29577951308232,PI:3.141592653589793,TwoPI:6.283185307179586,PI90:1.570796326794896,PI270:4.712388980384689,CustomError:null,Error:function(t,i){null==OIMO.CustomError?console.error(t,i):OIMO.CustomError.innerHTML+=t+" - "+i+"<br>"}},OIMO_ARRAY_TYPE;OIMO_ARRAY_TYPE||(OIMO_ARRAY_TYPE="undefined"!=typeof Float32Array?Float32Array:Array);try{!function(t){var i,s=["now","webkitNow","msNow","mozNow"];if(t.performance)for(var h=0;h<s.length;++h){var e=s[h];if(t.performance[e]){i=function(){return t.performance[e]()};break}}i||(i=Date.now),OIMO.now=i}(window)}catch(e){OIMO.now=function(){return 0}}OIMO.World=function(t,i,s,h){switch(this.timeStep=t||.01666,this.numIterations=s||8,i||2){case 1:this.broadPhase=new OIMO.BruteForceBroadPhase;break;case 2:default:this.broadPhase=new OIMO.SAPBroadPhase;break;case 3:this.broadPhase=new OIMO.DBVTBroadPhase}this.performance=null,this.isNoStat=h||!1,this.isNoStat||(this.performance=new OIMO.Performance(this)),this.enableRandomizer=!0,this.rigidBodies=null,this.numRigidBodies=0,this.contacts=null,this.unusedContacts=null,this.numContacts=0,this.numContactPoints=0,this.joints=null,this.numJoints=0,this.numIslands=0,this.gravity=new OIMO.Vec3(0,(-9.80665),0);var e=5;this.detectors=[],this.detectors.length=e;for(var o=e;o--;)this.detectors[o]=[],this.detectors[o].length=e;this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_SPHERE]=new OIMO.SphereSphereCollisionDetector,this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_BOX]=new OIMO.SphereBoxCollisionDetector((!1)),this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_SPHERE]=new OIMO.SphereBoxCollisionDetector((!0)),this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_BOX]=new OIMO.BoxBoxCollisionDetector,this.detectors[OIMO.SHAPE_CYLINDER][OIMO.SHAPE_CYLINDER]=new OIMO.CylinderCylinderCollisionDetector,this.detectors[OIMO.SHAPE_CYLINDER][OIMO.SHAPE_BOX]=new OIMO.BoxCylinderCollisionDetector((!0)),this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_CYLINDER]=new OIMO.BoxCylinderCollisionDetector((!1)),this.detectors[OIMO.SHAPE_CYLINDER][OIMO.SHAPE_SPHERE]=new OIMO.SphereCylinderCollisionDetector((!0)),this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_CYLINDER]=new OIMO.SphereCylinderCollisionDetector((!1)),this.detectors[OIMO.SHAPE_TETRA][OIMO.SHAPE_TETRA]=new OIMO.TetraTetraCollisionDetector,this.randX=65535,this.randA=98765,this.randB=123456789,this.islandRigidBodies=[],this.islandStack=[],this.islandConstraints=[]},OIMO.World.prototype={constructor:OIMO.World,clear:function(){for(this.randX=65535;null!==this.joints;)this.removeJoint(this.joints);for(;null!==this.contacts;)this.removeContact(this.contacts);for(;null!==this.rigidBodies;)this.removeRigidBody(this.rigidBodies);OIMO.nextID=0,OIMO.proxyID=0},addRigidBody:function(t){t.parent&&OIMO.Error("World","It is not possible to be added to more than one world one of the rigid body"),t.parent=this,t.awake();for(var i=t.shapes;null!==i;i=i.next)this.addShape(i);null!==this.rigidBodies&&((this.rigidBodies.prev=t).next=this.rigidBodies),this.rigidBodies=t,this.numRigidBodies++},removeRigidBody:function(t){var i=t;if(i.parent===this){i.awake();for(var s=i.jointLink;null!=s;){var h=s.joint;s=s.next,this.removeJoint(h)}for(var e=t.shapes;null!==e;e=e.next)this.removeShape(e);var o=i.prev,a=i.next;null!==o&&(o.next=a),null!==a&&(a.prev=o),this.rigidBodies==i&&(this.rigidBodies=a),i.prev=null,i.next=null,i.parent=null,this.numRigidBodies--}},getByName:function(t){for(var i=null,s=this.rigidBodies;null!==s;)" "!==s.name&&s.name===t&&(i=s),s=s.next;for(var h=this.joints;null!==h;)""!==h.name&&h.name===t&&(i=h),h=h.next;return i},addShape:function(t){t.parent&&t.parent.parent||OIMO.Error("World","It is not possible to be added alone to shape world"),t.proxy=this.broadPhase.createProxy(t),t.updateProxy(),this.broadPhase.addProxy(t.proxy)},removeShape:function(t){this.broadPhase.removeProxy(t.proxy),t.proxy=null},addJoint:function(t){t.parent&&OIMO.Error("World","It is not possible to be added to more than one world one of the joint"),null!=this.joints&&((this.joints.prev=t).next=this.joints),this.joints=t,t.parent=this,this.numJoints++,t.awake(),t.attach()},removeJoint:function(t){var i=t,s=i.prev,h=i.next;null!==s&&(s.next=h),null!==h&&(h.prev=s),this.joints==i&&(this.joints=h),i.prev=null,i.next=null,this.numJoints--,i.awake(),i.detach(),i.parent=null},worldscale:function(t){OIMO.WORLD_SCALE=t||100,OIMO.INV_SCALE=1/OIMO.WORLD_SCALE},addContact:function(t,i){var s;null!==this.unusedContacts?(s=this.unusedContacts,this.unusedContacts=this.unusedContacts.next):s=new OIMO.Contact,s.attach(t,i),s.detector=this.detectors[t.type][i.type],this.contacts&&((this.contacts.prev=s).next=this.contacts),this.contacts=s,this.numContacts++},removeContact:function(t){var i=t.prev,s=t.next;s&&(s.prev=i),i&&(i.next=s),this.contacts==t&&(this.contacts=s),t.prev=null,t.next=null,t.detach(),t.next=this.unusedContacts,this.unusedContacts=t,this.numContacts--},checkContact:function(t,i){for(var s,h,e=this.contacts;null!==e;){if(s=e.body1.name||" ",h=e.body2.name||" ",s==t&&h==i||h==t&&s==i)return!!e.touching;e=e.next}return!1},callSleep:function(t){return!!t.allowSleep&&(!(t.linearVelocity.lengthSq()>.04)&&!(t.angularVelocity.lengthSq()>.25))},step:function(){var t,i,s,h,e=!this.isNoStat;e&&(t=OIMO.now());for(var o=this.rigidBodies;null!==o;)o.addedToIsland=!1,o.sleeping&&(o.linearVelocity.testZero()||o.angularVelocity.testZero()||o.position.testDiff(o.sleepPosition)||o.orientation.testDiff(o.sleepOrientation))&&o.awake(),o=o.next;e&&(i=OIMO.now()),this.broadPhase.detectPairs();for(var a=this.broadPhase.pairs,n=this.broadPhase.numPairs;n--;){var r,l,c=a[n];c.shape1.id<c.shape2.id?(r=c.shape1,l=c.shape2):(r=c.shape2,l=c.shape1);var m;m=r.numContacts<l.numContacts?r.contactLink:l.contactLink;for(var p=!1;m;){var O=m.contact;if(O.shape1==r&&O.shape2==l){O.persisting=!0,p=!0;break}m=m.next}p||this.addContact(r,l)}for(e&&(s=OIMO.now(),this.performance.broadPhaseTime=s-i),this.numContactPoints=0,O=this.contacts;null!==O;)if(O.persisting||!O.shape1.aabb.intersectTest(O.shape2.aabb)){var u=O.body1,x=O.body2;(u.isDynamic&&!u.sleeping||x.isDynamic&&!x.sleeping)&&O.updateManifold(),this.numContactPoints+=O.manifold.numPoints,O.persisting=!1,O.constraint.addedToIsland=!1,O=O.next}else{var y=O.next;this.removeContact(O),O=y}e&&(h=OIMO.now(),this.performance.narrowPhaseTime=h-s);var I,M,d=1/this.timeStep;for(I=this.joints;null!==I;I=I.next)I.addedToIsland=!1;this.islandRigidBodies=[],this.islandConstraints=[],this.islandStack=[],i=OIMO.now(),this.numIslands=0;for(var N=this.rigidBodies;null!==N;N=N.next)if(!(N.addedToIsland||N.isStatic||N.sleeping))if(N.isLonely())N.isDynamic&&N.linearVelocity.addTime(this.gravity,this.timeStep),this.callSleep(N)?(N.sleepTime+=this.timeStep,N.sleepTime>.5?N.sleep():N.updatePosition(this.timeStep)):(N.sleepTime=0,N.updatePosition(this.timeStep)),this.numIslands++;else{var f=0,z=0,v=1;this.islandStack[0]=N,N.addedToIsland=!0;do if(o=this.islandStack[--v],this.islandStack[v]=null,o.sleeping=!1,this.islandRigidBodies[f++]=o,!o.isStatic){for(var b=o.contactLink;null!==b;b=b.next){var O=b.contact;if(M=O.constraint,!M.addedToIsland&&O.touching){this.islandConstraints[z++]=M,M.addedToIsland=!0;var y=b.body;y.addedToIsland||(this.islandStack[v++]=y,y.addedToIsland=!0)}}for(var A=o.jointLink;null!==A;A=A.next)M=A.joint,M.addedToIsland||(this.islandConstraints[z++]=M,M.addedToIsland=!0,y=A.body,!y.addedToIsland&&y.isDynamic&&(this.islandStack[v++]=y,y.addedToIsland=!0))}while(0!=v);for(var k=(new OIMO.Vec3).addTime(this.gravity,this.timeStep),S=f;S--;)o=this.islandRigidBodies[S],o.isDynamic&&o.linearVelocity.addEqual(k);if(this.enableRandomizer)for(S=z;S--;)if(0!==S){var P=(this.randX=this.randX*this.randA+this.randB&2147483647)/2147483648*S|0;M=this.islandConstraints[S],this.islandConstraints[S]=this.islandConstraints[P],this.islandConstraints[P]=M}for(S=z;S--;)this.islandConstraints[S].preSolve(this.timeStep,d);for(var g=this.numIterations;g--;)for(S=z;S--;)this.islandConstraints[S].solve();for(S=z;S--;)this.islandConstraints[S].postSolve(),this.islandConstraints[S]=null;var w=10;for(S=f;S--;)o=this.islandRigidBodies[S],this.callSleep(o)?(o.sleepTime+=this.timeStep,o.sleepTime<w&&(w=o.sleepTime)):(o.sleepTime=0,w=0);if(w>.5)for(S=f;S--;)this.islandRigidBodies[S].sleep(),this.islandRigidBodies[S]=null;else for(S=f;S--;)this.islandRigidBodies[S].updatePosition(this.timeStep),this.islandRigidBodies[S]=null;this.numIslands++}e&&(s=OIMO.now(),this.performance.solvingTime=s-i,s=OIMO.now(),this.performance.upfps(),this.performance.totalTime=s-t)}},OIMO.RigidBody=function(t,i,s,h,e,o,a){this.name=" ",this.MAX_SHAPES=64,this.prev=null,this.next=null,this.type=OIMO.BODY_NULL,this.massInfo=new OIMO.MassInfo,this.position=new OIMO.Vec3(t,i,s),this.orientation=this.rotationAxisToQuad(h||0,e||0,o||0,a||0),this.newPosition=new OIMO.Vec3,this.controlPos=!1,this.newOrientation=new OIMO.Quat,this.newRotation=new OIMO.Vec3,this.currentRotation=new OIMO.Vec3,this.controlRot=!1,this.controlRotInTime=!1,this.linearVelocity=new OIMO.Vec3,this.angularVelocity=new OIMO.Vec3,this.matrix=new OIMO.Mat44,this.parent=null,this.contactLink=null,this.numContacts=0,this.shapes=null,this.numShapes=0,this.jointLink=null,this.numJoints=0,this.sleepPosition=new OIMO.Vec3,this.sleepOrientation=new OIMO.Quat,this.isStatic=!1,this.isDynamic=!1,this.rotation=new OIMO.Mat33,this.mass=NaN,this.inverseMass=NaN,this.inverseInertia=new OIMO.Mat33,this.localInertia=new OIMO.Mat33,this.inverseLocalInertia=new OIMO.Mat33,this.addedToIsland=!1,this.allowSleep=!0,this.sleepTime=0,this.sleeping=!1},OIMO.RigidBody.prototype={constructor:OIMO.RigidBody,addShape:function(t){t.parent&&OIMO.Error("RigidBody","It is not possible that you add to the multi-rigid body the shape of one"),null!=this.shapes&&((this.shapes.prev=t).next=this.shapes),this.shapes=t,t.parent=this,this.parent&&this.parent.addShape(t),this.numShapes++},removeShape:function(t){var i=t;if(i.parent==this){var s=i.prev,h=i.next;null!=s&&(s.next=h),null!=h&&(h.prev=s),this.shapes==i&&(this.shapes=h),i.prev=null,i.next=null,i.parent=null,this.parent&&this.parent.removeShape(i),this.numShapes--}},remove:function(){this.dispose()},dispose:function(){this.parent.removeRigidBody(this)},checkContact:function(t){this.parent.checkContact(this.name,t)},setupMass:function(t,i){var s=void 0===i||i;this.type=t||OIMO.BODY_DYNAMIC,this.isDynamic=this.type==OIMO.BODY_DYNAMIC,this.isStatic=this.type==OIMO.BODY_STATIC,this.mass=0,this.localInertia.set(0,0,0,0,0,0,0,0,0);for(var h=this.localInertia.elements,e=new OIMO.Mat33,o=new OIMO.Vec3,a=this.shapes;null!=a;a=a.next){a.calculateMassInfo(this.massInfo);var n=this.massInfo.mass,r=a.relativePosition.x,l=a.relativePosition.y,c=a.relativePosition.z;o.addScale(a.relativePosition,n),this.mass+=n,this.rotateInertia(a.relativeRotation,this.massInfo.inertia,e),this.localInertia.addEqual(e),h[0]+=n*(l*l+c*c),h[4]+=n*(r*r+c*c),h[8]+=n*(r*r+l*l);var m=n*r*l,p=n*l*c,O=n*c*r;h[1]-=m,h[3]-=m,h[2]-=p,h[6]-=p,h[5]-=O,h[7]-=O}if(this.inverseMass=1/this.mass,o.scaleEqual(this.inverseMass),s){for(this.position.addEqual(o),a=this.shapes;null!=a;a=a.next)a.relativePosition.subEqual(o);r=o.x,l=o.y,c=o.z,h[0]-=this.mass*(l*l+c*c),h[4]-=this.mass*(r*r+c*c),h[8]-=this.mass*(r*r+l*l),m=this.mass*r*l,p=this.mass*l*c,O=this.mass*c*r,h[1]+=m,h[3]+=m,h[2]+=p,h[6]+=p,h[5]+=O,h[7]+=O}this.inverseLocalInertia.invert(this.localInertia),this.type==OIMO.BODY_STATIC&&(this.inverseMass=0,this.inverseLocalInertia.set(0,0,0,0,0,0,0,0,0)),this.syncShapes(),this.awake()},awake:function(){if(this.allowSleep&&this.sleeping){this.sleeping=!1,this.sleepTime=0;for(var t=this.contactLink;null!=t;)t.body.sleepTime=0,t.body.sleeping=!1,t=t.next;for(var i=this.jointLink;null!=i;)i.body.sleepTime=0,i.body.sleeping=!1,i=i.next;for(var s=this.shapes;null!=s;s=s.next)s.updateProxy()}},sleep:function(){if(this.allowSleep&&!this.sleeping){this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.sleepPosition.copy(this.position),this.sleepOrientation.copy(this.orientation),this.sleepTime=0,this.sleeping=!0;for(var t=this.shapes;null!=t;t=t.next)t.updateProxy()}},isLonely:function(){return 0==this.numJoints&&0==this.numContacts},updatePosition:function(t){switch(this.type){case OIMO.BODY_STATIC:this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.controlPos&&(this.position.copy(this.newPosition),this.controlPos=!1),this.controlRot&&(this.orientation.copy(this.newOrientation),this.controlRot=!1);break;case OIMO.BODY_DYNAMIC:this.controlPos&&(this.angularVelocity.set(0,0,0),this.linearVelocity.set(0,0,0),this.linearVelocity.x=(this.newPosition.x-this.position.x)/t,this.linearVelocity.y=(this.newPosition.y-this.position.y)/t,this.linearVelocity.z=(this.newPosition.z-this.position.z)/t,this.controlPos=!1),this.controlRot&&(this.angularVelocity.set(0,0,0),this.orientation.copy(this.newOrientation),this.controlRot=!1),this.position.addTime(this.linearVelocity,t),this.orientation.addTime(this.angularVelocity,t);break;default:OIMO.Error("RigidBody","Invalid type.")}this.syncShapes()},rotateInertia:function(t,i,s){var h=t.elements,e=i.elements,o=h[0],a=h[3],n=h[6],r=h[1],l=h[4],c=h[7],m=h[2],p=h[5],O=h[8],u=e[0],x=e[3],y=e[6],I=e[1],M=e[4],d=e[7],N=e[2],f=e[5],z=e[8],v=o*u+r*x+m*y,b=o*I+r*M+m*d,A=o*N+r*f+m*z,k=a*u+l*x+p*y,S=a*I+l*M+p*d,P=a*N+l*f+p*z,g=n*u+c*x+O*y,w=n*I+c*M+O*d,L=n*N+c*f+O*z,V=s.elements;V[0]=v*o+b*r+A*m,V[1]=v*a+b*l+A*p,V[2]=v*n+b*c+A*O,V[3]=k*o+S*r+P*m,V[4]=k*a+S*l+P*p,V[5]=k*n+S*c+P*O,V[6]=g*o+w*r+L*m,V[7]=g*a+w*l+L*p,V[8]=g*n+w*c+L*O},syncShapes:function(){var t=this.orientation.s,i=this.orientation.x,s=this.orientation.y,h=this.orientation.z,e=2*i,o=2*s,a=2*h,n=i*e,r=s*o,l=h*a,c=i*o,m=s*a,p=i*a,O=t*e,u=t*o,x=t*a,y=this.rotation.elements;y[0]=1-r-l,y[1]=c-x,y[2]=p+u,y[3]=c+x,y[4]=1-n-l,y[5]=m-O,y[6]=p-u,y[7]=m+O,y[8]=1-n-r,this.rotateInertia(this.rotation,this.inverseLocalInertia,this.inverseInertia);for(var I=this.shapes;null!=I;I=I.next)I.position.mul(this.position,I.relativePosition,this.rotation),I.rotation.mul(this.rotation,I.relativeRotation),I.updateProxy()},applyImpulse:function(t,i){this.linearVelocity.addScale(i,this.inverseMass);var s=new OIMO.Vec3;s.sub(t,this.position).cross(s,i).mulMat(this.inverseInertia,s),this.angularVelocity.addEqual(s)},rotationVectToQuad:function(t){var i=OIMO.EulerToAxis(t.x*OIMO.degtorad,t.y*OIMO.degtorad,t.z*OIMO.degtorad);return this.rotationAxisToQuad(i[0],i[1],i[2],i[3])},rotationAxisToQuad:function(t,i,s,h){var e=i*i+s*s+h*h;e>0&&(e=1/OIMO.sqrt(e),i*=e,s*=e,h*=e);var o=OIMO.sin(.5*t),a=OIMO.cos(.5*t);return new OIMO.Quat(a,o*i,o*s,o*h)},setPosition:function(t){this.newPosition.copy(t).multiplyScalar(OIMO.INV_SCALE),this.controlPos=!0},setQuaternion:function(t){this.newOrientation.set(t.x,t.y,t.z,t.w),this.controlRot=!0},setRotation:function(t){this.newOrientation=this.rotationVectToQuad(t),this.controlRot=!0},resetPosition:function(t,i,s){this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.position.set(t,i,s).multiplyScalar(OIMO.INV_SCALE),this.awake()},resetQuaternion:function(t){this.angularVelocity.set(0,0,0),this.orientation=new OIMO.Quat(t.w,t.x,t.y,t.z),this.awake()},resetRotation:function(t,i,s){this.angularVelocity.set(0,0,0),this.orientation=this.rotationVectToQuad(new OIMO.Vec3(t,i,s)),this.awake()},getPosition:function(){return(new OIMO.Vec3).scale(this.position,OIMO.WORLD_SCALE)},getRotation:function(){return(new OIMO.Euler).setFromRotationMatrix(this.rotation)},getQuaternion:function(){return(new OIMO.Quaternion).setFromRotationMatrix(this.rotation)},getMatrix:function(){var t,i,s=this.matrix.elements;return this.sleeping?s[15]=1:(t=this.rotation.elements,s[0]=t[0],s[1]=t[3],s[2]=t[6],s[3]=0,s[4]=t[1],s[5]=t[4],s[6]=t[7],s[7]=0,s[8]=t[2],s[9]=t[5],s[10]=t[8],s[11]=0,i=this.position,s[12]=i.x*OIMO.WORLD_SCALE,s[13]=i.y*OIMO.WORLD_SCALE,s[14]=i.z*OIMO.WORLD_SCALE,s[15]=0),s}},OIMO.Body=function(t){var i=t||{};i.world&&(void 0===i.type&&(i.type="box"),this.name=i.name||"",this.body=i.world.add(i))},OIMO.Body.prototype={constructor:OIMO.Body,setPosition:function(t){this.body.setPosition(t)},setQuaternion:function(t){this.body.setQuaternion(t)},setRotation:function(t){this.body.setRotation(t)},getPosition:function(){return this.body.getPosition()},getRotation:function(){return this.body.getRotation()},getQuaternion:function(){return this.body.getQuaternion()},getMatrix:function(){return this.body.getMatrix()},getSleep:function(){return this.body.sleeping},resetPosition:function(t,i,s){this.body.resetPosition(t,i,s)},resetRotation:function(t,i,s){this.body.resetRotation(t,i,s)},awake:function(){this.body.awake()},remove:function(){this.body.dispose()},checkContact:function(t){this.body.checkContact(t)}},OIMO.Link=function(t){var i=t||{};i.world&&(void 0===i.type&&(i.type="jointHinge"),this.name=i.name||"",this.joint=i.world.add(i))},OIMO.Link.prototype={constructor:OIMO.Link,getPosition:function(){return this.joint.getPosition()},getMatrix:function(){return this.joint.getMatrix()},remove:function(){this.joint.dispose()},awake:function(){this.joint.awake()}},OIMO.Dictionary=function(){this.data={},this.keys=[]},OIMO.Dictionary.prototype={constructor:OIMO.Dictionary,set:function(t){var i=t.id;this.get[i]||this.keys.push(i),this.data[i]=t},get:function(t){return this.data[t]},del:function(t){var i=this.keys,s=i.indexOf(t.id);s>-1&&(delete this.data[i[s]],i.splice(s,1))},reset:function(){for(var t,i=this.data,s=this.keys;s.length>0;)t=s.pop(),delete i[t]}},OIMO.Performance=function(t){this.parent=t,this.infos=new OIMO_ARRAY_TYPE(13),this.f=[0,0,0],this.types=["None","BruteForce","Sweep & Prune","Bounding Volume Tree"],this.broadPhase=this.types[this.parent.broadPhase.types],this.version=OIMO.REVISION,this.fps=0,this.broadPhaseTime=0,this.narrowPhaseTime=0,this.solvingTime=0,this.totalTime=0},OIMO.Performance.prototype={upfps:function(){this.f[1]=Date.now(),this.f[1]-1e3>this.f[0]&&(this.f[0]=this.f[1],this.fps=this.f[2],this.f[2]=0),this.f[2]++},updatingTime:function(){return OIMO.fix(this.totalTime-(this.broadPhaseTime+this.narrowPhaseTime+this.solvingTime))},show:function(){var t=["Oimo.js "+this.version+"<br>",this.broadPhase+"<br><br>","FPS: "+this.fps+" fps<br><br>","rigidbody "+this.parent.numRigidBodies+"<br>","contact &nbsp;&nbsp;"+this.parent.numContacts+"<br>","ct-point &nbsp;"+this.parent.numContactPoints+"<br>","paircheck "+this.parent.broadPhase.numPairChecks+"<br>","island &nbsp;&nbsp;&nbsp;"+this.parent.numIslands+"<br><br>","Time in milliseconde<br><br>","broad-phase &nbsp;"+OIMO.fix(this.broadPhaseTime)+"<br>","narrow-phase "+OIMO.fix(this.narrowPhaseTime)+"<br>","solving &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+OIMO.fix(this.solvingTime)+"<br>","total &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+OIMO.fix(this.totalTime)+"<br>","updating &nbsp;&nbsp;&nbsp;&nbsp;"+this.updatingTime()+"<br>"].join("\n");return t},toArray:function(){return this.infos[0]=this.parent.broadPhase.types,this.infos[1]=this.parent.numRigidBodies,this.infos[2]=this.parent.numContacts,this.infos[3]=this.parent.broadPhase.numPairChecks,this.infos[4]=this.parent.numContactPoints,this.infos[5]=this.parent.numIslands,this.infos[6]=this.broadPhaseTime,this.infos[7]=this.narrowPhaseTime,this.infos[8]=this.solvingTime,this.infos[9]=this.updatingTime(),this.infos[10]=this.totalTime,this.infos[11]=this.fps,this.infos}},OIMO.Mat44=function(t,i,s,h,e,o,a,n,r,l,c,m,p,O,u,x){this.elements=new OIMO_ARRAY_TYPE(16);var y=this.elements;y[0]=void 0!==t?t:1,y[4]=i||0,y[8]=s||0,y[12]=h||0,y[1]=e||0,y[5]=void 0!==o?o:1,y[9]=a||0,y[13]=n||0,y[2]=r||0,y[6]=l||0,y[10]=void 0!==c?c:1,y[14]=m||0,y[3]=p||0,y[7]=O||0,y[11]=u||0,y[15]=void 0!==x?x:1},OIMO.Mat44.prototype={constructor:OIMO.Mat44,set:function(t,i,s,h,e,o,a,n,r,l,c,m,p,O,u,x){var y=this.elements;return y[0]=t,y[4]=i,y[8]=s,y[12]=h,y[1]=e,y[5]=o,y[9]=a,y[13]=n,y[2]=r,y[6]=l,y[10]=c,y[14]=m,y[3]=p,y[7]=O,y[11]=u,y[15]=x,this}},OIMO.Mat33=function(t,i,s,h,e,o,a,n,r){this.elements=new OIMO_ARRAY_TYPE(9);this.elements;this.init(void 0!==t?t:1,i||0,s||0,h||0,void 0!==e?e:1,o||0,a||0,n||0,void 0!==r?r:1)},OIMO.Mat33.prototype={constructor:OIMO.Mat33,set:function(t,i,s,h,e,o,a,n,r){var l=this.elements;return l[0]=t,l[1]=i,l[2]=s,l[3]=h,l[4]=e,l[5]=o,l[6]=a,l[7]=n,l[8]=r,this},init:function(t,i,s,h,e,o,a,n,r){var l=this.elements;return l[0]=t,l[1]=i,l[2]=s,l[3]=h,l[4]=e,l[5]=o,l[6]=a,l[7]=n,l[8]=r,this},multiply:function(t){var i=this.elements;return i[0]*=t,i[1]*=t,i[2]*=t,i[3]*=t,i[4]*=t,i[5]*=t,i[6]*=t,i[7]*=t,i[8]*=t,this},add:function(t,i){var s=this.elements,h=t.elements,e=i.elements;return s[0]=h[0]+e[0],s[1]=h[1]+e[1],s[2]=h[2]+e[2],s[3]=h[3]+e[3],s[4]=h[4]+e[4],s[5]=h[5]+e[5],s[6]=h[6]+e[6],s[7]=h[7]+e[7],s[8]=h[8]+e[8],this},addEqual:function(t){var i=this.elements,s=t.elements;return i[0]+=s[0],i[1]+=s[1],i[2]+=s[2],i[3]+=s[3],i[4]+=s[4],i[5]+=s[5],i[6]+=s[6],i[7]+=s[7],i[8]+=s[8],this},sub:function(t,i){var s=this.elements,h=t.elements,e=i.elements;return s[0]=h[0]-e[0],s[1]=h[1]-e[1],s[2]=h[2]-e[2],s[3]=h[3]-e[3],s[4]=h[4]-e[4],s[5]=h[5]-e[5],s[6]=h[6]-e[6],s[7]=h[7]-e[7],s[8]=h[8]-e[8],this},subEqual:function(t){var i=this.elements,s=t.elements;return i[0]-=s[0],i[1]-=s[1],i[2]-=s[2],i[3]-=s[3],i[4]-=s[4],i[5]-=s[5],i[6]-=s[6],i[7]-=s[7],i[8]-=s[8],this},scale:function(t,i){var s=this.elements,h=t.elements;return s[0]=h[0]*i,s[1]=h[1]*i,s[2]=h[2]*i,s[3]=h[3]*i,s[4]=h[4]*i,s[5]=h[5]*i,s[6]=h[6]*i,s[7]=h[7]*i,s[8]=h[8]*i,this},scaleEqual:function(t){var i=this.elements;return i[0]*=t,i[1]*=t,i[2]*=t,i[3]*=t,i[4]*=t,i[5]*=t,i[6]*=t,i[7]*=t,i[8]*=t,this},mul:function(t,i){var s=this.elements,h=t.elements,e=i.elements,o=h[0],a=h[3],n=h[6],r=h[1],l=h[4],c=h[7],m=h[2],p=h[5],O=h[8],u=e[0],x=e[3],y=e[6],I=e[1],M=e[4],d=e[7],N=e[2],f=e[5],z=e[8];return s[0]=o*u+r*x+m*y,s[1]=o*I+r*M+m*d,s[2]=o*N+r*f+m*z,s[3]=a*u+l*x+p*y,s[4]=a*I+l*M+p*d,s[5]=a*N+l*f+p*z,s[6]=n*u+c*x+O*y,s[7]=n*I+c*M+O*d,s[8]=n*N+c*f+O*z,this},mulScale:function(t,i,s,h,e){var o=e||!1,a=this.elements,n=t.elements;return o?(a[0]=i*n[0],a[1]=i*n[1],a[2]=i*n[2],a[3]=s*n[3],a[4]=s*n[4],a[5]=s*n[5],a[6]=h*n[6],a[7]=h*n[7],a[8]=h*n[8]):(a[0]=n[0]*i,a[1]=n[1]*s,a[2]=n[2]*h,a[3]=n[3]*i,a[4]=n[4]*s,a[5]=n[5]*h,a[6]=n[6]*i,a[7]=n[7]*s,a[8]=n[8]*h),this},mulRotate:function(t,i,s,h,e,o){var a=o||!1,n=OIMO.sin(i),r=OIMO.cos(i),l=1-r,c=s*s*l+r,m=s*h*l-e*n,p=s*e*l+h*n,O=h*s*l+e*n,u=h*h*l+r,x=h*e*l-s*n,y=e*s*l-h*n,I=e*h*l+s*n,M=e*e*l+r,d=t.elements,N=d[0],f=d[3],z=d[6],v=d[1],b=d[4],A=d[7],k=d[2],S=d[5],P=d[8],g=this.elements;return a?(g[0]=c*N+m*f+p*z,g[1]=c*v+m*b+p*A,g[2]=c*k+m*S+p*P,g[3]=O*N+u*f+x*z,g[4]=O*v+u*b+x*A,g[5]=O*k+u*S+x*P,g[6]=y*N+I*f+M*z,g[7]=y*v+I*b+M*A,g[8]=y*k+I*S+M*P):(g[0]=N*c+v*O+k*y,g[1]=N*m+v*u+k*I,g[2]=N*p+v*x+k*M,g[3]=f*c+b*O+S*y,g[4]=f*m+b*u+S*I,g[5]=f*p+b*x+S*M,g[6]=z*c+A*O+P*y,g[7]=z*m+A*u+P*I,g[8]=z*p+A*x+P*M),this},transpose:function(t){var i=this.elements,s=t.elements;return i[0]=s[0],i[1]=s[3],i[2]=s[6],i[3]=s[1],i[4]=s[4],i[5]=s[7],i[6]=s[2],i[7]=s[5],i[8]=s[8],this},setQuat:function(t){var i=this.elements,s=2*t.x,h=2*t.y,e=2*t.z,o=t.x*s,a=t.y*h,n=t.z*e,r=t.x*h,l=t.y*e,c=t.x*e,m=t.s*s,p=t.s*h,O=t.s*e;return i[0]=1-a-n,i[1]=r-O,i[2]=c+p,i[3]=r+O,i[4]=1-o-n,i[5]=l-m,i[6]=c-p,i[7]=l+m,i[8]=1-o-a,this},invert:function(t){var i=this.elements,s=t.elements,h=s[0],e=s[3],o=s[6],a=s[1],n=s[4],r=s[7],l=s[2],c=s[5],m=s[8],p=n*m-r*c,O=r*l-a*m,u=a*c-n*l,x=h*p+e*O+o*u;return 0!=x&&(x=1/x),i[0]=x*p,i[1]=x*O,i[2]=x*u,i[3]=x*(c*o-e*m),i[4]=x*(h*m-l*o),i[5]=x*(l*e-h*c),i[6]=x*(e*r-n*o),i[7]=x*(a*o-h*r),i[8]=x*(h*n-a*e),this},toEuler:function(){function t(t){return OIMO.min(OIMO.max(t,-1),1)}var i=this.elements,s=i[0],h=i[3],e=i[6],o=(i[1],i[4]),a=i[7],n=(i[2],i[5]),r=i[8],l=new OIMO.Vec3;new OIMO.Quat;return l.y=OIMO.asin(t(e)),OIMO.abs(e)<.99999?(l.x=OIMO.atan2(-a,r),l.z=OIMO.atan2(-h,s)):(l.x=OIMO.atan2(n,o),l.z=0),l},toString:function(){var t=this.elements,i="Mat33|"+t[0].toFixed(4)+", "+t[1].toFixed(4)+", "+t[2].toFixed(4)+"|\n     |"+t[3].toFixed(4)+", "+t[4].toFixed(4)+", "+t[5].toFixed(4)+"|\n     |"+t[6].toFixed(4)+", "+t[7].toFixed(4)+", "+t[8].toFixed(4)+"|";return i},multiplyScalar:function(t){var i=this.elements;return i[0]*=t,i[3]*=t,i[6]*=t,i[1]*=t,i[4]*=t,i[7]*=t,i[2]*=t,i[5]*=t,i[8]*=t,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(t){var i=t.elements;return this.set(i[0],i[3],i[6],i[1],i[4],i[7],i[2],i[5],i[8]),this},fromArray:function(t){return this.elements.set(t),this},toArray:function(){var t=this.elements;return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]}},OIMO.Quat=function(t,i,s,h){this.s=void 0!==t?t:1,this.x=i||0,this.y=s||0,this.z=h||0},OIMO.Quat.prototype={constructor:OIMO.Quat,set:function(t,i,s,h){return this.x=t,this.y=i,this.z=s,this.s=h,this},init:function(t,i,s,h){return this.s=void 0!==t?t:1,this.x=i||0,this.y=s||0,this.z=h||0,this},add:function(t,i){return this.s=t.s+i.s,this.x=t.x+i.x,this.y=t.y+i.y,this.z=t.z+i.z,this},addTime:function(t,i){var s=t.x,h=t.y,e=t.z,o=this.s,a=this.x,n=this.y,r=this.z;i*=.5;var l=(-s*a-h*n-e*r)*i,c=(s*o+h*r-e*n)*i,m=(-s*r+h*o+e*a)*i,p=(s*n-h*a+e*o)*i;o+=l,a+=c,n+=m,r+=p;var O=1/OIMO.sqrt(o*o+a*a+n*n+r*r);return this.s=o*O,this.x=a*O,this.y=n*O,this.z=r*O,this},sub:function(t,i){return this.s=t.s-i.s,this.x=t.x-i.x,this.y=t.y-i.y,this.z=t.z-i.z,this},scale:function(t,i){return this.s=t.s*i,this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this},mul:function(t,i){var s=t.x,h=t.y,e=t.z,o=t.s,a=i.x,n=i.y,r=i.z,l=i.s;return this.x=s*l+o*a+h*r-e*n,this.y=h*l+o*n+e*a-s*r,this.z=e*l+o*r+s*n-h*a,this.s=o*l-s*a-h*n-e*r,this},arc:function(t,i){var s=t.x,h=t.y,e=t.z,o=i.x,a=i.y,n=i.z,r=s*o+h*a+e*n;if(r==-1)return o=h*s-e*e,a=-e*h-s*s,n=s*e+h*h,r=1/OIMO.sqrt(o*o+a*a+n*n),this.s=0,this.x=o*r,this.y=a*r,this.z=n*r,this;var l=h*n-e*a,c=e*o-s*n,m=s*a-h*o;return this.s=OIMO.sqrt(.5*(1+r)),r=.5/this.s,this.x=l*r,this.y=c*r,this.z=m*r,this},normalize:function(t){var i=OIMO.sqrt(t.s*t.s+t.x*t.x+t.y*t.y+t.z*t.z);return i>0&&(i=1/i),this.s=t.s*i,this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this},invert:function(t){return this.s=t.s,this.x=-t.x,this.y=-t.y,this.z=-t.z,this},length:function(){return OIMO.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(t){return this.s=t.s,this.x=t.x,this.y=t.y,this.z=t.z,this},testDiff:function(t){return this.s!==t.s||this.x!==t.x||this.y!==t.y||this.z!==t.z},clone:function(t){return new OIMO.Quat(this.s,this.x,this.y,this.z)},toString:function(){return"Quat["+this.s.toFixed(4)+", ("+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+")]"}},OIMO.Quaternion=function(t,i,s,h){this.x=t||0,this.y=i||0,this.z=s||0,this.w=void 0!==h?h:1},OIMO.Quaternion.prototype={constructor:OIMO.Quaternion,setFromRotationMatrix:function(t){var i,s=t.elements,h=s[0],e=s[1],o=s[2],a=s[3],n=s[4],r=s[5],l=s[6],c=s[7],m=s[8],p=h+n+m;return p>0?(i=.5/OIMO.sqrt(p+1),this.w=.25/i,this.x=(c-r)*i,this.y=(o-l)*i,this.z=(a-e)*i):h>n&&h>m?(i=2*OIMO.sqrt(1+h-n-m),this.w=(c-r)/i,this.x=.25*i,this.y=(e+a)/i,this.z=(o+l)/i):n>m?(i=2*OIMO.sqrt(1+n-h-m),this.w=(o-l)/i,this.x=(e+a)/i,this.y=.25*i,this.z=(r+c)/i):(i=2*OIMO.sqrt(1+m-h-n),this.w=(a-e)/i,this.x=(o+l)/i,this.y=(r+c)/i,this.z=.25*i),this}},OIMO.Vec3=function(t,i,s){this.x=t||0,this.y=i||0,this.z=s||0},OIMO.Vec3.prototype={constructor:OIMO.Vec3,init:function(t,i,s){return this.x=t||0,this.y=i||0,this.z=s||0,this},set:function(t,i,s){return this.x=t,this.y=i,this.z=s,this},add:function(t,i){return this.x=t.x+i.x,this.y=t.y+i.y,this.z=t.z+i.z,this},addEqual:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},addTime:function(t,i){return this.x+=t.x*i,this.y+=t.y*i,this.z+=t.z*i,this},sub:function(t,i){return this.x=t.x-i.x,this.y=t.y-i.y,this.z=t.z-i.z,this},subEqual:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},addScale:function(t,i){return this.x+=t.x*i,this.y+=t.y*i,this.z+=t.z*i,this},scale:function(t,i){return this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this},scaleEqual:function(t){return this.x*=t,this.y*=t,this.z*=t,this},cross:function(t,i){var s=t.x,h=t.y,e=t.z,o=i.x,a=i.y,n=i.z;return this.x=h*n-e*a,this.y=e*o-s*n,this.z=s*a-h*o,this},mul:function(t,i,s){var h=s.elements;return this.x=t.x+i.x*h[0]+i.y*h[1]+i.z*h[2],this.y=t.y+i.x*h[3]+i.y*h[4]+i.z*h[5],this.z=t.z+i.x*h[6]+i.y*h[7]+i.z*h[8],this},mulMat:function(t,i){var s=t.elements;return this.x=s[0]*i.x+s[1]*i.y+s[2]*i.z,this.y=s[3]*i.x+s[4]*i.y+s[5]*i.z,this.z=s[6]*i.x+s[7]*i.y+s[8]*i.z,this},normalize:function(t){var i=t.x,s=t.y,h=t.z,e=i*i+s*s+h*h;return e>0&&(e=1/OIMO.sqrt(e),this.x=i*e,this.y=s*e,this.z=h*e),this},invert:function(t){return this.x=-t.x,this.y=-t.y,this.z=-t.z,this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return OIMO.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},applyQuaternion:function(t){var i=this.x,s=this.y,h=this.z,e=t.x,o=t.y,a=t.z,n=t.s,r=n*i+o*h-a*s,l=n*s+a*i-e*h,c=n*h+e*s-o*i,m=-e*i-o*s-a*h;return this.x=r*n+m*-e+l*-a-c*-o,this.y=l*n+m*-o+c*-e-r*-a,this.z=c*n+m*-a+r*-o-l*-e,this},testZero:function(){return 0!==this.x||0!==this.y||0!==this.z},testDiff:function(t){return t.x!==this.x||t.y!==this.y||t.z!==this.z},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},clone:function(){return new this.constructor(this.x,this.y,this.z)},toString:function(){return"Vec3["+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+"]"},multiplyScalar:function(t){return isFinite(t)?(this.x*=t,this.y*=t,this.z*=t):(this.x=0,this.y=0,this.z=0),this},divideScalar:function(t){return this.multiplyScalar(1/t)},norm:function(){return this.divideScalar(this.length())}},OIMO.Euler=function(t,i,s,h){this._x=t||0,this._y=i||0,this._z=s||0,this._order=h||OIMO.Euler.DefaultOrder},OIMO.Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],OIMO.Euler.DefaultOrder="XYZ",OIMO.clamp=function(t,i,s){return t<i?i:t>s?s:t},OIMO.Euler.prototype={constructor:OIMO.Euler,_x:0,_y:0,_z:0,_order:OIMO.Euler.DefaultOrder,get x(){return this._x},set x(t){this._x=t,this.onChangeCallback()},get y(){return this._y},set y(t){this._y=t,this.onChangeCallback()},get z(){return this._z},set z(t){this._z=t,this.onChangeCallback()},get order(){return this._order},set order(t){this._order=t,this.onChangeCallback()},set:function(t,i,s,h){return this._x=t,this._y=i,this._z=s,this._order=h||this._order,this.onChangeCallback(),this},copy:function(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this.onChangeCallback(),
this},setFromRotationMatrix:function(t,i){var s=OIMO.clamp,h=t.elements,e=h[0],o=h[1],a=h[2],n=h[3],r=h[4],l=h[5],c=h[6],m=h[7],p=h[8];return i=i||this._order,"XYZ"===i?(this._y=OIMO.asin(s(a,-1,1)),OIMO.abs(a)<.99999?(this._x=OIMO.atan2(-l,p),this._z=OIMO.atan2(-o,e)):(this._x=OIMO.atan2(m,r),this._z=0)):"YXZ"===i?(this._x=OIMO.asin(-s(l,-1,1)),OIMO.abs(l)<.99999?(this._y=OIMO.atan2(a,p),this._z=OIMO.atan2(n,r)):(this._y=OIMO.atan2(-c,e),this._z=0)):"ZXY"===i?(this._x=OIMO.asin(s(m,-1,1)),OIMO.abs(m)<.99999?(this._y=OIMO.atan2(-c,p),this._z=OIMO.atan2(-o,r)):(this._y=0,this._z=OIMO.atan2(n,e))):"ZYX"===i?(this._y=OIMO.asin(-s(c,-1,1)),OIMO.abs(c)<.99999?(this._x=OIMO.atan2(m,p),this._z=OIMO.atan2(n,e)):(this._x=0,this._z=OIMO.atan2(-o,r))):"YZX"===i?(this._z=OIMO.asin(s(n,-1,1)),OIMO.abs(n)<.99999?(this._x=OIMO.atan2(-l,r),this._y=OIMO.atan2(-c,e)):(this._x=0,this._y=OIMO.atan2(a,p))):"XZY"===i?(this._z=OIMO.asin(-s(o,-1,1)),OIMO.abs(o)<.99999?(this._x=OIMO.atan2(m,r),this._y=OIMO.atan2(a,e)):(this._x=OIMO.atan2(-l,p),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+i),this._order=i,this.onChangeCallback(),this},setFromQuaternion:function(t,i,s){var h=OIMO.clamp,e=t.x*t.x,o=t.y*t.y,a=t.z*t.z,n=t.s*t.s;return i=i||this._order,"XYZ"===i?(this._x=OIMO.atan2(2*(t.x*t.s-t.y*t.z),n-e-o+a),this._y=OIMO.asin(h(2*(t.x*t.z+t.y*t.s),-1,1)),this._z=OIMO.atan2(2*(t.z*t.s-t.x*t.y),n+e-o-a)):"YXZ"===i?(this._x=OIMO.asin(h(2*(t.x*t.s-t.y*t.z),-1,1)),this._y=OIMO.atan2(2*(t.x*t.z+t.y*t.s),n-e-o+a),this._z=OIMO.atan2(2*(t.x*t.y+t.z*t.s),n-e+o-a)):"ZXY"===i?(this._x=OIMO.asin(h(2*(t.x*t.s+t.y*t.z),-1,1)),this._y=OIMO.atan2(2*(t.y*t.s-t.z*t.x),n-e-o+a),this._z=OIMO.atan2(2*(t.z*t.s-t.x*t.y),n-e+o-a)):"ZYX"===i?(this._x=OIMO.atan2(2*(t.x*t.s+t.z*t.y),n-e-o+a),this._y=OIMO.asin(h(2*(t.y*t.s-t.x*t.z),-1,1)),this._z=OIMO.atan2(2*(t.x*t.y+t.z*t.s),n+e-o-a)):"YZX"===i?(this._x=OIMO.atan2(2*(t.x*t.s-t.z*t.y),n-e+o-a),this._y=OIMO.atan2(2*(t.y*t.s-t.x*t.z),n+e-o-a),this._z=OIMO.asin(h(2*(t.x*t.y+t.z*t.s),-1,1))):"XZY"===i?(this._x=OIMO.atan2(2*(t.x*t.s+t.y*t.z),n-e+o-a),this._y=OIMO.atan2(2*(t.x*t.z+t.y*t.s),n+e-o-a),this._z=OIMO.asin(h(2*(t.z*t.s-t.x*t.y),-1,1))):console.warn("OIMO.Euler: .setFromQuaternion() given unsupported order: "+i),this._order=i,s!==!1&&this.onChangeCallback(),this},reorder:function(){var t=new OIMO.Quat;return function(i){t.setFromEuler(this),this.setFromQuaternion(t,i)}}(),equals:function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order},fromArray:function(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this.onChangeCallback(),this},toArray:function(){return[this._x,this._y,this._z,this._order]},onChange:function(t){return this.onChangeCallback=t,this},onChangeCallback:function(){},clone:function(){return new OIMO.Euler(this._x,this._y,this._z,this._order)}},OIMO.EulerToAxis=function(t,i,s){var h=OIMO.cos(.5*i),e=OIMO.sin(.5*i),o=OIMO.cos(.5*s),a=OIMO.sin(.5*s),n=OIMO.cos(.5*t),r=OIMO.sin(.5*t),l=h*o,c=e*a,m=l*n-c*r,p=l*r+c*n,O=e*o*n+h*a*r,u=h*a*n-e*o*r,x=2*OIMO.acos(m),y=p*p+O*O+u*u;return y<.001?(p=1,O=u=0):(y=OIMO.sqrt(y),p/=y,O/=y,u/=y),[x,p,O,u]},OIMO.EulerToMatrix=function(t,i,s){var h=OIMO.cos(i),e=OIMO.sin(i),o=OIMO.cos(s),a=OIMO.sin(s),n=OIMO.cos(t),r=OIMO.sin(t),l=new OIMO.Mat33,c=l.elements;return c[0]=h*o,c[1]=e*r-h*a*n,c[2]=h*a*r+e*n,c[3]=a,c[4]=o*n,c[5]=-o*r,c[6]=-e*o,c[7]=e*a*n+h*r,c[8]=-e*a*r+h*n,l},OIMO.MatrixToEuler=function(t){var i,s,h,e=t.elements;return e[3]>.998?(s=OIMO.atan2(e[2],e[8]),h=OIMO.PI/2,i=0):e[3]<-.998?(s=OIMO.atan2(e[2],e[8]),h=-OIMO.PI/2,i=0):(s=OIMO.atan2(-e[6],e[0]),i=OIMO.atan2(-e[5],e[4]),h=OIMO.asin(e[3])),[i,s,h]},OIMO.unwrapDegrees=function(t){return t%=360,t>180&&(t-=360),t<-180&&(t+=360),t},OIMO.unwrapRadian=function(t){return t%=OIMO.TwoPI,t>OIMO.PI&&(t-=OIMO.TwoPI),t<-OIMO.PI&&(t+=OIMO.TwoPI),t},OIMO.Distance3d=function(t,i){var s=i[0]-t[0],h=i[1]-t[1],e=i[2]-t[2];return OIMO.sqrt(s*s+h*h+e*e)},OIMO.Constraint=function(){this.parent=null,this.body1=null,this.body2=null,this.addedToIsland=!1},OIMO.Constraint.prototype={constructor:OIMO.Constraint,preSolve:function(t,i){OIMO.Error("Constraint","Inheritance error.")},solve:function(){OIMO.Error("Constraint","Inheritance error.")},postSolve:function(){OIMO.Error("Constraint","Inheritance error.")}},OIMO.Joint=function(t){OIMO.Constraint.call(this),this.name="",this.type=OIMO.JOINT_NULL,this.prev=null,this.next=null,this.body1=t.body1,this.body2=t.body2,this.localAnchorPoint1=(new OIMO.Vec3).copy(t.localAnchorPoint1),this.localAnchorPoint2=(new OIMO.Vec3).copy(t.localAnchorPoint2),this.relativeAnchorPoint1=new OIMO.Vec3,this.relativeAnchorPoint2=new OIMO.Vec3,this.anchorPoint1=new OIMO.Vec3,this.anchorPoint2=new OIMO.Vec3,this.allowCollision=t.allowCollision,this.b1Link=new OIMO.JointLink(this),this.b2Link=new OIMO.JointLink(this),this.matrix=new OIMO.Mat44},OIMO.Joint.prototype=Object.create(OIMO.Constraint.prototype),OIMO.Joint.prototype.constructor=OIMO.Joint,OIMO.Joint.prototype.updateAnchorPoints=function(){this.relativeAnchorPoint1.mulMat(this.body1.rotation,this.localAnchorPoint1),this.relativeAnchorPoint2.mulMat(this.body2.rotation,this.localAnchorPoint2),this.anchorPoint1.add(this.relativeAnchorPoint1,this.body1.position),this.anchorPoint2.add(this.relativeAnchorPoint2,this.body2.position)},OIMO.Joint.prototype.attach=function(){this.b1Link.body=this.body2,this.b2Link.body=this.body1,null!=this.body1.jointLink?(this.b1Link.next=this.body1.jointLink).prev=this.b1Link:this.b1Link.next=null,this.body1.jointLink=this.b1Link,this.body1.numJoints++,null!=this.body2.jointLink?(this.b2Link.next=this.body2.jointLink).prev=this.b2Link:this.b2Link.next=null,this.body2.jointLink=this.b2Link,this.body2.numJoints++},OIMO.Joint.prototype.detach=function(){var t=this.b1Link.prev,i=this.b1Link.next;null!=t&&(t.next=i),null!=i&&(i.prev=t),this.body1.jointLink==this.b1Link&&(this.body1.jointLink=i),this.b1Link.prev=null,this.b1Link.next=null,this.b1Link.body=null,this.body1.numJoints--,t=this.b2Link.prev,i=this.b2Link.next,null!=t&&(t.next=i),null!=i&&(i.prev=t),this.body2.jointLink==this.b2Link&&(this.body2.jointLink=i),this.b2Link.prev=null,this.b2Link.next=null,this.b2Link.body=null,this.body2.numJoints--,this.b1Link.body=null,this.b2Link.body=null},OIMO.Joint.prototype.awake=function(){this.body1.awake(),this.body2.awake()},OIMO.Joint.prototype.preSolve=function(t,i){},OIMO.Joint.prototype.solve=function(){},OIMO.Joint.prototype.postSolve=function(){},OIMO.Joint.prototype.remove=function(){this.dispose()},OIMO.Joint.prototype.dispose=function(){this.parent.removeJoint(this)},OIMO.Joint.prototype.getPosition=function(){var t=(new OIMO.Vec3).scale(this.anchorPoint1,OIMO.WORLD_SCALE),i=(new OIMO.Vec3).scale(this.anchorPoint2,OIMO.WORLD_SCALE);return[t,i]},OIMO.Joint.prototype.getMatrix=function(){var t=this.matrix.elements,i=this.anchorPoint1,s=this.anchorPoint2;return t[0]=i.x*OIMO.WORLD_SCALE,t[1]=i.y*OIMO.WORLD_SCALE,t[2]=i.z*OIMO.WORLD_SCALE,t[3]=0,t[4]=s.x*OIMO.WORLD_SCALE,t[5]=s.y*OIMO.WORLD_SCALE,t[6]=s.z*OIMO.WORLD_SCALE,t[7]=0,t},OIMO.JointConfig=function(){this.body1=null,this.body2=null,this.localAnchorPoint1=new OIMO.Vec3,this.localAnchorPoint2=new OIMO.Vec3,this.localAxis1=new OIMO.Vec3,this.localAxis2=new OIMO.Vec3,this.allowCollision=!1},OIMO.JointLink=function(t){this.prev=null,this.next=null,this.body=null,this.joint=t},OIMO.LimitMotor=function(t,i){i=i||!1,this.axis=t,this.angle=0,this.lowerLimit=i?0:1,this.upperLimit=0,this.motorSpeed=0,this.maxMotorForce=0,this.frequency=0,this.dampingRatio=0},OIMO.LimitMotor.prototype={constructor:OIMO.LimitMotor,setLimit:function(t,i){this.lowerLimit=t,this.upperLimit=i},setMotor:function(t,i){this.motorSpeed=t,this.maxMotorForce=i},setSpring:function(t,i){this.frequency=t,this.dampingRatio=i}},OIMO.BallAndSocketJoint=function(t){OIMO.Joint.call(this,t),this.type=OIMO.JOINT_BALL_AND_SOCKET,this.lc=new OIMO.LinearConstraint(this)},OIMO.BallAndSocketJoint.prototype=Object.create(OIMO.Joint.prototype),OIMO.BallAndSocketJoint.prototype.constructor=OIMO.BallAndSocketJoint,OIMO.BallAndSocketJoint.prototype.preSolve=function(t,i){this.updateAnchorPoints(),this.lc.preSolve(t,i)},OIMO.BallAndSocketJoint.prototype.solve=function(){this.lc.solve()},OIMO.BallAndSocketJoint.prototype.postSolve=function(){},OIMO.DistanceJoint=function(t,i,s){OIMO.Joint.call(this,t),this.type=OIMO.JOINT_DISTANCE,this.normal=new OIMO.Vec3,this.nr=new OIMO.Vec3,this.limitMotor=new OIMO.LimitMotor(this.normal,(!0)),this.limitMotor.lowerLimit=i,this.limitMotor.upperLimit=s,this.t=new OIMO.TranslationalConstraint(this,this.limitMotor)},OIMO.DistanceJoint.prototype=Object.create(OIMO.Joint.prototype),OIMO.DistanceJoint.prototype.constructor=OIMO.DistanceJoint,OIMO.DistanceJoint.prototype.preSolve=function(t,i){this.updateAnchorPoints(),this.nr.sub(this.anchorPoint2,this.anchorPoint1),this.normal.normalize(this.nr),this.t.preSolve(t,i)},OIMO.DistanceJoint.prototype.solve=function(){this.t.solve()},OIMO.DistanceJoint.prototype.postSolve=function(){},OIMO.HingeJoint=function(t,i,s){OIMO.Joint.call(this,t),this.type=OIMO.JOINT_HINGE,this.localAxis1=t.localAxis1.clone().norm(),this.localAxis2=t.localAxis2.clone().norm(),this.localAngle1=new OIMO.Vec3(this.localAxis1.y*this.localAxis1.x-this.localAxis1.z*this.localAxis1.z,-this.localAxis1.z*this.localAxis1.y-this.localAxis1.x*this.localAxis1.x,this.localAxis1.x*this.localAxis1.z+this.localAxis1.y*this.localAxis1.y).norm();var h=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2));this.localAngle2=(new OIMO.Vec3).mulMat(h,this.localAngle1),this.nor=new OIMO.Vec3,this.tan=new OIMO.Vec3,this.bin=new OIMO.Vec3,this.ax1=new OIMO.Vec3,this.ax2=new OIMO.Vec3,this.an1=new OIMO.Vec3,this.an2=new OIMO.Vec3,this.limitMotor=new OIMO.LimitMotor(this.nor,(!1)),this.limitMotor.lowerLimit=i,this.limitMotor.upperLimit=s,this.lc=new OIMO.LinearConstraint(this),this.r3=new OIMO.Rotational3Constraint(this,this.limitMotor,new OIMO.LimitMotor(this.tan,(!0)),new OIMO.LimitMotor(this.bin,(!0)))},OIMO.HingeJoint.prototype=Object.create(OIMO.Joint.prototype),OIMO.HingeJoint.prototype.constructor=OIMO.HingeJoint,OIMO.HingeJoint.prototype.preSolve=function(t,i){var s,h,e,o;this.updateAnchorPoints(),this.ax1.mulMat(this.body1.rotation,this.localAxis1),this.ax2.mulMat(this.body2.rotation,this.localAxis2),this.an1.mulMat(this.body1.rotation,this.localAngle1),this.an2.mulMat(this.body2.rotation,this.localAngle2),this.nor.set(this.ax1.x*this.body2.inverseMass+this.ax2.x*this.body1.inverseMass,this.ax1.y*this.body2.inverseMass+this.ax2.y*this.body1.inverseMass,this.ax1.z*this.body2.inverseMass+this.ax2.z*this.body1.inverseMass).norm(),this.tan.set(this.nor.y*this.nor.x-this.nor.z*this.nor.z,-this.nor.z*this.nor.y-this.nor.x*this.nor.x,this.nor.x*this.nor.z+this.nor.y*this.nor.y).norm(),this.bin.set(this.nor.y*this.tan.z-this.nor.z*this.tan.y,this.nor.z*this.tan.x-this.nor.x*this.tan.z,this.nor.x*this.tan.y-this.nor.y*this.tan.x),o=this.acosClamp(this.an1.x*this.an2.x+this.an1.y*this.an2.y+this.an1.z*this.an2.z),this.nor.x*(this.an1.y*this.an2.z-this.an1.z*this.an2.y)+this.nor.y*(this.an1.z*this.an2.x-this.an1.x*this.an2.z)+this.nor.z*(this.an1.x*this.an2.y-this.an1.y*this.an2.x)<0?this.limitMotor.angle=-o:this.limitMotor.angle=o,s=this.ax1.y*this.ax2.z-this.ax1.z*this.ax2.y,h=this.ax1.z*this.ax2.x-this.ax1.x*this.ax2.z,e=this.ax1.x*this.ax2.y-this.ax1.y*this.ax2.x,this.r3.limitMotor2.angle=this.tan.x*s+this.tan.y*h+this.tan.z*e,this.r3.limitMotor3.angle=this.bin.x*s+this.bin.y*h+this.bin.z*e,this.r3.preSolve(t,i),this.lc.preSolve(t,i)},OIMO.HingeJoint.prototype.solve=function(){this.r3.solve(),this.lc.solve()},OIMO.HingeJoint.prototype.postSolve=function(){},OIMO.HingeJoint.prototype.acosClamp=function(t){return t>1?0:t<-1?OIMO.PI:OIMO.acos(t)},OIMO.PrismaticJoint=function(t,i,s){OIMO.Joint.call(this,t),this.type=OIMO.JOINT_PRISMATIC,this.localAxis1=(new OIMO.Vec3).normalize(t.localAxis1),this.localAxis2=(new OIMO.Vec3).normalize(t.localAxis2),this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z,this.nor=new OIMO.Vec3,this.tan=new OIMO.Vec3,this.bin=new OIMO.Vec3,this.ac=new OIMO.AngularConstraint(this,(new OIMO.Quat).arc(this.localAxis1,this.localAxis2)),this.limitMotor=new OIMO.LimitMotor(this.nor,(!0)),this.limitMotor.lowerLimit=i,this.limitMotor.upperLimit=s,this.t3=new OIMO.Translational3Constraint(this,this.limitMotor,new OIMO.LimitMotor(this.tan,(!0)),new OIMO.LimitMotor(this.bin,(!0)))},OIMO.PrismaticJoint.prototype=Object.create(OIMO.Joint.prototype),OIMO.PrismaticJoint.prototype.constructor=OIMO.PrismaticJoint,OIMO.PrismaticJoint.prototype.preSolve=function(t,i){var s,h;this.updateAnchorPoints(),s=this.body1.rotation.elements;var e=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],o=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],a=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8];s=this.body2.rotation.elements;var n=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],r=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],l=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],c=e*this.body2.inverseMass+n*this.body1.inverseMass,m=o*this.body2.inverseMass+r*this.body1.inverseMass,p=a*this.body2.inverseMass+l*this.body1.inverseMass;h=OIMO.sqrt(c*c+m*m+p*p),h>0&&(h=1/h),c*=h,m*=h,p*=h;var O=m*c-p*p,u=-p*m-c*c,x=c*p+m*m;h=1/OIMO.sqrt(O*O+u*u+x*x),O*=h,u*=h,x*=h;var y=m*x-p*u,I=p*O-c*x,M=c*u-m*O;this.nor.init(c,m,p),this.tan.init(O,u,x),this.bin.init(y,I,M),this.ac.preSolve(t,i),this.t3.preSolve(t,i)},OIMO.PrismaticJoint.prototype.solve=function(){this.ac.solve(),this.t3.solve()},OIMO.PrismaticJoint.prototype.postSolve=function(){},OIMO.SliderJoint=function(t,i,s){OIMO.Joint.call(this,t),this.type=OIMO.JOINT_SLIDER,this.localAxis1=(new OIMO.Vec3).normalize(t.localAxis1),this.localAxis2=(new OIMO.Vec3).normalize(t.localAxis2);var h;this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y,h=1/OIMO.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=h,this.localAngAxis1Y*=h,this.localAngAxis1Z*=h,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z;var e=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2)),o=e.elements;this.localAngAxis2X=this.localAngAxis1X*o[0]+this.localAngAxis1Y*o[1]+this.localAngAxis1Z*o[2],this.localAngAxis2Y=this.localAngAxis1X*o[3]+this.localAngAxis1Y*o[4]+this.localAngAxis1Z*o[5],this.localAngAxis2Z=this.localAngAxis1X*o[6]+this.localAngAxis1Y*o[7]+this.localAngAxis1Z*o[8],this.nor=new OIMO.Vec3,this.tan=new OIMO.Vec3,this.bin=new OIMO.Vec3,this.rotationalLimitMotor=new OIMO.LimitMotor(this.nor,(!1)),this.r3=new OIMO.Rotational3Constraint(this,this.rotationalLimitMotor,new OIMO.LimitMotor(this.tan,(!0)),new OIMO.LimitMotor(this.bin,(!0))),this.translationalLimitMotor=new OIMO.LimitMotor(this.nor,(!0)),this.translationalLimitMotor.lowerLimit=i,this.translationalLimitMotor.upperLimit=s,this.t3=new OIMO.Translational3Constraint(this,this.translationalLimitMotor,new OIMO.LimitMotor(this.tan,(!0)),new OIMO.LimitMotor(this.bin,(!0)))},OIMO.SliderJoint.prototype=Object.create(OIMO.Joint.prototype),OIMO.SliderJoint.prototype.constructor=OIMO.SliderJoint,OIMO.SliderJoint.prototype.preSolve=function(t,i){var s,h,e,o;this.updateAnchorPoints(),s=this.body1.rotation.elements;var a=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],n=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],r=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8],l=this.localAngAxis1X*s[0]+this.localAngAxis1Y*s[1]+this.localAngAxis1Z*s[2],c=this.localAngAxis1X*s[3]+this.localAngAxis1Y*s[4]+this.localAngAxis1Z*s[5],m=this.localAngAxis1X*s[6]+this.localAngAxis1Y*s[7]+this.localAngAxis1Z*s[8];s=this.body2.rotation.elements;var p=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],O=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],u=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],x=this.localAngAxis2X*s[0]+this.localAngAxis2Y*s[1]+this.localAngAxis2Z*s[2],y=this.localAngAxis2X*s[3]+this.localAngAxis2Y*s[4]+this.localAngAxis2Z*s[5],I=this.localAngAxis2X*s[6]+this.localAngAxis2Y*s[7]+this.localAngAxis2Z*s[8],M=a*this.body2.inverseMass+p*this.body1.inverseMass,d=n*this.body2.inverseMass+O*this.body1.inverseMass,N=r*this.body2.inverseMass+u*this.body1.inverseMass;h=OIMO.sqrt(M*M+d*d+N*N),h>0&&(h=1/h),M*=h,d*=h,N*=h;var f=d*M-N*N,z=-N*d-M*M,v=M*N+d*d;h=1/OIMO.sqrt(f*f+z*z+v*v),f*=h,z*=h,v*=h;var b=d*v-N*z,A=N*f-M*v,k=M*z-d*f;this.nor.init(M,d,N),this.tan.init(f,z,v),this.bin.init(b,A,k),M*(c*I-m*y)+d*(m*x-l*I)+N*(l*y-c*x)<0?this.rotationalLimitMotor.angle=-this.acosClamp(l*x+c*y+m*I):this.rotationalLimitMotor.angle=this.acosClamp(l*x+c*y+m*I),h=n*u-r*O,e=r*p-a*u,o=a*O-n*p,this.r3.limitMotor2.angle=f*h+z*e+v*o,this.r3.limitMotor3.angle=b*h+A*e+k*o,this.r3.preSolve(t,i),this.t3.preSolve(t,i)},OIMO.SliderJoint.prototype.solve=function(){this.r3.solve(),this.t3.solve()},OIMO.SliderJoint.prototype.postSolve=function(){},OIMO.SliderJoint.prototype.acosClamp=function(t){return t>1?0:t<-1?OIMO.PI:OIMO.acos(t)},OIMO.WheelJoint=function(t){OIMO.Joint.call(this,t),this.type=OIMO.JOINT_WHEEL,this.localAxis1=(new OIMO.Vec3).normalize(t.localAxis1),this.localAxis2=(new OIMO.Vec3).normalize(t.localAxis2);var i;this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z;var s=this.localAxis1X*this.localAxis2X+this.localAxis1Y*this.localAxis2Y+this.localAxis1Z*this.localAxis2Z;if(s>-1&&s<1)this.localAngAxis1X=this.localAxis2X-s*this.localAxis1X,this.localAngAxis1Y=this.localAxis2Y-s*this.localAxis1Y,this.localAngAxis1Z=this.localAxis2Z-s*this.localAxis1Z,this.localAngAxis2X=this.localAxis1X-s*this.localAxis2X,this.localAngAxis2Y=this.localAxis1Y-s*this.localAxis2Y,this.localAngAxis2Z=this.localAxis1Z-s*this.localAxis2Z,i=1/OIMO.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=i,this.localAngAxis1Y*=i,this.localAngAxis1Z*=i,i=1/OIMO.sqrt(this.localAngAxis2X*this.localAngAxis2X+this.localAngAxis2Y*this.localAngAxis2Y+this.localAngAxis2Z*this.localAngAxis2Z),this.localAngAxis2X*=i,this.localAngAxis2Y*=i,this.localAngAxis2Z*=i;else{this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y,i=1/OIMO.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=i,this.localAngAxis1Y*=i,this.localAngAxis1Z*=i;var h=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2)),e=h.elements;this.localAngAxis2X=this.localAngAxis1X*e[0]+this.localAngAxis1Y*e[1]+this.localAngAxis1Z*e[2],this.localAngAxis2Y=this.localAngAxis1X*e[3]+this.localAngAxis1Y*e[4]+this.localAngAxis1Z*e[5],this.localAngAxis2Z=this.localAngAxis1X*e[6]+this.localAngAxis1Y*e[7]+this.localAngAxis1Z*e[8]}this.nor=new OIMO.Vec3,this.tan=new OIMO.Vec3,this.bin=new OIMO.Vec3,this.translationalLimitMotor=new OIMO.LimitMotor(this.tan,(!0)),this.translationalLimitMotor.frequency=8,this.translationalLimitMotor.dampingRatio=1,this.rotationalLimitMotor1=new OIMO.LimitMotor(this.tan,(!1)),this.rotationalLimitMotor2=new OIMO.LimitMotor(this.bin,(!1)),this.t3=new OIMO.Translational3Constraint(this,new OIMO.LimitMotor(this.nor,(!0)),this.translationalLimitMotor,new OIMO.LimitMotor(this.bin,(!0))),this.t3.weight=1,this.r3=new OIMO.Rotational3Constraint(this,new OIMO.LimitMotor(this.nor,(!0)),this.rotationalLimitMotor1,this.rotationalLimitMotor2)},OIMO.WheelJoint.prototype=Object.create(OIMO.Joint.prototype),OIMO.WheelJoint.prototype.constructor=OIMO.WheelJoint,OIMO.WheelJoint.prototype.preSolve=function(t,i){var s,h;this.updateAnchorPoints(),s=this.body1.rotation.elements;var e=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],o=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],a=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8],n=this.localAngAxis1X*s[0]+this.localAngAxis1Y*s[1]+this.localAngAxis1Z*s[2],r=this.localAngAxis1X*s[3]+this.localAngAxis1Y*s[4]+this.localAngAxis1Z*s[5],l=this.localAngAxis1X*s[6]+this.localAngAxis1Y*s[7]+this.localAngAxis1Z*s[8];s=this.body2.rotation.elements;var c=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],m=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],p=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],O=this.localAngAxis2X*s[0]+this.localAngAxis2Y*s[1]+this.localAngAxis2Z*s[2],u=this.localAngAxis2X*s[3]+this.localAngAxis2Y*s[4]+this.localAngAxis2Z*s[5],x=this.localAngAxis2X*s[6]+this.localAngAxis2Y*s[7]+this.localAngAxis2Z*s[8];this.r3.limitMotor1.angle=e*c+o*m+a*p,e*(r*p-l*m)+o*(l*c-n*p)+a*(n*m-r*c)<0?this.rotationalLimitMotor1.angle=-this.acosClamp(n*c+r*m+l*p):this.rotationalLimitMotor1.angle=this.acosClamp(n*c+r*m+l*p),c*(u*a-x*o)+m*(x*e-O*a)+p*(O*o-u*e)<0?this.rotationalLimitMotor2.angle=this.acosClamp(O*e+u*o+x*a):this.rotationalLimitMotor2.angle=-this.acosClamp(O*e+u*o+x*a);var y=m*a-p*o,I=p*e-c*a,M=c*o-m*e;h=OIMO.sqrt(y*y+I*I+M*M),h>0&&(h=1/h),y*=h,I*=h,M*=h;var d=I*p-M*m,N=M*c-y*p,f=y*m-I*c;h=OIMO.sqrt(d*d+N*N+f*f),h>0&&(h=1/h),d*=h,N*=h,f*=h;var z=o*M-a*I,v=a*y-e*M,b=e*I-o*y;h=OIMO.sqrt(z*z+v*v+b*b),h>0&&(h=1/h),z*=h,v*=h,b*=h,this.nor.init(y,I,M),this.tan.init(d,N,f),this.bin.init(z,v,b),this.r3.preSolve(t,i),this.t3.preSolve(t,i)},OIMO.WheelJoint.prototype.solve=function(){this.r3.solve(),this.t3.solve()},OIMO.WheelJoint.prototype.postSolve=function(){},OIMO.WheelJoint.prototype.acosClamp=function(t){return t>1?0:t<-1?OIMO.PI:OIMO.acos(t)},OIMO.AngularConstraint=function(t,i){this.joint=t,this.targetOrientation=(new OIMO.Quat).invert(i),this.relativeOrientation=new OIMO.Quat,this.ii1=null,this.ii2=null,this.dd=null,this.vel=new OIMO.Vec3,this.imp=new OIMO.Vec3,this.rn0=new OIMO.Vec3,this.rn1=new OIMO.Vec3,this.rn2=new OIMO.Vec3,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia},OIMO.AngularConstraint.prototype={constructor:OIMO.AngularConstraint,preSolve:function(t,i){var s,h,e;this.ii1=this.i1.clone(),this.ii2=this.i2.clone(),e=(new OIMO.Mat33).add(this.ii1,this.ii2).elements,s=1/(e[0]*(e[4]*e[8]-e[7]*e[5])+e[3]*(e[7]*e[2]-e[1]*e[8])+e[6]*(e[1]*e[5]-e[4]*e[2])),this.dd=new OIMO.Mat33(e[4]*e[8]-e[5]*e[7],e[2]*e[7]-e[1]*e[8],e[1]*e[5]-e[2]*e[4],e[5]*e[6]-e[3]*e[8],e[0]*e[8]-e[2]*e[6],e[2]*e[3]-e[0]*e[5],e[3]*e[7]-e[4]*e[6],e[1]*e[6]-e[0]*e[7],e[0]*e[4]-e[1]*e[3]).multiply(s),this.relativeOrientation.invert(this.b1.orientation),this.relativeOrientation.mul(this.targetOrientation,this.relativeOrientation),this.relativeOrientation.mul(this.b2.orientation,this.relativeOrientation),s=2*this.relativeOrientation.s,this.vel.scale(this.relativeOrientation,s),h=this.vel.length(),h>.02?(h=(.02-h)/h*i*.05,this.vel.scaleEqual(h)):this.vel.init(),this.rn1.mulMat(this.ii1,this.imp),this.rn2.mulMat(this.ii2,this.imp),this.a1.addEqual(this.rn1),this.a2.subEqual(this.rn2)},solve:function(){var t=this.a2.clone().subEqual(this.a1).subEqual(this.vel);this.rn0.mulMat(this.dd,t),this.rn1.mulMat(this.ii1,this.rn0),this.rn2.mulMat(this.ii2,this.rn0),this.imp.addEqual(this.rn0),this.a1.addEqual(this.rn1),this.a2.subEqual(this.rn2)}},OIMO.LinearConstraint=function(t){this.m1=NaN,this.m2=NaN,this.ii1=null,this.ii2=null,this.dd=null,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.ax1x=NaN,this.ax1y=NaN,this.ax1z=NaN,this.ay1x=NaN,this.ay1y=NaN,this.ay1z=NaN,this.az1x=NaN,this.az1y=NaN,this.az1z=NaN,this.ax2x=NaN,this.ax2y=NaN,this.ax2z=NaN,this.ay2x=NaN,this.ay2y=NaN,this.ay2z=NaN,this.az2x=NaN,this.az2y=NaN,this.az2z=NaN,this.vel=NaN,this.velx=NaN,this.vely=NaN,this.velz=NaN,this.joint=t,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.b1=t.body1,this.b2=t.body2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.impx=0,this.impy=0,this.impz=0},OIMO.LinearConstraint.prototype={constructor:OIMO.LinearConstraint,preSolve:function(t,i){this.r1x=this.r1.x,this.r1y=this.r1.y,this.r1z=this.r1.z,this.r2x=this.r2.x,this.r2y=this.r2.y,this.r2z=this.r2.z,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass,this.ii1=this.i1.clone(),this.ii2=this.i2.clone();var s=this.ii1.elements,h=this.ii2.elements;this.ax1x=this.r1z*s[1]+-this.r1y*s[2],this.ax1y=this.r1z*s[4]+-this.r1y*s[5],this.ax1z=this.r1z*s[7]+-this.r1y*s[8],this.ay1x=-this.r1z*s[0]+this.r1x*s[2],this.ay1y=-this.r1z*s[3]+this.r1x*s[5],this.ay1z=-this.r1z*s[6]+this.r1x*s[8],this.az1x=this.r1y*s[0]+-this.r1x*s[1],this.az1y=this.r1y*s[3]+-this.r1x*s[4],this.az1z=this.r1y*s[6]+-this.r1x*s[7],this.ax2x=this.r2z*h[1]+-this.r2y*h[2],this.ax2y=this.r2z*h[4]+-this.r2y*h[5],this.ax2z=this.r2z*h[7]+-this.r2y*h[8],this.ay2x=-this.r2z*h[0]+this.r2x*h[2],this.ay2y=-this.r2z*h[3]+this.r2x*h[5],this.ay2z=-this.r2z*h[6]+this.r2x*h[8],this.az2x=this.r2y*h[0]+-this.r2x*h[1],this.az2y=this.r2y*h[3]+-this.r2x*h[4],this.az2z=this.r2y*h[6]+-this.r2x*h[7];var e=this.m1+this.m2,o=new OIMO.Mat33(e,0,0,0,e,0,0,0,e),a=o.elements;a[0]+=s[4]*this.r1z*this.r1z-(s[7]+s[5])*this.r1y*this.r1z+s[8]*this.r1y*this.r1y,a[1]+=(s[6]*this.r1y+s[5]*this.r1x)*this.r1z-s[3]*this.r1z*this.r1z-s[8]*this.r1x*this.r1y,a[2]+=(s[3]*this.r1y-s[4]*this.r1x)*this.r1z-s[6]*this.r1y*this.r1y+s[7]*this.r1x*this.r1y,a[3]+=(s[2]*this.r1y+s[7]*this.r1x)*this.r1z-s[1]*this.r1z*this.r1z-s[8]*this.r1x*this.r1y,a[4]+=s[0]*this.r1z*this.r1z-(s[6]+s[2])*this.r1x*this.r1z+s[8]*this.r1x*this.r1x,a[5]+=(s[1]*this.r1x-s[0]*this.r1y)*this.r1z-s[7]*this.r1x*this.r1x+s[6]*this.r1x*this.r1y,a[6]+=(s[1]*this.r1y-s[4]*this.r1x)*this.r1z-s[2]*this.r1y*this.r1y+s[5]*this.r1x*this.r1y,a[7]+=(s[3]*this.r1x-s[0]*this.r1y)*this.r1z-s[5]*this.r1x*this.r1x+s[2]*this.r1x*this.r1y,a[8]+=s[0]*this.r1y*this.r1y-(s[3]+s[1])*this.r1x*this.r1y+s[4]*this.r1x*this.r1x,a[0]+=h[4]*this.r2z*this.r2z-(h[7]+h[5])*this.r2y*this.r2z+h[8]*this.r2y*this.r2y,a[1]+=(h[6]*this.r2y+h[5]*this.r2x)*this.r2z-h[3]*this.r2z*this.r2z-h[8]*this.r2x*this.r2y,a[2]+=(h[3]*this.r2y-h[4]*this.r2x)*this.r2z-h[6]*this.r2y*this.r2y+h[7]*this.r2x*this.r2y,a[3]+=(h[2]*this.r2y+h[7]*this.r2x)*this.r2z-h[1]*this.r2z*this.r2z-h[8]*this.r2x*this.r2y,a[4]+=h[0]*this.r2z*this.r2z-(h[6]+h[2])*this.r2x*this.r2z+h[8]*this.r2x*this.r2x,a[5]+=(h[1]*this.r2x-h[0]*this.r2y)*this.r2z-h[7]*this.r2x*this.r2x+h[6]*this.r2x*this.r2y,a[6]+=(h[1]*this.r2y-h[4]*this.r2x)*this.r2z-h[2]*this.r2y*this.r2y+h[5]*this.r2x*this.r2y,a[7]+=(h[3]*this.r2x-h[0]*this.r2y)*this.r2z-h[5]*this.r2x*this.r2x+h[2]*this.r2x*this.r2y,a[8]+=h[0]*this.r2y*this.r2y-(h[3]+h[1])*this.r2x*this.r2y+h[4]*this.r2x*this.r2x;var n=1/(a[0]*(a[4]*a[8]-a[7]*a[5])+a[3]*(a[7]*a[2]-a[1]*a[8])+a[6]*(a[1]*a[5]-a[4]*a[2]));this.dd=new OIMO.Mat33(a[4]*a[8]-a[5]*a[7],a[2]*a[7]-a[1]*a[8],a[1]*a[5]-a[2]*a[4],a[5]*a[6]-a[3]*a[8],a[0]*a[8]-a[2]*a[6],a[2]*a[3]-a[0]*a[5],a[3]*a[7]-a[4]*a[6],a[1]*a[6]-a[0]*a[7],a[0]*a[4]-a[1]*a[3]).multiply(n),this.velx=this.p2.x-this.p1.x,this.vely=this.p2.y-this.p1.y,this.velz=this.p2.z-this.p1.z;var r=OIMO.sqrt(this.velx*this.velx+this.vely*this.vely+this.velz*this.velz);r>.005?(r=(.005-r)/r*i*.05,this.velx*=r,this.vely*=r,this.velz*=r):(this.velx=0,this.vely=0,this.velz=0),this.impx*=.95,this.impy*=.95,this.impz*=.95,this.l1.x+=this.impx*this.m1,this.l1.y+=this.impy*this.m1,this.l1.z+=this.impz*this.m1,this.a1.x+=this.impx*this.ax1x+this.impy*this.ay1x+this.impz*this.az1x,this.a1.y+=this.impx*this.ax1y+this.impy*this.ay1y+this.impz*this.az1y,this.a1.z+=this.impx*this.ax1z+this.impy*this.ay1z+this.impz*this.az1z,this.l2.x-=this.impx*this.m2,this.l2.y-=this.impy*this.m2,this.l2.z-=this.impz*this.m2,this.a2.x-=this.impx*this.ax2x+this.impy*this.ay2x+this.impz*this.az2x,this.a2.y-=this.impx*this.ax2y+this.impy*this.ay2y+this.impz*this.az2y,this.a2.z-=this.impx*this.ax2z+this.impy*this.ay2z+this.impz*this.az2z},solve:function(){var t=this.dd.elements,i=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y-this.velx,s=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z-this.vely,h=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x-this.velz,e=i*t[0]+s*t[1]+h*t[2],o=i*t[3]+s*t[4]+h*t[5],a=i*t[6]+s*t[7]+h*t[8];this.impx+=e,this.impy+=o,this.impz+=a,this.l1.x+=e*this.m1,this.l1.y+=o*this.m1,this.l1.z+=a*this.m1,this.a1.x+=e*this.ax1x+o*this.ay1x+a*this.az1x,this.a1.y+=e*this.ax1y+o*this.ay1y+a*this.az1y,this.a1.z+=e*this.ax1z+o*this.ay1z+a*this.az1z,this.l2.x-=e*this.m2,this.l2.y-=o*this.m2,this.l2.z-=a*this.m2,this.a2.x-=e*this.ax2x+o*this.ay2x+a*this.az2x,this.a2.y-=e*this.ax2y+o*this.ay2y+a*this.az2y,this.a2.z-=e*this.ax2z+o*this.ay2z+a*this.az2z}},OIMO.Rotational3Constraint=function(t,i,s,h){this.cfm1=NaN,this.cfm2=NaN,this.cfm3=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.ax1=NaN,this.ay1=NaN,this.az1=NaN,this.ax2=NaN,this.ay2=NaN,this.az2=NaN,this.ax3=NaN,this.ay3=NaN,this.az3=NaN,this.a1x1=NaN,this.a1y1=NaN,this.a1z1=NaN,this.a2x1=NaN,this.a2y1=NaN,this.a2z1=NaN,this.a1x2=NaN,this.a1y2=NaN,this.a1z2=NaN,this.a2x2=NaN,this.a2y2=NaN,this.a2z2=NaN,this.a1x3=NaN,this.a1y3=NaN,this.a1z3=NaN,this.a2x3=NaN,this.a2y3=NaN,this.a2z3=NaN,this.lowerLimit1=NaN,this.upperLimit1=NaN,this.limitVelocity1=NaN,this.limitState1=0,this.enableMotor1=!1,this.motorSpeed1=NaN,this.maxMotorForce1=NaN,this.maxMotorImpulse1=NaN,this.lowerLimit2=NaN,this.upperLimit2=NaN,this.limitVelocity2=NaN,this.limitState2=0,this.enableMotor2=!1,this.motorSpeed2=NaN,this.maxMotorForce2=NaN,this.maxMotorImpulse2=NaN,this.lowerLimit3=NaN,this.upperLimit3=NaN,this.limitVelocity3=NaN,this.limitState3=0,this.enableMotor3=!1,this.motorSpeed3=NaN,this.maxMotorForce3=NaN,this.maxMotorImpulse3=NaN,this.k00=NaN,this.k01=NaN,this.k02=NaN,this.k10=NaN,this.k11=NaN,this.k12=NaN,this.k20=NaN,this.k21=NaN,this.k22=NaN,this.kv00=NaN,this.kv11=NaN,this.kv22=NaN,this.dv00=NaN,this.dv11=NaN,this.dv22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.limitMotor1=i,this.limitMotor2=s,this.limitMotor3=h,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse1=0,this.motorImpulse1=0,this.limitImpulse2=0,this.motorImpulse2=0,this.limitImpulse3=0,
this.motorImpulse3=0},OIMO.Rotational3Constraint.prototype={constructor:OIMO.Rotational3Constraint,preSolve:function(t,i){this.ax1=this.limitMotor1.axis.x,this.ay1=this.limitMotor1.axis.y,this.az1=this.limitMotor1.axis.z,this.ax2=this.limitMotor2.axis.x,this.ay2=this.limitMotor2.axis.y,this.az2=this.limitMotor2.axis.z,this.ax3=this.limitMotor3.axis.x,this.ay3=this.limitMotor3.axis.y,this.az3=this.limitMotor3.axis.z,this.lowerLimit1=this.limitMotor1.lowerLimit,this.upperLimit1=this.limitMotor1.upperLimit,this.motorSpeed1=this.limitMotor1.motorSpeed,this.maxMotorForce1=this.limitMotor1.maxMotorForce,this.enableMotor1=this.maxMotorForce1>0,this.lowerLimit2=this.limitMotor2.lowerLimit,this.upperLimit2=this.limitMotor2.upperLimit,this.motorSpeed2=this.limitMotor2.motorSpeed,this.maxMotorForce2=this.limitMotor2.maxMotorForce,this.enableMotor2=this.maxMotorForce2>0,this.lowerLimit3=this.limitMotor3.lowerLimit,this.upperLimit3=this.limitMotor3.upperLimit,this.motorSpeed3=this.limitMotor3.motorSpeed,this.maxMotorForce3=this.limitMotor3.maxMotorForce,this.enableMotor3=this.maxMotorForce3>0;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.limitMotor1.frequency,o=this.limitMotor2.frequency,a=this.limitMotor3.frequency,n=e>0,r=o>0,l=a>0,c=this.lowerLimit1<=this.upperLimit1,m=this.lowerLimit2<=this.upperLimit2,p=this.lowerLimit3<=this.upperLimit3,O=this.limitMotor1.angle;c?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitState1=0,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-O):O<this.lowerLimit1?(this.limitState1!=-1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-O):O>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-O):(this.limitState1=2,this.limitImpulse1=0,this.limitVelocity1=0),n||(this.limitVelocity1>.02?this.limitVelocity1-=.02:this.limitVelocity1<-.02?this.limitVelocity1+=.02:this.limitVelocity1=0)):(this.limitState1=2,this.limitImpulse1=0);var u=this.limitMotor2.angle;m?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitState2=0,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-u):u<this.lowerLimit2?(this.limitState2!=-1&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-u):u>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-u):(this.limitState2=2,this.limitImpulse2=0,this.limitVelocity2=0),r||(this.limitVelocity2>.02?this.limitVelocity2-=.02:this.limitVelocity2<-.02?this.limitVelocity2+=.02:this.limitVelocity2=0)):(this.limitState2=2,this.limitImpulse2=0);var x=this.limitMotor3.angle;if(p?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitState3=0,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-x):x<this.lowerLimit3?(this.limitState3!=-1&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-x):x>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-x):(this.limitState3=2,this.limitImpulse3=0,this.limitVelocity3=0),l||(this.limitVelocity3>.02?this.limitVelocity3-=.02:this.limitVelocity3<-.02?this.limitVelocity3+=.02:this.limitVelocity3=0)):(this.limitState3=2,this.limitImpulse3=0),this.enableMotor1&&(0!=this.limitState1||n)?this.maxMotorImpulse1=this.maxMotorForce1*t:(this.motorImpulse1=0,this.maxMotorImpulse1=0),this.enableMotor2&&(0!=this.limitState2||r)?this.maxMotorImpulse2=this.maxMotorForce2*t:(this.motorImpulse2=0,this.maxMotorImpulse2=0),this.enableMotor3&&(0!=this.limitState3||l)?this.maxMotorImpulse3=this.maxMotorForce3*t:(this.motorImpulse3=0,this.maxMotorImpulse3=0),this.a1x1=this.ax1*this.i1e00+this.ay1*this.i1e01+this.az1*this.i1e02,this.a1y1=this.ax1*this.i1e10+this.ay1*this.i1e11+this.az1*this.i1e12,this.a1z1=this.ax1*this.i1e20+this.ay1*this.i1e21+this.az1*this.i1e22,this.a2x1=this.ax1*this.i2e00+this.ay1*this.i2e01+this.az1*this.i2e02,this.a2y1=this.ax1*this.i2e10+this.ay1*this.i2e11+this.az1*this.i2e12,this.a2z1=this.ax1*this.i2e20+this.ay1*this.i2e21+this.az1*this.i2e22,this.a1x2=this.ax2*this.i1e00+this.ay2*this.i1e01+this.az2*this.i1e02,this.a1y2=this.ax2*this.i1e10+this.ay2*this.i1e11+this.az2*this.i1e12,this.a1z2=this.ax2*this.i1e20+this.ay2*this.i1e21+this.az2*this.i1e22,this.a2x2=this.ax2*this.i2e00+this.ay2*this.i2e01+this.az2*this.i2e02,this.a2y2=this.ax2*this.i2e10+this.ay2*this.i2e11+this.az2*this.i2e12,this.a2z2=this.ax2*this.i2e20+this.ay2*this.i2e21+this.az2*this.i2e22,this.a1x3=this.ax3*this.i1e00+this.ay3*this.i1e01+this.az3*this.i1e02,this.a1y3=this.ax3*this.i1e10+this.ay3*this.i1e11+this.az3*this.i1e12,this.a1z3=this.ax3*this.i1e20+this.ay3*this.i1e21+this.az3*this.i1e22,this.a2x3=this.ax3*this.i2e00+this.ay3*this.i2e01+this.az3*this.i2e02,this.a2y3=this.ax3*this.i2e10+this.ay3*this.i2e11+this.az3*this.i2e12,this.a2z3=this.ax3*this.i2e20+this.ay3*this.i2e21+this.az3*this.i2e22,this.k00=this.ax1*(this.a1x1+this.a2x1)+this.ay1*(this.a1y1+this.a2y1)+this.az1*(this.a1z1+this.a2z1),this.k01=this.ax1*(this.a1x2+this.a2x2)+this.ay1*(this.a1y2+this.a2y2)+this.az1*(this.a1z2+this.a2z2),this.k02=this.ax1*(this.a1x3+this.a2x3)+this.ay1*(this.a1y3+this.a2y3)+this.az1*(this.a1z3+this.a2z3),this.k10=this.ax2*(this.a1x1+this.a2x1)+this.ay2*(this.a1y1+this.a2y1)+this.az2*(this.a1z1+this.a2z1),this.k11=this.ax2*(this.a1x2+this.a2x2)+this.ay2*(this.a1y2+this.a2y2)+this.az2*(this.a1z2+this.a2z2),this.k12=this.ax2*(this.a1x3+this.a2x3)+this.ay2*(this.a1y3+this.a2y3)+this.az2*(this.a1z3+this.a2z3),this.k20=this.ax3*(this.a1x1+this.a2x1)+this.ay3*(this.a1y1+this.a2y1)+this.az3*(this.a1z1+this.a2z1),this.k21=this.ax3*(this.a1x2+this.a2x2)+this.ay3*(this.a1y2+this.a2y2)+this.az3*(this.a1z2+this.a2z2),this.k22=this.ax3*(this.a1x3+this.a2x3)+this.ay3*(this.a1y3+this.a2y3)+this.az3*(this.a1z3+this.a2z3),this.kv00=this.k00,this.kv11=this.k11,this.kv22=this.k22,this.dv00=1/this.kv00,this.dv11=1/this.kv11,this.dv22=1/this.kv22,n&&2!=this.limitState1){var y=6.2831853*e,I=y*y*t,M=i/(I+2*this.limitMotor1.dampingRatio*y);this.cfm1=this.kv00*M,this.limitVelocity1*=I*M}else this.cfm1=0,this.limitVelocity1*=.05*i;r&&2!=this.limitState2?(y=6.2831853*o,I=y*y*t,M=i/(I+2*this.limitMotor2.dampingRatio*y),this.cfm2=this.kv11*M,this.limitVelocity2*=I*M):(this.cfm2=0,this.limitVelocity2*=.05*i),l&&2!=this.limitState3?(y=6.2831853*a,I=y*y*t,M=i/(I+2*this.limitMotor3.dampingRatio*y),this.cfm3=this.kv22*M,this.limitVelocity3*=I*M):(this.cfm3=0,this.limitVelocity3*=.05*i),this.k00+=this.cfm1,this.k11+=this.cfm2,this.k22+=this.cfm3;var d=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*d,this.d01=(this.k02*this.k21-this.k01*this.k22)*d,this.d02=(this.k01*this.k12-this.k02*this.k11)*d,this.d10=(this.k12*this.k20-this.k10*this.k22)*d,this.d11=(this.k00*this.k22-this.k02*this.k20)*d,this.d12=(this.k02*this.k10-this.k00*this.k12)*d,this.d20=(this.k10*this.k21-this.k11*this.k20)*d,this.d21=(this.k01*this.k20-this.k00*this.k21)*d,this.d22=(this.k00*this.k11-this.k01*this.k10)*d,this.limitImpulse1*=.95,this.motorImpulse1*=.95,this.limitImpulse2*=.95,this.motorImpulse2*=.95,this.limitImpulse3*=.95,this.motorImpulse3*=.95;var N=this.limitImpulse1+this.motorImpulse1,f=this.limitImpulse2+this.motorImpulse2,z=this.limitImpulse3+this.motorImpulse3;this.a1.x+=N*this.a1x1+f*this.a1x2+z*this.a1x3,this.a1.y+=N*this.a1y1+f*this.a1y2+z*this.a1y3,this.a1.z+=N*this.a1z1+f*this.a1z2+z*this.a1z3,this.a2.x-=N*this.a2x1+f*this.a2x2+z*this.a2x3,this.a2.y-=N*this.a2y1+f*this.a2y2+z*this.a2y3,this.a2.z-=N*this.a2z1+f*this.a2z2+z*this.a2z3},solve_:function(){var t=this.a2.x-this.a1.x,i=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z;this.limitVelocity3=30;var h=t*this.ax1+i*this.ay1+s*this.az1-this.limitVelocity1,e=t*this.ax2+i*this.ay2+s*this.az2-this.limitVelocity2,o=t*this.ax3+i*this.ay3+s*this.az3-this.limitVelocity3,a=h*this.d00+e*this.d01+o*this.d02,n=h*this.d10+e*this.d11+o*this.d12,r=h*this.d20+e*this.d21+o*this.d22;this.limitImpulse1+=a,this.limitImpulse2+=n,this.limitImpulse3+=r,this.a1.x+=a*this.a1x1+n*this.a1x2+r*this.a1x3,this.a1.y+=a*this.a1y1+n*this.a1y2+r*this.a1y3,this.a1.z+=a*this.a1z1+n*this.a1z2+r*this.a1z3,this.a2.x-=a*this.a2x1+n*this.a2x2+r*this.a2x3,this.a2.y-=a*this.a2y1+n*this.a2y2+r*this.a2y3,this.a2.z-=a*this.a2z1+n*this.a2z2+r*this.a2z3},solve:function(){var t=this.a2.x-this.a1.x,i=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z,h=t*this.ax1+i*this.ay1+s*this.az1,e=t*this.ax2+i*this.ay2+s*this.az2,o=t*this.ax3+i*this.ay3+s*this.az3,a=this.motorImpulse1,n=this.motorImpulse2,r=this.motorImpulse3,l=0,c=0,m=0;this.enableMotor1&&(l=(h-this.motorSpeed1)*this.dv00,this.motorImpulse1+=l,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),l=this.motorImpulse1-a),this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-n),this.enableMotor3&&(m=(o-this.motorSpeed3)*this.dv22,this.motorImpulse3+=m,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),m=this.motorImpulse3-r),h+=l*this.kv00+c*this.k01+m*this.k02,e+=l*this.k10+c*this.kv11+m*this.k12,o+=l*this.k20+c*this.k21+m*this.kv22,h-=this.limitVelocity1+this.limitImpulse1*this.cfm1,e-=this.limitVelocity2+this.limitImpulse2*this.cfm2,o-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var p=this.limitImpulse1,O=this.limitImpulse2,u=this.limitImpulse3,x=h*this.d00+e*this.d01+o*this.d02,y=h*this.d10+e*this.d11+o*this.d12,I=h*this.d20+e*this.d21+o*this.d22;this.limitImpulse1+=x,this.limitImpulse2+=y,this.limitImpulse3+=I;var M=0;(2==this.limitState1||this.limitImpulse1*this.limitState1<0)&&(x=-p,e+=x*this.k10,o+=x*this.k20,M|=1),(2==this.limitState2||this.limitImpulse2*this.limitState2<0)&&(y=-O,h+=y*this.k01,o+=y*this.k21,M|=2),(2==this.limitState3||this.limitImpulse3*this.limitState3<0)&&(I=-u,h+=I*this.k02,e+=I*this.k12,M|=4);var d;switch(M){case 1:d=1/(this.k11*this.k22-this.k12*this.k21),y=(this.k22*e+-this.k12*o)*d,I=(-this.k21*e+this.k11*o)*d;break;case 2:d=1/(this.k00*this.k22-this.k02*this.k20),x=(this.k22*h+-this.k02*o)*d,I=(-this.k20*h+this.k00*o)*d;break;case 3:I=o/this.k22;break;case 4:d=1/(this.k00*this.k11-this.k01*this.k10),x=(this.k11*h+-this.k01*e)*d,y=(-this.k10*h+this.k00*e)*d;break;case 5:y=e/this.k11;break;case 6:x=h/this.k00}this.limitImpulse1=x+p,this.limitImpulse2=y+O,this.limitImpulse3=I+u;var N=l+x,f=c+y,z=m+I;this.a1.x+=N*this.a1x1+f*this.a1x2+z*this.a1x3,this.a1.y+=N*this.a1y1+f*this.a1y2+z*this.a1y3,this.a1.z+=N*this.a1z1+f*this.a1z2+z*this.a1z3,this.a2.x-=N*this.a2x1+f*this.a2x2+z*this.a2x3,this.a2.y-=N*this.a2y1+f*this.a2y2+z*this.a2y3,this.a2.z-=N*this.a2z1+f*this.a2z2+z*this.a2z3,t=this.a2.x-this.a1.x,i=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z,e=t*this.ax2+i*this.ay2+s*this.az2}},OIMO.RotationalConstraint=function(t,i){this.cfm=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.motorDenom=NaN,this.invMotorDenom=NaN,this.invDenom=NaN,this.ax=NaN,this.ay=NaN,this.az=NaN,this.a1x=NaN,this.a1y=NaN,this.a1z=NaN,this.a2x=NaN,this.a2y=NaN,this.a2z=NaN,this.enableLimit=!1,this.lowerLimit=NaN,this.upperLimit=NaN,this.limitVelocity=NaN,this.limitState=0,this.enableMotor=!1,this.motorSpeed=NaN,this.maxMotorForce=NaN,this.maxMotorImpulse=NaN,this.limitMotor=i,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse=0,this.motorImpulse=0},OIMO.RotationalConstraint.prototype={constructor:OIMO.RotationalConstraint,preSolve:function(t,i){this.ax=this.limitMotor.axis.x,this.ay=this.limitMotor.axis.y,this.az=this.limitMotor.axis.z,this.lowerLimit=this.limitMotor.lowerLimit,this.upperLimit=this.limitMotor.upperLimit,this.motorSpeed=this.limitMotor.motorSpeed,this.maxMotorForce=this.limitMotor.maxMotorForce,this.enableMotor=this.maxMotorForce>0;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.limitMotor.frequency,o=e>0,a=this.lowerLimit<=this.upperLimit,n=this.limitMotor.angle;if(a?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitState=0,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n):n<this.lowerLimit?(this.limitState!=-1&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n):n>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-n):(this.limitState=2,this.limitImpulse=0,this.limitVelocity=0),o||(this.limitVelocity>.02?this.limitVelocity-=.02:this.limitVelocity<-.02?this.limitVelocity+=.02:this.limitVelocity=0)):(this.limitState=2,this.limitImpulse=0),this.enableMotor&&(0!=this.limitState||o)?this.maxMotorImpulse=this.maxMotorForce*t:(this.motorImpulse=0,this.maxMotorImpulse=0),this.a1x=this.ax*this.i1e00+this.ay*this.i1e01+this.az*this.i1e02,this.a1y=this.ax*this.i1e10+this.ay*this.i1e11+this.az*this.i1e12,this.a1z=this.ax*this.i1e20+this.ay*this.i1e21+this.az*this.i1e22,this.a2x=this.ax*this.i2e00+this.ay*this.i2e01+this.az*this.i2e02,this.a2y=this.ax*this.i2e10+this.ay*this.i2e11+this.az*this.i2e12,this.a2z=this.ax*this.i2e20+this.ay*this.i2e21+this.az*this.i2e22,this.motorDenom=this.ax*(this.a1x+this.a2x)+this.ay*(this.a1y+this.a2y)+this.az*(this.a1z+this.a2z),this.invMotorDenom=1/this.motorDenom,o&&2!=this.limitState){var r=6.2831853*e,l=r*r*t,c=i/(l+2*this.limitMotor.dampingRatio*r);this.cfm=this.motorDenom*c,this.limitVelocity*=l*c}else this.cfm=0,this.limitVelocity*=.05*i;this.invDenom=1/(this.motorDenom+this.cfm),this.limitImpulse*=.95,this.motorImpulse*=.95;var m=this.limitImpulse+this.motorImpulse;this.a1.x+=m*this.a1x,this.a1.y+=m*this.a1y,this.a1.z+=m*this.a1z,this.a2.x-=m*this.a2x,this.a2.y-=m*this.a2y,this.a2.z-=m*this.a2z},solve:function(){var t,i=this.ax*(this.a2.x-this.a1.x)+this.ay*(this.a2.y-this.a1.y)+this.az*(this.a2.z-this.a1.z);if(this.enableMotor){t=(i-this.motorSpeed)*this.invMotorDenom;var s=this.motorImpulse;this.motorImpulse+=t,this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse),t=this.motorImpulse-s,i-=t*this.motorDenom}else t=0;var h;if(2!=this.limitState){h=(i-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom;var e=this.limitImpulse;this.limitImpulse+=h,this.limitImpulse*this.limitState<0&&(this.limitImpulse=0),h=this.limitImpulse-e}else h=0;var o=h+t;this.a1.x+=o*this.a1x,this.a1.y+=o*this.a1y,this.a1.z+=o*this.a1z,this.a2.x-=o*this.a2x,this.a2.y-=o*this.a2y,this.a2.z-=o*this.a2z}},OIMO.Translational3Constraint=function(t,i,s,h){this.m1=NaN,this.m2=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.ax1=NaN,this.ay1=NaN,this.az1=NaN,this.ax2=NaN,this.ay2=NaN,this.az2=NaN,this.ax3=NaN,this.ay3=NaN,this.az3=NaN,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.t1x1=NaN,this.t1y1=NaN,this.t1z1=NaN,this.t2x1=NaN,this.t2y1=NaN,this.t2z1=NaN,this.l1x1=NaN,this.l1y1=NaN,this.l1z1=NaN,this.l2x1=NaN,this.l2y1=NaN,this.l2z1=NaN,this.a1x1=NaN,this.a1y1=NaN,this.a1z1=NaN,this.a2x1=NaN,this.a2y1=NaN,this.a2z1=NaN,this.t1x2=NaN,this.t1y2=NaN,this.t1z2=NaN,this.t2x2=NaN,this.t2y2=NaN,this.t2z2=NaN,this.l1x2=NaN,this.l1y2=NaN,this.l1z2=NaN,this.l2x2=NaN,this.l2y2=NaN,this.l2z2=NaN,this.a1x2=NaN,this.a1y2=NaN,this.a1z2=NaN,this.a2x2=NaN,this.a2y2=NaN,this.a2z2=NaN,this.t1x3=NaN,this.t1y3=NaN,this.t1z3=NaN,this.t2x3=NaN,this.t2y3=NaN,this.t2z3=NaN,this.l1x3=NaN,this.l1y3=NaN,this.l1z3=NaN,this.l2x3=NaN,this.l2y3=NaN,this.l2z3=NaN,this.a1x3=NaN,this.a1y3=NaN,this.a1z3=NaN,this.a2x3=NaN,this.a2y3=NaN,this.a2z3=NaN,this.lowerLimit1=NaN,this.upperLimit1=NaN,this.limitVelocity1=NaN,this.limitState1=0,this.enableMotor1=!1,this.motorSpeed1=NaN,this.maxMotorForce1=NaN,this.maxMotorImpulse1=NaN,this.lowerLimit2=NaN,this.upperLimit2=NaN,this.limitVelocity2=NaN,this.limitState2=0,this.enableMotor2=!1,this.motorSpeed2=NaN,this.maxMotorForce2=NaN,this.maxMotorImpulse2=NaN,this.lowerLimit3=NaN,this.upperLimit3=NaN,this.limitVelocity3=NaN,this.limitState3=0,this.enableMotor3=!1,this.motorSpeed3=NaN,this.maxMotorForce3=NaN,this.maxMotorImpulse3=NaN,this.k00=NaN,this.k01=NaN,this.k02=NaN,this.k10=NaN,this.k11=NaN,this.k12=NaN,this.k20=NaN,this.k21=NaN,this.k22=NaN,this.kv00=NaN,this.kv11=NaN,this.kv22=NaN,this.dv00=NaN,this.dv11=NaN,this.dv22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.limitMotor1=i,this.limitMotor2=s,this.limitMotor3=h,this.b1=t.body1,this.b2=t.body2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse1=0,this.motorImpulse1=0,this.limitImpulse2=0,this.motorImpulse2=0,this.limitImpulse3=0,this.motorImpulse3=0,this.cfm1=0,this.cfm2=0,this.cfm3=0,this.weight=-1},OIMO.Translational3Constraint.prototype={constructor:OIMO.Translational3Constraint,preSolve:function(t,i){this.ax1=this.limitMotor1.axis.x,this.ay1=this.limitMotor1.axis.y,this.az1=this.limitMotor1.axis.z,this.ax2=this.limitMotor2.axis.x,this.ay2=this.limitMotor2.axis.y,this.az2=this.limitMotor2.axis.z,this.ax3=this.limitMotor3.axis.x,this.ay3=this.limitMotor3.axis.y,this.az3=this.limitMotor3.axis.z,this.lowerLimit1=this.limitMotor1.lowerLimit,this.upperLimit1=this.limitMotor1.upperLimit,this.motorSpeed1=this.limitMotor1.motorSpeed,this.maxMotorForce1=this.limitMotor1.maxMotorForce,this.enableMotor1=this.maxMotorForce1>0,this.lowerLimit2=this.limitMotor2.lowerLimit,this.upperLimit2=this.limitMotor2.upperLimit,this.motorSpeed2=this.limitMotor2.motorSpeed,this.maxMotorForce2=this.limitMotor2.maxMotorForce,this.enableMotor2=this.maxMotorForce2>0,this.lowerLimit3=this.limitMotor3.lowerLimit,this.upperLimit3=this.limitMotor3.upperLimit,this.motorSpeed3=this.limitMotor3.motorSpeed,this.maxMotorForce3=this.limitMotor3.maxMotorForce,this.enableMotor3=this.maxMotorForce3>0,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.p2.x-this.p1.x,o=this.p2.y-this.p1.y,a=this.p2.z-this.p1.z,n=e*this.ax1+o*this.ay1+a*this.az1,r=e*this.ax2+o*this.ay2+a*this.az2,l=e*this.ax3+o*this.ay3+a*this.az3,c=this.limitMotor1.frequency,m=this.limitMotor2.frequency,p=this.limitMotor3.frequency,O=c>0,u=m>0,x=p>0,y=this.lowerLimit1<=this.upperLimit1,I=this.lowerLimit2<=this.upperLimit2,M=this.lowerLimit3<=this.upperLimit3;(O&&n>20||n<-20)&&(O=!1),(u&&r>20||r<-20)&&(u=!1),(x&&l>20||l<-20)&&(x=!1),y?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitState1=0,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-n,O||(n=this.lowerLimit1)):n<this.lowerLimit1?(this.limitState1!=-1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-n,O||(n=this.lowerLimit1)):n>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-n,O||(n=this.upperLimit1)):(this.limitState1=2,this.limitImpulse1=0,this.limitVelocity1=0),O||(this.limitVelocity1>.005?this.limitVelocity1-=.005:this.limitVelocity1<-.005?this.limitVelocity1+=.005:this.limitVelocity1=0)):(this.limitState1=2,this.limitImpulse1=0),I?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitState2=0,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-r,u||(r=this.lowerLimit2)):r<this.lowerLimit2?(this.limitState2!=-1&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-r,u||(r=this.lowerLimit2)):r>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-r,u||(r=this.upperLimit2)):(this.limitState2=2,this.limitImpulse2=0,this.limitVelocity2=0),u||(this.limitVelocity2>.005?this.limitVelocity2-=.005:this.limitVelocity2<-.005?this.limitVelocity2+=.005:this.limitVelocity2=0)):(this.limitState2=2,this.limitImpulse2=0),M?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitState3=0,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-l,x||(l=this.lowerLimit3)):l<this.lowerLimit3?(this.limitState3!=-1&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-l,x||(l=this.lowerLimit3)):l>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-l,x||(l=this.upperLimit3)):(this.limitState3=2,this.limitImpulse3=0,this.limitVelocity3=0),x||(this.limitVelocity3>.005?this.limitVelocity3-=.005:this.limitVelocity3<-.005?this.limitVelocity3+=.005:this.limitVelocity3=0)):(this.limitState3=2,this.limitImpulse3=0),this.enableMotor1&&(0!=this.limitState1||O)?this.maxMotorImpulse1=this.maxMotorForce1*t:(this.motorImpulse1=0,this.maxMotorImpulse1=0),this.enableMotor2&&(0!=this.limitState2||u)?this.maxMotorImpulse2=this.maxMotorForce2*t:(this.motorImpulse2=0,this.maxMotorImpulse2=0),this.enableMotor3&&(0!=this.limitState3||x)?this.maxMotorImpulse3=this.maxMotorForce3*t:(this.motorImpulse3=0,this.maxMotorImpulse3=0);var d=n*this.ax1+r*this.ax2+l*this.ax2,N=n*this.ay1+r*this.ay2+l*this.ay2,f=n*this.az1+r*this.az2+l*this.az2,z=this.m2/(this.m1+this.m2);this.weight>=0&&(z=this.weight);var v=1-z;this.r1x=this.r1.x+d*z,this.r1y=this.r1.y+N*z,this.r1z=this.r1.z+f*z,this.r2x=this.r2.x-d*v,this.r2y=this.r2.y-N*v,this.r2z=this.r2.z-f*v,this.t1x1=this.r1y*this.az1-this.r1z*this.ay1,this.t1y1=this.r1z*this.ax1-this.r1x*this.az1,this.t1z1=this.r1x*this.ay1-this.r1y*this.ax1,this.t2x1=this.r2y*this.az1-this.r2z*this.ay1,this.t2y1=this.r2z*this.ax1-this.r2x*this.az1,this.t2z1=this.r2x*this.ay1-this.r2y*this.ax1,this.l1x1=this.ax1*this.m1,this.l1y1=this.ay1*this.m1,this.l1z1=this.az1*this.m1,this.l2x1=this.ax1*this.m2,this.l2y1=this.ay1*this.m2,this.l2z1=this.az1*this.m2,this.a1x1=this.t1x1*this.i1e00+this.t1y1*this.i1e01+this.t1z1*this.i1e02,this.a1y1=this.t1x1*this.i1e10+this.t1y1*this.i1e11+this.t1z1*this.i1e12,this.a1z1=this.t1x1*this.i1e20+this.t1y1*this.i1e21+this.t1z1*this.i1e22,this.a2x1=this.t2x1*this.i2e00+this.t2y1*this.i2e01+this.t2z1*this.i2e02,this.a2y1=this.t2x1*this.i2e10+this.t2y1*this.i2e11+this.t2z1*this.i2e12,this.a2z1=this.t2x1*this.i2e20+this.t2y1*this.i2e21+this.t2z1*this.i2e22,this.t1x2=this.r1y*this.az2-this.r1z*this.ay2,this.t1y2=this.r1z*this.ax2-this.r1x*this.az2,this.t1z2=this.r1x*this.ay2-this.r1y*this.ax2,this.t2x2=this.r2y*this.az2-this.r2z*this.ay2,this.t2y2=this.r2z*this.ax2-this.r2x*this.az2,this.t2z2=this.r2x*this.ay2-this.r2y*this.ax2,this.l1x2=this.ax2*this.m1,this.l1y2=this.ay2*this.m1,this.l1z2=this.az2*this.m1,this.l2x2=this.ax2*this.m2,this.l2y2=this.ay2*this.m2,this.l2z2=this.az2*this.m2,this.a1x2=this.t1x2*this.i1e00+this.t1y2*this.i1e01+this.t1z2*this.i1e02,this.a1y2=this.t1x2*this.i1e10+this.t1y2*this.i1e11+this.t1z2*this.i1e12,this.a1z2=this.t1x2*this.i1e20+this.t1y2*this.i1e21+this.t1z2*this.i1e22,this.a2x2=this.t2x2*this.i2e00+this.t2y2*this.i2e01+this.t2z2*this.i2e02,this.a2y2=this.t2x2*this.i2e10+this.t2y2*this.i2e11+this.t2z2*this.i2e12,this.a2z2=this.t2x2*this.i2e20+this.t2y2*this.i2e21+this.t2z2*this.i2e22,this.t1x3=this.r1y*this.az3-this.r1z*this.ay3,this.t1y3=this.r1z*this.ax3-this.r1x*this.az3,this.t1z3=this.r1x*this.ay3-this.r1y*this.ax3,this.t2x3=this.r2y*this.az3-this.r2z*this.ay3,this.t2y3=this.r2z*this.ax3-this.r2x*this.az3,this.t2z3=this.r2x*this.ay3-this.r2y*this.ax3,this.l1x3=this.ax3*this.m1,this.l1y3=this.ay3*this.m1,this.l1z3=this.az3*this.m1,this.l2x3=this.ax3*this.m2,this.l2y3=this.ay3*this.m2,this.l2z3=this.az3*this.m2,this.a1x3=this.t1x3*this.i1e00+this.t1y3*this.i1e01+this.t1z3*this.i1e02,this.a1y3=this.t1x3*this.i1e10+this.t1y3*this.i1e11+this.t1z3*this.i1e12,this.a1z3=this.t1x3*this.i1e20+this.t1y3*this.i1e21+this.t1z3*this.i1e22,this.a2x3=this.t2x3*this.i2e00+this.t2y3*this.i2e01+this.t2z3*this.i2e02,this.a2y3=this.t2x3*this.i2e10+this.t2y3*this.i2e11+this.t2z3*this.i2e12,this.a2z3=this.t2x3*this.i2e20+this.t2y3*this.i2e21+this.t2z3*this.i2e22;var b=this.m1+this.m2;if(this.k00=(this.ax1*this.ax1+this.ay1*this.ay1+this.az1*this.az1)*b,this.k01=(this.ax1*this.ax2+this.ay1*this.ay2+this.az1*this.az2)*b,this.k02=(this.ax1*this.ax3+this.ay1*this.ay3+this.az1*this.az3)*b,this.k10=(this.ax2*this.ax1+this.ay2*this.ay1+this.az2*this.az1)*b,this.k11=(this.ax2*this.ax2+this.ay2*this.ay2+this.az2*this.az2)*b,this.k12=(this.ax2*this.ax3+this.ay2*this.ay3+this.az2*this.az3)*b,this.k20=(this.ax3*this.ax1+this.ay3*this.ay1+this.az3*this.az1)*b,this.k21=(this.ax3*this.ax2+this.ay3*this.ay2+this.az3*this.az2)*b,this.k22=(this.ax3*this.ax3+this.ay3*this.ay3+this.az3*this.az3)*b,this.k00+=this.t1x1*this.a1x1+this.t1y1*this.a1y1+this.t1z1*this.a1z1,this.k01+=this.t1x1*this.a1x2+this.t1y1*this.a1y2+this.t1z1*this.a1z2,this.k02+=this.t1x1*this.a1x3+this.t1y1*this.a1y3+this.t1z1*this.a1z3,this.k10+=this.t1x2*this.a1x1+this.t1y2*this.a1y1+this.t1z2*this.a1z1,this.k11+=this.t1x2*this.a1x2+this.t1y2*this.a1y2+this.t1z2*this.a1z2,this.k12+=this.t1x2*this.a1x3+this.t1y2*this.a1y3+this.t1z2*this.a1z3,this.k20+=this.t1x3*this.a1x1+this.t1y3*this.a1y1+this.t1z3*this.a1z1,this.k21+=this.t1x3*this.a1x2+this.t1y3*this.a1y2+this.t1z3*this.a1z2,this.k22+=this.t1x3*this.a1x3+this.t1y3*this.a1y3+this.t1z3*this.a1z3,this.k00+=this.t2x1*this.a2x1+this.t2y1*this.a2y1+this.t2z1*this.a2z1,this.k01+=this.t2x1*this.a2x2+this.t2y1*this.a2y2+this.t2z1*this.a2z2,this.k02+=this.t2x1*this.a2x3+this.t2y1*this.a2y3+this.t2z1*this.a2z3,this.k10+=this.t2x2*this.a2x1+this.t2y2*this.a2y1+this.t2z2*this.a2z1,this.k11+=this.t2x2*this.a2x2+this.t2y2*this.a2y2+this.t2z2*this.a2z2,this.k12+=this.t2x2*this.a2x3+this.t2y2*this.a2y3+this.t2z2*this.a2z3,this.k20+=this.t2x3*this.a2x1+this.t2y3*this.a2y1+this.t2z3*this.a2z1,this.k21+=this.t2x3*this.a2x2+this.t2y3*this.a2y2+this.t2z3*this.a2z2,this.k22+=this.t2x3*this.a2x3+this.t2y3*this.a2y3+this.t2z3*this.a2z3,this.kv00=this.k00,this.kv11=this.k11,this.kv22=this.k22,this.dv00=1/this.kv00,this.dv11=1/this.kv11,this.dv22=1/this.kv22,O&&2!=this.limitState1){var A=6.2831853*c,k=A*A*t,S=i/(k+2*this.limitMotor1.dampingRatio*A);this.cfm1=this.kv00*S,this.limitVelocity1*=k*S}else this.cfm1=0,this.limitVelocity1*=.05*i;u&&2!=this.limitState2?(A=6.2831853*m,k=A*A*t,S=i/(k+2*this.limitMotor2.dampingRatio*A),this.cfm2=this.kv11*S,this.limitVelocity2*=k*S):(this.cfm2=0,this.limitVelocity2*=.05*i),x&&2!=this.limitState3?(A=6.2831853*p,k=A*A*t,S=i/(k+2*this.limitMotor3.dampingRatio*A),this.cfm3=this.kv22*S,this.limitVelocity3*=k*S):(this.cfm3=0,this.limitVelocity3*=.05*i),this.k00+=this.cfm1,this.k11+=this.cfm2,this.k22+=this.cfm3;var P=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*P,this.d01=(this.k02*this.k21-this.k01*this.k22)*P,this.d02=(this.k01*this.k12-this.k02*this.k11)*P,this.d10=(this.k12*this.k20-this.k10*this.k22)*P,this.d11=(this.k00*this.k22-this.k02*this.k20)*P,this.d12=(this.k02*this.k10-this.k00*this.k12)*P,this.d20=(this.k10*this.k21-this.k11*this.k20)*P,this.d21=(this.k01*this.k20-this.k00*this.k21)*P,this.d22=(this.k00*this.k11-this.k01*this.k10)*P;var g=this.limitImpulse1+this.motorImpulse1,w=this.limitImpulse2+this.motorImpulse2,L=this.limitImpulse3+this.motorImpulse3;this.l1.x+=g*this.l1x1+w*this.l1x2+L*this.l1x3,this.l1.y+=g*this.l1y1+w*this.l1y2+L*this.l1y3,this.l1.z+=g*this.l1z1+w*this.l1z2+L*this.l1z3,this.a1.x+=g*this.a1x1+w*this.a1x2+L*this.a1x3,this.a1.y+=g*this.a1y1+w*this.a1y2+L*this.a1y3,this.a1.z+=g*this.a1z1+w*this.a1z2+L*this.a1z3,this.l2.x-=g*this.l2x1+w*this.l2x2+L*this.l2x3,this.l2.y-=g*this.l2y1+w*this.l2y2+L*this.l2y3,this.l2.z-=g*this.l2z1+w*this.l2z2+L*this.l2z3,this.a2.x-=g*this.a2x1+w*this.a2x2+L*this.a2x3,this.a2.y-=g*this.a2y1+w*this.a2y2+L*this.a2y3,this.a2.z-=g*this.a2z1+w*this.a2z2+L*this.a2z3},solve:function(){var t=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y,i=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z,s=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x,h=t*this.ax1+i*this.ay1+s*this.az1,e=t*this.ax2+i*this.ay2+s*this.az2,o=t*this.ax3+i*this.ay3+s*this.az3,a=this.motorImpulse1,n=this.motorImpulse2,r=this.motorImpulse3,l=0,c=0,m=0;this.enableMotor1&&(l=(h-this.motorSpeed1)*this.dv00,this.motorImpulse1+=l,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),l=this.motorImpulse1-a),this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-n),this.enableMotor3&&(m=(o-this.motorSpeed3)*this.dv22,this.motorImpulse3+=m,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),m=this.motorImpulse3-r),h+=l*this.kv00+c*this.k01+m*this.k02,e+=l*this.k10+c*this.kv11+m*this.k12,o+=l*this.k20+c*this.k21+m*this.kv22,h-=this.limitVelocity1+this.limitImpulse1*this.cfm1,e-=this.limitVelocity2+this.limitImpulse2*this.cfm2,o-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var p=this.limitImpulse1,O=this.limitImpulse2,u=this.limitImpulse3,x=h*this.d00+e*this.d01+o*this.d02,y=h*this.d10+e*this.d11+o*this.d12,I=h*this.d20+e*this.d21+o*this.d22;this.limitImpulse1+=x,this.limitImpulse2+=y,this.limitImpulse3+=I;var M=0;(2==this.limitState1||this.limitImpulse1*this.limitState1<0)&&(x=-p,e+=x*this.k10,o+=x*this.k20,M|=1),(2==this.limitState2||this.limitImpulse2*this.limitState2<0)&&(y=-O,h+=y*this.k01,o+=y*this.k21,M|=2),(2==this.limitState3||this.limitImpulse3*this.limitState3<0)&&(I=-u,h+=I*this.k02,e+=I*this.k12,M|=4);var d;switch(M){case 1:d=1/(this.k11*this.k22-this.k12*this.k21),y=(this.k22*e+-this.k12*o)*d,
I=(-this.k21*e+this.k11*o)*d;break;case 2:d=1/(this.k00*this.k22-this.k02*this.k20),x=(this.k22*h+-this.k02*o)*d,I=(-this.k20*h+this.k00*o)*d;break;case 3:I=o/this.k22;break;case 4:d=1/(this.k00*this.k11-this.k01*this.k10),x=(this.k11*h+-this.k01*e)*d,y=(-this.k10*h+this.k00*e)*d;break;case 5:y=e/this.k11;break;case 6:x=h/this.k00}this.limitImpulse1=p+x,this.limitImpulse2=O+y,this.limitImpulse3=u+I;var N=l+x,f=c+y,z=m+I;this.l1.x+=N*this.l1x1+f*this.l1x2+z*this.l1x3,this.l1.y+=N*this.l1y1+f*this.l1y2+z*this.l1y3,this.l1.z+=N*this.l1z1+f*this.l1z2+z*this.l1z3,this.a1.x+=N*this.a1x1+f*this.a1x2+z*this.a1x3,this.a1.y+=N*this.a1y1+f*this.a1y2+z*this.a1y3,this.a1.z+=N*this.a1z1+f*this.a1z2+z*this.a1z3,this.l2.x-=N*this.l2x1+f*this.l2x2+z*this.l2x3,this.l2.y-=N*this.l2y1+f*this.l2y2+z*this.l2y3,this.l2.z-=N*this.l2z1+f*this.l2z2+z*this.l2z3,this.a2.x-=N*this.a2x1+f*this.a2x2+z*this.a2x3,this.a2.y-=N*this.a2y1+f*this.a2y2+z*this.a2y3,this.a2.z-=N*this.a2z1+f*this.a2z2+z*this.a2z3}},OIMO.TranslationalConstraint=function(t,i){this.cfm=NaN,this.m1=NaN,this.m2=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.motorDenom=NaN,this.invMotorDenom=NaN,this.invDenom=NaN,this.ax=NaN,this.ay=NaN,this.az=NaN,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.t1x=NaN,this.t1y=NaN,this.t1z=NaN,this.t2x=NaN,this.t2y=NaN,this.t2z=NaN,this.l1x=NaN,this.l1y=NaN,this.l1z=NaN,this.l2x=NaN,this.l2y=NaN,this.l2z=NaN,this.a1x=NaN,this.a1y=NaN,this.a1z=NaN,this.a2x=NaN,this.a2y=NaN,this.a2z=NaN,this.lowerLimit=NaN,this.upperLimit=NaN,this.limitVelocity=NaN,this.limitState=0,this.enableMotor=!1,this.motorSpeed=NaN,this.maxMotorForce=NaN,this.maxMotorImpulse=NaN,this.limitMotor=i,this.b1=t.body1,this.b2=t.body2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse=0,this.motorImpulse=0},OIMO.TranslationalConstraint.prototype={constructor:OIMO.TranslationalConstraint,preSolve:function(t,i){this.ax=this.limitMotor.axis.x,this.ay=this.limitMotor.axis.y,this.az=this.limitMotor.axis.z,this.lowerLimit=this.limitMotor.lowerLimit,this.upperLimit=this.limitMotor.upperLimit,this.motorSpeed=this.limitMotor.motorSpeed,this.maxMotorForce=this.limitMotor.maxMotorForce,this.enableMotor=this.maxMotorForce>0,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.p2.x-this.p1.x,o=this.p2.y-this.p1.y,a=this.p2.z-this.p1.z,n=e*this.ax+o*this.ay+a*this.az,r=this.limitMotor.frequency,l=r>0,c=this.lowerLimit<=this.upperLimit;(l&&n>20||n<-20)&&(l=!1),c?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitState=0,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n,l||(n=this.lowerLimit)):n<this.lowerLimit?(this.limitState!=-1&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n,l||(n=this.lowerLimit)):n>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-n,l||(n=this.upperLimit)):(this.limitState=2,this.limitImpulse=0,this.limitVelocity=0),l||(this.limitVelocity>.005?this.limitVelocity-=.005:this.limitVelocity<-.005?this.limitVelocity+=.005:this.limitVelocity=0)):(this.limitState=2,this.limitImpulse=0),this.enableMotor&&(0!=this.limitState||l)?this.maxMotorImpulse=this.maxMotorForce*t:(this.motorImpulse=0,this.maxMotorImpulse=0);var m=n*this.ax,p=n*this.ay,O=n*this.az,u=this.m1/(this.m1+this.m2),x=1-u;if(this.r1x=this.r1.x+m*u,this.r1y=this.r1.y+p*u,this.r1z=this.r1.z+O*u,this.r2x=this.r2.x-m*x,this.r2y=this.r2.y-p*x,this.r2z=this.r2.z-O*x,this.t1x=this.r1y*this.az-this.r1z*this.ay,this.t1y=this.r1z*this.ax-this.r1x*this.az,this.t1z=this.r1x*this.ay-this.r1y*this.ax,this.t2x=this.r2y*this.az-this.r2z*this.ay,this.t2y=this.r2z*this.ax-this.r2x*this.az,this.t2z=this.r2x*this.ay-this.r2y*this.ax,this.l1x=this.ax*this.m1,this.l1y=this.ay*this.m1,this.l1z=this.az*this.m1,this.l2x=this.ax*this.m2,this.l2y=this.ay*this.m2,this.l2z=this.az*this.m2,this.a1x=this.t1x*this.i1e00+this.t1y*this.i1e01+this.t1z*this.i1e02,this.a1y=this.t1x*this.i1e10+this.t1y*this.i1e11+this.t1z*this.i1e12,this.a1z=this.t1x*this.i1e20+this.t1y*this.i1e21+this.t1z*this.i1e22,this.a2x=this.t2x*this.i2e00+this.t2y*this.i2e01+this.t2z*this.i2e02,this.a2y=this.t2x*this.i2e10+this.t2y*this.i2e11+this.t2z*this.i2e12,this.a2z=this.t2x*this.i2e20+this.t2y*this.i2e21+this.t2z*this.i2e22,this.motorDenom=this.m1+this.m2+this.ax*(this.a1y*this.r1z-this.a1z*this.r1y+this.a2y*this.r2z-this.a2z*this.r2y)+this.ay*(this.a1z*this.r1x-this.a1x*this.r1z+this.a2z*this.r2x-this.a2x*this.r2z)+this.az*(this.a1x*this.r1y-this.a1y*this.r1x+this.a2x*this.r2y-this.a2y*this.r2x),this.invMotorDenom=1/this.motorDenom,l&&2!=this.limitState){var y=6.2831853*r,I=y*y*t,M=i/(I+2*this.limitMotor.dampingRatio*y);this.cfm=this.motorDenom*M,this.limitVelocity*=I*M}else this.cfm=0,this.limitVelocity*=.05*i;this.invDenom=1/(this.motorDenom+this.cfm);var d=this.limitImpulse+this.motorImpulse;this.l1.x+=d*this.l1x,this.l1.y+=d*this.l1y,this.l1.z+=d*this.l1z,this.a1.x+=d*this.a1x,this.a1.y+=d*this.a1y,this.a1.z+=d*this.a1z,this.l2.x-=d*this.l2x,this.l2.y-=d*this.l2y,this.l2.z-=d*this.l2z,this.a2.x-=d*this.a2x,this.a2.y-=d*this.a2y,this.a2.z-=d*this.a2z},solve:function(){var t,i=this.ax*(this.l2.x-this.l1.x)+this.ay*(this.l2.y-this.l1.y)+this.az*(this.l2.z-this.l1.z)+this.t2x*this.a2.x-this.t1x*this.a1.x+this.t2y*this.a2.y-this.t1y*this.a1.y+this.t2z*this.a2.z-this.t1z*this.a1.z;if(this.enableMotor){t=(i-this.motorSpeed)*this.invMotorDenom;var s=this.motorImpulse;this.motorImpulse+=t,this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse),t=this.motorImpulse-s,i-=t*this.motorDenom}else t=0;var h;if(2!=this.limitState){h=(i-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom;var e=this.limitImpulse;this.limitImpulse+=h,this.limitImpulse*this.limitState<0&&(this.limitImpulse=0),h=this.limitImpulse-e}else h=0;var o=h+t;this.l1.x+=o*this.l1x,this.l1.y+=o*this.l1y,this.l1.z+=o*this.l1z,this.a1.x+=o*this.a1x,this.a1.y+=o*this.a1y,this.a1.z+=o*this.a1z,this.l2.x-=o*this.l2x,this.l2.y-=o*this.l2y,this.l2.z-=o*this.l2z,this.a2.x-=o*this.a2x,this.a2.y-=o*this.a2y,this.a2.z-=o*this.a2z}},OIMO.Contact=function(){this.shape1=null,this.shape2=null,this.body1=null,this.body2=null,this.prev=null,this.next=null,this.persisting=!1,this.sleeping=!1,this.detector=null,this.constraint=null,this.touching=!1,this.b1Link=new OIMO.ContactLink(this),this.b2Link=new OIMO.ContactLink(this),this.s1Link=new OIMO.ContactLink(this),this.s2Link=new OIMO.ContactLink(this),this.manifold=new OIMO.ContactManifold,this.buffer=[],this.buffer.length=4,this.buffer[0]=new OIMO.ImpulseDataBuffer,this.buffer[1]=new OIMO.ImpulseDataBuffer,this.buffer[2]=new OIMO.ImpulseDataBuffer,this.buffer[3]=new OIMO.ImpulseDataBuffer,this.points=this.manifold.points,this.constraint=new OIMO.ContactConstraint(this.manifold)},OIMO.Contact.prototype={constructor:OIMO.Contact,mixRestitution:function(t,i){return OIMO.sqrt(t*i)},mixFriction:function(t,i){return OIMO.sqrt(t*i)},updateManifold:function(){this.constraint.restitution=this.mixRestitution(this.shape1.restitution,this.shape2.restitution),this.constraint.friction=this.mixFriction(this.shape1.friction,this.shape2.friction);for(var t=this.manifold.numPoints,i=t;i--;){var s=this.buffer[i],h=this.points[i];s.lp1X=h.localPoint1.x,s.lp1Y=h.localPoint1.y,s.lp1Z=h.localPoint1.z,s.lp2X=h.localPoint2.x,s.lp2Y=h.localPoint2.y,s.lp2Z=h.localPoint2.z,s.impulse=h.normalImpulse}this.manifold.numPoints=0,this.detector.detectCollision(this.shape1,this.shape2,this.manifold);var e=this.manifold.numPoints;if(0==e)return void(this.touching=!1);for(this.touching=!0,i=e;i--;){h=this.points[i];for(var o=h.localPoint1.x,a=h.localPoint1.y,n=h.localPoint1.z,r=h.localPoint2.x,l=h.localPoint2.y,c=h.localPoint2.z,m=-1,p=4e-4,O=t;O--;){s=this.buffer[O];var u=s.lp1X-o,x=s.lp1Y-a,y=s.lp1Z-n,I=u*u+x*x+y*y;u=s.lp2X-r,x=s.lp2Y-l,y=s.lp2Z-c;var M=u*u+x*x+y*y;I<M?I<p&&(p=I,m=O):M<p&&(p=M,m=O)}if(m!=-1){var d=this.buffer[m];this.buffer[m]=this.buffer[--t],this.buffer[t]=d,h.normalImpulse=d.impulse,h.warmStarted=!0}else h.normalImpulse=0,h.warmStarted=!1}},attach:function(t,i){this.shape1=t,this.shape2=i,this.body1=t.parent,this.body2=i.parent,this.manifold.body1=this.body1,this.manifold.body2=this.body2,this.constraint.body1=this.body1,this.constraint.body2=this.body2,this.constraint.attach(),this.s1Link.shape=i,this.s1Link.body=this.body2,this.s2Link.shape=t,this.s2Link.body=this.body1,null!=t.contactLink?(this.s1Link.next=t.contactLink).prev=this.s1Link:this.s1Link.next=null,t.contactLink=this.s1Link,t.numContacts++,null!=i.contactLink?(this.s2Link.next=i.contactLink).prev=this.s2Link:this.s2Link.next=null,i.contactLink=this.s2Link,i.numContacts++,this.b1Link.shape=i,this.b1Link.body=this.body2,this.b2Link.shape=t,this.b2Link.body=this.body1,null!=this.body1.contactLink?(this.b1Link.next=this.body1.contactLink).prev=this.b1Link:this.b1Link.next=null,this.body1.contactLink=this.b1Link,this.body1.numContacts++,null!=this.body2.contactLink?(this.b2Link.next=this.body2.contactLink).prev=this.b2Link:this.b2Link.next=null,this.body2.contactLink=this.b2Link,this.body2.numContacts++,this.prev=null,this.next=null,this.persisting=!0,this.sleeping=this.body1.sleeping&&this.body2.sleeping,this.manifold.numPoints=0},detach:function(){var t=this.s1Link.prev,i=this.s1Link.next;null!==t&&(t.next=i),null!==i&&(i.prev=t),this.shape1.contactLink==this.s1Link&&(this.shape1.contactLink=i),this.s1Link.prev=null,this.s1Link.next=null,this.s1Link.shape=null,this.s1Link.body=null,this.shape1.numContacts--,t=this.s2Link.prev,i=this.s2Link.next,null!==t&&(t.next=i),null!==i&&(i.prev=t),this.shape2.contactLink==this.s2Link&&(this.shape2.contactLink=i),this.s2Link.prev=null,this.s2Link.next=null,this.s2Link.shape=null,this.s2Link.body=null,this.shape2.numContacts--,t=this.b1Link.prev,i=this.b1Link.next,null!==t&&(t.next=i),null!==i&&(i.prev=t),this.body1.contactLink==this.b1Link&&(this.body1.contactLink=i),this.b1Link.prev=null,this.b1Link.next=null,this.b1Link.shape=null,this.b1Link.body=null,this.body1.numContacts--,t=this.b2Link.prev,i=this.b2Link.next,null!==t&&(t.next=i),null!==i&&(i.prev=t),this.body2.contactLink==this.b2Link&&(this.body2.contactLink=i),this.b2Link.prev=null,this.b2Link.next=null,this.b2Link.shape=null,this.b2Link.body=null,this.body2.numContacts--,this.manifold.body1=null,this.manifold.body2=null,this.constraint.body1=null,this.constraint.body2=null,this.constraint.detach(),this.shape1=null,this.shape2=null,this.body1=null,this.body2=null}},OIMO.ContactConstraint=function(t){OIMO.Constraint.call(this),this.manifold=t,this.restitution=NaN,this.friction=NaN,this.p1=null,this.p2=null,this.lv1=null,this.lv2=null,this.av1=null,this.av2=null,this.i1=null,this.i2=null,this.ii1=null,this.ii2=null,this.m1=NaN,this.m2=NaN,this.num=0,this.ps=t.points,this.cs=new OIMO.ContactPointDataBuffer,this.cs.next=new OIMO.ContactPointDataBuffer,this.cs.next.next=new OIMO.ContactPointDataBuffer,this.cs.next.next.next=new OIMO.ContactPointDataBuffer},OIMO.ContactConstraint.prototype=Object.create(OIMO.Constraint.prototype),OIMO.ContactConstraint.prototype.attach=function(){this.p1=this.body1.position,this.p2=this.body2.position,this.lv1=this.body1.linearVelocity,this.av1=this.body1.angularVelocity,this.lv2=this.body2.linearVelocity,this.av2=this.body2.angularVelocity,this.i1=this.body1.inverseInertia,this.i2=this.body2.inverseInertia},OIMO.ContactConstraint.prototype.detach=function(){this.p1=null,this.p2=null,this.lv1=null,this.lv2=null,this.av1=null,this.av2=null,this.i1=null,this.i2=null},OIMO.ContactConstraint.prototype.preSolve=function(t,i){this.m1=this.body1.inverseMass,this.m2=this.body2.inverseMass,this.ii1=this.i1.clone(),this.ii2=this.i2.clone();var s=this.ii1.elements,h=this.ii2.elements,e=this.p1.x,o=this.p1.y,a=this.p1.z,n=this.p2.x,r=this.p2.y,l=this.p2.z,c=this.m1+this.m2;this.num=this.manifold.numPoints;for(var m=this.cs,p=0;p<this.num;p++){var O,u,x,y,I,M,d=this.ps[p];O=d.position.x,u=d.position.y,x=d.position.z;var N=O-e,f=u-o,z=x-a,v=O-n,b=u-r,A=x-l;m.rp1X=N,m.rp1Y=f,m.rp1Z=z,m.rp2X=v,m.rp2Y=b,m.rp2Z=A,m.norImp=d.normalImpulse,m.tanImp=d.tangentImpulse,m.binImp=d.binormalImpulse;var k=d.normal.x,S=d.normal.y,P=d.normal.z,g=this.lv2.x+this.av2.y*A-this.av2.z*b-(this.lv1.x+this.av1.y*z-this.av1.z*f),w=this.lv2.y+this.av2.z*v-this.av2.x*A-(this.lv1.y+this.av1.z*N-this.av1.x*z),L=this.lv2.z+this.av2.x*b-this.av2.y*v-(this.lv1.z+this.av1.x*f-this.av1.y*N),V=k*g+S*w+P*L,C=g-V*k,T=w-V*S,D=L-V*P,B=C*C+T*T+D*D;B>.04?B=1/OIMO.sqrt(B):(C=S*k-P*P,T=-P*S-k*k,D=k*P+S*S,B=1/OIMO.sqrt(C*C+T*T+D*D)),C*=B,T*=B,D*=B;var E=S*D-P*T,_=P*C-k*D,Y=k*T-S*C;m.norX=k,m.norY=S,m.norZ=P,m.tanX=C,m.tanY=T,m.tanZ=D,m.binX=E,m.binY=_,m.binZ=Y,m.norU1X=k*this.m1,m.norU1Y=S*this.m1,m.norU1Z=P*this.m1,m.norU2X=k*this.m2,m.norU2Y=S*this.m2,m.norU2Z=P*this.m2,m.tanU1X=C*this.m1,m.tanU1Y=T*this.m1,m.tanU1Z=D*this.m1,m.tanU2X=C*this.m2,m.tanU2Y=T*this.m2,m.tanU2Z=D*this.m2,m.binU1X=E*this.m1,m.binU1Y=_*this.m1,m.binU1Z=Y*this.m1,m.binU2X=E*this.m2,m.binU2Y=_*this.m2,m.binU2Z=Y*this.m2;var X=f*P-z*S,R=z*k-N*P,Z=N*S-f*k,U=b*P-A*S,J=A*k-v*P,q=v*S-b*k,F=f*D-z*T,j=z*C-N*D,H=N*T-f*C,W=b*D-A*T,Q=A*C-v*D,G=v*T-b*C,K=f*Y-z*_,$=z*E-N*Y,tt=N*_-f*E,it=b*Y-A*_,st=A*E-v*Y,ht=v*_-b*E,et=X*s[0]+R*s[1]+Z*s[2],ot=X*s[3]+R*s[4]+Z*s[5],at=X*s[6]+R*s[7]+Z*s[8],nt=U*h[0]+J*h[1]+q*h[2],rt=U*h[3]+J*h[4]+q*h[5],lt=U*h[6]+J*h[7]+q*h[8],ct=F*s[0]+j*s[1]+H*s[2],mt=F*s[3]+j*s[4]+H*s[5],pt=F*s[6]+j*s[7]+H*s[8],Ot=W*h[0]+Q*h[1]+G*h[2],ut=W*h[3]+Q*h[4]+G*h[5],xt=W*h[6]+Q*h[7]+G*h[8],yt=K*s[0]+$*s[1]+tt*s[2],It=K*s[3]+$*s[4]+tt*s[5],Mt=K*s[6]+$*s[7]+tt*s[8],dt=it*h[0]+st*h[1]+ht*h[2],Nt=it*h[3]+st*h[4]+ht*h[5],ft=it*h[6]+st*h[7]+ht*h[8];m.norT1X=X,m.norT1Y=R,m.norT1Z=Z,m.tanT1X=F,m.tanT1Y=j,m.tanT1Z=H,m.binT1X=K,m.binT1Y=$,m.binT1Z=tt,m.norT2X=U,m.norT2Y=J,m.norT2Z=q,m.tanT2X=W,m.tanT2Y=Q,m.tanT2Z=G,m.binT2X=it,m.binT2Y=st,m.binT2Z=ht,m.norTU1X=et,m.norTU1Y=ot,m.norTU1Z=at,m.tanTU1X=ct,m.tanTU1Y=mt,m.tanTU1Z=pt,m.binTU1X=yt,m.binTU1Y=It,m.binTU1Z=Mt,m.norTU2X=nt,m.norTU2Y=rt,m.norTU2Z=lt,m.tanTU2X=Ot,m.tanTU2Y=ut,m.tanTU2Z=xt,m.binTU2X=dt,m.binTU2Y=Nt,m.binTU2Z=ft,O=X*s[0]+R*s[1]+Z*s[2],u=X*s[3]+R*s[4]+Z*s[5],x=X*s[6]+R*s[7]+Z*s[8],y=u*z-x*f,I=x*N-O*z,M=O*f-u*N,O=U*h[0]+J*h[1]+q*h[2],u=U*h[3]+J*h[4]+q*h[5],x=U*h[6]+J*h[7]+q*h[8],y+=u*A-x*b,I+=x*v-O*A,M+=O*b-u*v;var zt=1/(c+k*y+S*I+P*M);O=F*s[0]+j*s[1]+H*s[2],u=F*s[3]+j*s[4]+H*s[5],x=F*s[6]+j*s[7]+H*s[8],y=u*z-x*f,I=x*N-O*z,M=O*f-u*N,O=W*h[0]+Q*h[1]+G*h[2],u=W*h[3]+Q*h[4]+G*h[5],x=W*h[6]+Q*h[7]+G*h[8],y+=u*A-x*b,I+=x*v-O*A,M+=O*b-u*v;var vt=1/(c+C*y+T*I+D*M);O=K*s[0]+$*s[1]+tt*s[2],u=K*s[3]+$*s[4]+tt*s[5],x=K*s[6]+$*s[7]+tt*s[8],y=u*z-x*f,I=x*N-O*z,M=O*f-u*N,O=it*h[0]+st*h[1]+ht*h[2],u=it*h[3]+st*h[4]+ht*h[5],x=it*h[6]+st*h[7]+ht*h[8],y+=u*A-x*b,I+=x*v-O*A,M+=O*b-u*v;var bt=1/(c+E*y+_*I+Y*M);if(m.norDen=zt,m.tanDen=vt,m.binDen=bt,d.warmStarted){var At=d.normalImpulse;this.lv1.x+=m.norU1X*At,this.lv1.y+=m.norU1Y*At,this.lv1.z+=m.norU1Z*At,this.av1.x+=et*At,this.av1.y+=ot*At,this.av1.z+=at*At,this.lv2.x-=m.norU2X*At,this.lv2.y-=m.norU2Y*At,this.lv2.z-=m.norU2Z*At,this.av2.x-=nt*At,this.av2.y-=rt*At,this.av2.z-=lt*At,m.norImp=At,m.tanImp=0,m.binImp=0,V=0}else m.norImp=0,m.tanImp=0,m.binImp=0;V>-1&&(V=0);var kt=this.restitution*-V,St=-(d.penetration+.005)*i*.05;kt<St&&(kt=St),m.norTar=kt,m.last=p==this.num-1,m=m.next}},OIMO.ContactConstraint.prototype.solve=function(){for(var t=this.lv1.x,i=this.lv1.y,s=this.lv1.z,h=this.lv2.x,e=this.lv2.y,o=this.lv2.z,a=this.av1.x,n=this.av1.y,r=this.av1.z,l=this.av2.x,c=this.av2.y,m=this.av2.z,p=this.cs;;){var O,u,x,y,I,M=p.norImp,d=p.tanImp,N=p.binImp,f=-M*this.friction,z=h-t,v=e-i,b=o-s;I=z*p.tanX+v*p.tanY+b*p.tanZ+l*p.tanT2X+c*p.tanT2Y+m*p.tanT2Z-a*p.tanT1X-n*p.tanT1Y-r*p.tanT1Z,O=d,u=I*p.tanDen,d+=u,I=z*p.binX+v*p.binY+b*p.binZ+l*p.binT2X+c*p.binT2Y+m*p.binT2Z-a*p.binT1X-n*p.binT1Y-r*p.binT1Z,x=N,y=I*p.binDen,N+=y;var A=d*d+N*N;if(A>f*f&&(A=f/OIMO.sqrt(A),d*=A,N*=A),u=d-O,y=N-x,t+=p.tanU1X*u+p.binU1X*y,i+=p.tanU1Y*u+p.binU1Y*y,s+=p.tanU1Z*u+p.binU1Z*y,a+=p.tanTU1X*u+p.binTU1X*y,n+=p.tanTU1Y*u+p.binTU1Y*y,r+=p.tanTU1Z*u+p.binTU1Z*y,h-=p.tanU2X*u+p.binU2X*y,e-=p.tanU2Y*u+p.binU2Y*y,o-=p.tanU2Z*u+p.binU2Z*y,l-=p.tanTU2X*u+p.binTU2X*y,c-=p.tanTU2Y*u+p.binTU2Y*y,m-=p.tanTU2Z*u+p.binTU2Z*y,I=(h-t)*p.norX+(e-i)*p.norY+(o-s)*p.norZ+l*p.norT2X+c*p.norT2Y+m*p.norT2Z-a*p.norT1X-n*p.norT1Y-r*p.norT1Z,O=M,u=(I-p.norTar)*p.norDen,M+=u,M>0&&(M=0),u=M-O,t+=p.norU1X*u,i+=p.norU1Y*u,s+=p.norU1Z*u,a+=p.norTU1X*u,n+=p.norTU1Y*u,r+=p.norTU1Z*u,h-=p.norU2X*u,e-=p.norU2Y*u,o-=p.norU2Z*u,l-=p.norTU2X*u,c-=p.norTU2Y*u,m-=p.norTU2Z*u,p.norImp=M,p.tanImp=d,p.binImp=N,p.last)break;p=p.next}this.lv1.x=t,this.lv1.y=i,this.lv1.z=s,this.lv2.x=h,this.lv2.y=e,this.lv2.z=o,this.av1.x=a,this.av1.y=n,this.av1.z=r,this.av2.x=l,this.av2.y=c,this.av2.z=m},OIMO.ContactConstraint.prototype.postSolve=function(){for(var t=this.cs,i=this.num;i--;){var s=this.ps[i];s.normal.x=t.norX,s.normal.y=t.norY,s.normal.z=t.norZ,s.tangent.x=t.tanX,s.tangent.y=t.tanY,s.tangent.z=t.tanZ,s.binormal.x=t.binX,s.binormal.y=t.binY,s.binormal.z=t.binZ,s.normalImpulse=t.norImp,s.tangentImpulse=t.tanImp,s.binormalImpulse=t.binImp,s.normalDenominator=t.norDen,s.tangentDenominator=t.tanDen,s.binormalDenominator=t.binDen,t=t.next}},OIMO.ContactLink=function(t){this.prev=null,this.next=null,this.shape=null,this.body=null,this.contact=t},OIMO.ContactManifold=function(){this.body1=null,this.body2=null,this.numPoints=0,this.points=[],this.points.length=4,this.points[0]=new OIMO.ManifoldPoint,this.points[1]=new OIMO.ManifoldPoint,this.points[2]=new OIMO.ManifoldPoint,this.points[3]=new OIMO.ManifoldPoint},OIMO.ContactManifold.prototype={constructor:OIMO.ContactManifold,reset:function(t,i){this.body1=t.parent,this.body2=i.parent,this.numPoints=0},addPoint:function(t,i,s,h,e,o,a,n){var r=this.points[this.numPoints++];r.position.x=t,r.position.y=i,r.position.z=s;var l=this.body1.rotation,c=t-this.body1.position.x,m=i-this.body1.position.y,p=s-this.body1.position.z,O=l.elements;r.localPoint1.x=c*O[0]+m*O[3]+p*O[6],r.localPoint1.y=c*O[1]+m*O[4]+p*O[7],r.localPoint1.z=c*O[2]+m*O[5]+p*O[8],l=this.body2.rotation,c=t-this.body2.position.x,m=i-this.body2.position.y,p=s-this.body2.position.z,r.localPoint2.x=c*O[0]+m*O[3]+p*O[6],r.localPoint2.y=c*O[1]+m*O[4]+p*O[7],r.localPoint2.z=c*O[2]+m*O[5]+p*O[8],r.normalImpulse=0,n?(r.normal.x=-h,r.normal.y=-e,r.normal.z=-o):(r.normal.x=h,r.normal.y=e,r.normal.z=o),r.penetration=a,r.warmStarted=!1}},OIMO.ContactPointDataBuffer=function(){this.norX=NaN,this.norY=NaN,this.norZ=NaN,this.tanX=NaN,this.tanY=NaN,this.tanZ=NaN,this.binX=NaN,this.binY=NaN,this.binZ=NaN,this.rp1X=NaN,this.rp1Y=NaN,this.rp1Z=NaN,this.rp2X=NaN,this.rp2Y=NaN,this.rp2Z=NaN,this.norU1X=NaN,this.norU1Y=NaN,this.norU1Z=NaN,this.norU2X=NaN,this.norU2Y=NaN,this.norU2Z=NaN,this.tanU1X=NaN,this.tanU1Y=NaN,this.tanU1Z=NaN,this.tanU2X=NaN,this.tanU2Y=NaN,this.tanU2Z=NaN,this.binU1X=NaN,this.binU1Y=NaN,this.binU1Z=NaN,this.binU2X=NaN,this.binU2Y=NaN,this.binU2Z=NaN,this.norT1X=NaN,this.norT1Y=NaN,this.norT1Z=NaN,this.norT2X=NaN,this.norT2Y=NaN,this.norT2Z=NaN,this.tanT1X=NaN,this.tanT1Y=NaN,this.tanT1Z=NaN,this.tanT2X=NaN,this.tanT2Y=NaN,this.tanT2Z=NaN,this.binT1X=NaN,this.binT1Y=NaN,this.binT1Z=NaN,this.binT2X=NaN,this.binT2Y=NaN,this.binT2Z=NaN,this.norTU1X=NaN,this.norTU1Y=NaN,this.norTU1Z=NaN,this.norTU2X=NaN,this.norTU2Y=NaN,this.norTU2Z=NaN,this.tanTU1X=NaN,this.tanTU1Y=NaN,this.tanTU1Z=NaN,this.tanTU2X=NaN,this.tanTU2Y=NaN,this.tanTU2Z=NaN,this.binTU1X=NaN,this.binTU1Y=NaN,this.binTU1Z=NaN,this.binTU2X=NaN,this.binTU2Y=NaN,this.binTU2Z=NaN,this.norImp=NaN,this.tanImp=NaN,this.binImp=NaN,this.norDen=NaN,this.tanDen=NaN,this.binDen=NaN,this.norTar=NaN,this.next=null,this.last=!1},OIMO.ImpulseDataBuffer=function(){this.lp1X=NaN,this.lp1Y=NaN,this.lp1Z=NaN,this.lp2X=NaN,this.lp2Y=NaN,this.lp2Z=NaN,this.impulse=NaN},OIMO.ManifoldPoint=function(){this.warmStarted=!1,this.position=new OIMO.Vec3,this.localPoint1=new OIMO.Vec3,this.localPoint2=new OIMO.Vec3,this.normal=new OIMO.Vec3,this.tangent=new OIMO.Vec3,this.binormal=new OIMO.Vec3,this.normalImpulse=0,this.tangentImpulse=0,this.binormalImpulse=0,this.normalDenominator=0,this.tangentDenominator=0,this.binormalDenominator=0,this.penetration=0},OIMO.MassInfo=function(){this.mass=0,this.inertia=new OIMO.Mat33},OIMO.Shape=function(t){this.type=OIMO.SHAPE_NULL,this.id=OIMO.nextID++,this.prev=null,this.next=null,this.proxy=null,this.parent=null,this.contactLink=null,this.numContacts=0,this.position=new OIMO.Vec3,this.rotation=new OIMO.Mat33,this.relativePosition=(new OIMO.Vec3).copy(t.relativePosition),this.relativeRotation=(new OIMO.Mat33).copy(t.relativeRotation),this.aabb=new OIMO.AABB,this.density=t.density,this.friction=t.friction,this.restitution=t.restitution,this.belongsTo=t.belongsTo,this.collidesWith=t.collidesWith},OIMO.Shape.prototype={constructor:OIMO.Shape,calculateMassInfo:function(t){OIMO.Error("Shape","Inheritance error.")},updateProxy:function(){OIMO.Error("Shape","Inheritance error.")}},OIMO.ShapeConfig=function(){this.relativePosition=new OIMO.Vec3,this.relativeRotation=new OIMO.Mat33,this.friction=.4,this.restitution=.2,this.density=1,this.belongsTo=1,this.collidesWith=4294967295},OIMO.BoxShape=function(t,i,s,h){OIMO.Shape.call(this,t),this.type=OIMO.SHAPE_BOX,this.width=i,this.height=s,this.depth=h,this.halfWidth=.5*i,this.halfHeight=.5*s,this.halfDepth=.5*h,this.dimentions=new OIMO_ARRAY_TYPE(18),this.elements=new OIMO_ARRAY_TYPE(24)},OIMO.BoxShape.prototype=Object.create(OIMO.Shape.prototype),OIMO.BoxShape.prototype.constructor=OIMO.BoxShape,OIMO.BoxShape.prototype.calculateMassInfo=function(t){var i=this.width*this.height*this.depth*this.density,s=1/12;t.mass=i,t.inertia.set(i*(this.height*this.height+this.depth*this.depth)*s,0,0,0,i*(this.width*this.width+this.depth*this.depth)*s,0,0,0,i*(this.width*this.width+this.height*this.height)*s)},OIMO.BoxShape.prototype.updateProxy=function(){var t=this.rotation.elements,i=this.dimentions;i[0]=t[0],i[1]=t[3],i[2]=t[6],i[3]=t[1],i[4]=t[4],i[5]=t[7],i[6]=t[2],i[7]=t[5],i[8]=t[8],i[9]=t[0]*this.halfWidth,i[10]=t[3]*this.halfWidth,i[11]=t[6]*this.halfWidth,i[12]=t[1]*this.halfHeight,i[13]=t[4]*this.halfHeight,i[14]=t[7]*this.halfHeight,i[15]=t[2]*this.halfDepth,i[16]=t[5]*this.halfDepth,i[17]=t[8]*this.halfDepth;var s=i[9],h=i[10],e=i[11],o=i[12],a=i[13],n=i[14],r=i[15],l=i[16],c=i[17],m=this.position.x,p=this.position.y,O=this.position.z,u=this.elements;u[0]=m+s+o+r,u[1]=p+h+a+l,u[2]=O+e+n+c,u[3]=m+s+o-r,u[4]=p+h+a-l,u[5]=O+e+n-c,u[6]=m+s-o+r,u[7]=p+h-a+l,u[8]=O+e-n+c,u[9]=m+s-o-r,u[10]=p+h-a-l,u[11]=O+e-n-c,u[12]=m-s+o+r,u[13]=p-h+a+l,u[14]=O-e+n+c,u[15]=m-s+o-r,u[16]=p-h+a-l,u[17]=O-e+n-c,u[18]=m-s-o+r,u[19]=p-h-a+l,u[20]=O-e-n+c,u[21]=m-s-o-r,u[22]=p-h-a-l,u[23]=O-e-n-c;var x=i[9]<0?-i[9]:i[9],y=i[10]<0?-i[10]:i[10],I=i[11]<0?-i[11]:i[11];x=i[12]<0?x-i[12]:x+i[12],y=i[13]<0?y-i[13]:y+i[13],I=i[14]<0?I-i[14]:I+i[14],x=i[15]<0?x-i[15]:x+i[15],y=i[16]<0?y-i[16]:y+i[16],I=i[17]<0?I-i[17]:I+i[17];var M=OIMO.AABB_PROX;this.aabb.set(this.position.x-x-M,this.position.x+x+M,this.position.y-y-M,this.position.y+y+M,this.position.z-I-M,this.position.z+I+M),null!=this.proxy&&this.proxy.update()},OIMO.SphereShape=function(t,i){OIMO.Shape.call(this,t),this.type=OIMO.SHAPE_SPHERE,this.radius=i},OIMO.SphereShape.prototype=Object.create(OIMO.Shape.prototype),OIMO.SphereShape.prototype.constructor=OIMO.SphereShape,OIMO.SphereShape.prototype.calculateMassInfo=function(t){var i=1.333*OIMO.PI*this.radius*this.radius*this.radius*this.density;t.mass=i;var s=i*this.radius*this.radius*.4;t.inertia.set(s,0,0,0,s,0,0,0,s)},OIMO.SphereShape.prototype.updateProxy=function(){var t=OIMO.AABB_PROX;this.aabb.set(this.position.x-this.radius-t,this.position.x+this.radius+t,this.position.y-this.radius-t,this.position.y+this.radius+t,this.position.z-this.radius-t,this.position.z+this.radius+t),null!=this.proxy&&this.proxy.update()},OIMO.CylinderShape=function(t,i,s){OIMO.Shape.call(this,t),this.type=OIMO.SHAPE_CYLINDER,this.radius=i,this.height=s,this.halfHeight=.5*s,this.normalDirection=new OIMO.Vec3,this.halfDirection=new OIMO.Vec3},OIMO.CylinderShape.prototype=Object.create(OIMO.Shape.prototype),OIMO.CylinderShape.prototype.constructor=OIMO.CylinderShape,OIMO.CylinderShape.prototype.calculateMassInfo=function(t){var i=this.radius*this.radius,s=OIMO.PI*i*this.height*this.density,h=(.25*i+.0833*this.height*this.height)*s,e=.5*i;t.mass=s,t.inertia.set(h,0,0,0,e,0,0,0,h)},OIMO.CylinderShape.prototype.updateProxy=function(){var t,i,s,h,e,o,a,n,r,l,c,m=this.rotation.elements;e=m[1]*m[1],o=m[4]*m[4],a=m[7]*m[7],this.normalDirection.set(m[1],m[4],m[7]),this.halfDirection.scale(this.normalDirection,this.halfHeight),i=1-e,t=OIMO.sqrt(i*i+e*o+e*a),t>0&&(t=this.radius/t),i*=t,s=1-o,t=OIMO.sqrt(o*e+s*s+o*a),t>0&&(t=this.radius/t),s*=t,h=1-a,t=OIMO.sqrt(a*e+a*o+h*h),t>0&&(t=this.radius/t),h*=t,n=this.halfDirection.x<0?-this.halfDirection.x:this.halfDirection.x,r=this.halfDirection.y<0?-this.halfDirection.y:this.halfDirection.y,l=this.halfDirection.z<0?-this.halfDirection.z:this.halfDirection.z,n=i<0?n-i:n+i,r=s<0?r-s:r+s,l=h<0?l-h:l+h,c=OIMO.AABB_PROX,this.aabb.set(this.position.x-n-c,this.position.x+n+c,this.position.y-r-c,this.position.y+r+c,this.position.z-l-c,this.position.z+l+c),null!=this.proxy&&this.proxy.update()},OIMO.TetraShape=function(t,i,s,h,e){OIMO.Shape.call(this,t),this.type=OIMO.SHAPE_TETRA,this.verts=[i,s,h,e],this.faces=[mtri(0,1,2),mtri(1,2,3),mtri(2,3,4),mtri(4,0,1)]},OIMO.TetraShape.prototype=Object.create(OIMO.Shape.prototype),OIMO.TetraShape.prototype.constructor=OIMO.TetraShape,OIMO.TetraShape.prototype.calculateMassInfo=function(){},OIMO.TetraShape.prototype.updateProxy=function(){this.aabb.setFromPoints(this.verts),null!==this.proxy&&this.proxy.update()},OIMO.CollisionDetector=function(){this.flip=!1},OIMO.CollisionDetector.prototype={constructor:OIMO.CollisionDetector,detectCollision:function(t,i,s){OIMO.Error("CollisionDetector","Inheritance error.")}},OIMO.BoxBoxCollisionDetector=function(){OIMO.CollisionDetector.call(this),this.clipVertices1=new OIMO_ARRAY_TYPE(24),this.clipVertices2=new OIMO_ARRAY_TYPE(24),this.used=new OIMO_ARRAY_TYPE(8),this.INF=1/0},OIMO.BoxBoxCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype),OIMO.BoxBoxCollisionDetector.prototype.constructor=OIMO.BoxBoxCollisionDetector,OIMO.BoxBoxCollisionDetector.prototype.detectCollision=function(t,i,s){var h,e;t.id<i.id?(h=t,e=i):(h=i,e=t);var o,a,n,r,l,c,m,p,O,u,x,y,I,M,d,N,f,z,v,b,A,k,S,P,g,w,L,V,C,T,D,B,E,_,Y,X,R=h.elements,Z=e.elements,U=h.dimentions,J=e.dimentions,q=h.position,F=e.position,j=q.x,H=q.y,W=q.z,Q=F.x,G=F.y,K=F.z,$=Q-j,tt=G-H,it=K-W,st=h.halfWidth,ht=h.halfHeight,et=h.halfDepth,ot=e.halfWidth,at=e.halfHeight,nt=e.halfDepth,rt=U[0],lt=U[1],ct=U[2],mt=U[3],pt=U[4],Ot=U[5],ut=U[6],xt=U[7],yt=U[8],It=U[9],Mt=U[10],dt=U[11],Nt=U[12],ft=U[13],zt=U[14],vt=U[15],bt=U[16],At=U[17],kt=J[0],St=J[1],Pt=J[2],gt=J[3],wt=J[4],Lt=J[5],Vt=J[6],Ct=J[7],Tt=J[8],Dt=J[9],Bt=J[10],Et=J[11],_t=J[12],Yt=J[13],Xt=J[14],Rt=J[15],Zt=J[16],Ut=J[17],Jt=lt*Pt-ct*St,qt=ct*kt-rt*Pt,Ft=rt*St-lt*kt,jt=lt*Lt-ct*wt,Ht=ct*gt-rt*Lt,Wt=rt*wt-lt*gt,Qt=lt*Tt-ct*Ct,Gt=ct*Vt-rt*Tt,Kt=rt*Ct-lt*Vt,$t=pt*Pt-Ot*St,ti=Ot*kt-mt*Pt,ii=mt*St-pt*kt,si=pt*Lt-Ot*wt,hi=Ot*gt-mt*Lt,ei=mt*wt-pt*gt,oi=pt*Tt-Ot*Ct,ai=Ot*Vt-mt*Tt,ni=mt*Ct-pt*Vt,ri=xt*Pt-yt*St,li=yt*kt-ut*Pt,ci=ut*St-xt*kt,mi=xt*Lt-yt*wt,pi=yt*gt-ut*Lt,Oi=ut*wt-xt*gt,ui=xt*Tt-yt*Ct,xi=yt*Vt-ut*Tt,yi=ut*Ct-xt*Vt,Ii=!1,Mi=!1,di=!1,Ni=!1,fi=!1,zi=!1,vi=!1,bi=!1,Ai=!1;if(D=rt*$+lt*tt+ct*it,o=D>0,o||(D=-D),B=st,_=rt*kt+lt*St+ct*Pt,Y=rt*gt+lt*wt+ct*Lt,X=rt*Vt+lt*Ct+ct*Tt,_<0&&(_=-_),Y<0&&(Y=-Y),X<0&&(X=-X),E=_*ot+Y*at+X*nt,N=D-B-E,!(N>0||(D=mt*$+pt*tt+Ot*it,a=D>0,a||(D=-D),B=ht,_=mt*kt+pt*St+Ot*Pt,Y=mt*gt+pt*wt+Ot*Lt,X=mt*Vt+pt*Ct+Ot*Tt,_<0&&(_=-_),Y<0&&(Y=-Y),X<0&&(X=-X),E=_*ot+Y*at+X*nt,f=D-B-E,f>0||(D=ut*$+xt*tt+yt*it,n=D>0,n||(D=-D),B=et,_=ut*kt+xt*St+yt*Pt,Y=ut*gt+xt*wt+yt*Lt,X=ut*Vt+xt*Ct+yt*Tt,_<0&&(_=-_),Y<0&&(Y=-Y),X<0&&(X=-X),E=_*ot+Y*at+X*nt,z=D-B-E,z>0||(D=kt*$+St*tt+Pt*it,r=D>0,r||(D=-D),_=kt*rt+St*lt+Pt*ct,Y=kt*mt+St*pt+Pt*Ot,X=kt*ut+St*xt+Pt*yt,_<0&&(_=-_),Y<0&&(Y=-Y),X<0&&(X=-X),B=_*st+Y*ht+X*et,E=ot,v=1*(D-B-E),v>0||(D=gt*$+wt*tt+Lt*it,l=D>0,l||(D=-D),_=gt*rt+wt*lt+Lt*ct,Y=gt*mt+wt*pt+Lt*Ot,X=gt*ut+wt*xt+Lt*yt,_<0&&(_=-_),Y<0&&(Y=-Y),X<0&&(X=-X),B=_*st+Y*ht+X*et,E=at,b=1*(D-B-E),b>0||(D=Vt*$+Ct*tt+Tt*it,c=D>0,c||(D=-D),_=Vt*rt+Ct*lt+Tt*ct,Y=Vt*mt+Ct*pt+Tt*Ot,X=Vt*ut+Ct*xt+Tt*yt,_<0&&(_=-_),Y<0&&(Y=-Y),X<0&&(X=-X),B=_*st+Y*ht+X*et,E=nt,A=1*(D-B-E),A>0))))))){if(D=Jt*Jt+qt*qt+Ft*Ft,D>1e-5){if(D=1/OIMO.sqrt(D),Jt*=D,qt*=D,Ft*=D,D=Jt*$+qt*tt+Ft*it,m=D>0,m||(D=-D),_=Jt*mt+qt*pt+Ft*Ot,Y=Jt*ut+qt*xt+Ft*yt,_<0&&(_=-_),Y<0&&(Y=-Y),B=_*ht+Y*et,_=Jt*gt+qt*wt+Ft*Lt,Y=Jt*Vt+qt*Ct+Ft*Tt,_<0&&(_=-_),Y<0&&(Y=-Y),E=_*at+Y*nt,k=D-B-E,k>0)return}else m=!1,k=0,Ii=!0;if(D=jt*jt+Ht*Ht+Wt*Wt,D>1e-5){if(D=1/OIMO.sqrt(D),jt*=D,Ht*=D,Wt*=D,D=jt*$+Ht*tt+Wt*it,p=D>0,p||(D=-D),_=jt*mt+Ht*pt+Wt*Ot,Y=jt*ut+Ht*xt+Wt*yt,_<0&&(_=-_),Y<0&&(Y=-Y),B=_*ht+Y*et,_=jt*kt+Ht*St+Wt*Pt,Y=jt*Vt+Ht*Ct+Wt*Tt,_<0&&(_=-_),Y<0&&(Y=-Y),E=_*ot+Y*nt,S=D-B-E,S>0)return}else p=!1,S=0,Mi=!0;if(D=Qt*Qt+Gt*Gt+Kt*Kt,D>1e-5){if(D=1/OIMO.sqrt(D),Qt*=D,Gt*=D,Kt*=D,D=Qt*$+Gt*tt+Kt*it,O=D>0,O||(D=-D),_=Qt*mt+Gt*pt+Kt*Ot,Y=Qt*ut+Gt*xt+Kt*yt,_<0&&(_=-_),Y<0&&(Y=-Y),B=_*ht+Y*et,_=Qt*kt+Gt*St+Kt*Pt,Y=Qt*gt+Gt*wt+Kt*Lt,_<0&&(_=-_),Y<0&&(Y=-Y),E=_*ot+Y*at,P=D-B-E,P>0)return}else O=!1,P=0,di=!0;if(D=$t*$t+ti*ti+ii*ii,D>1e-5){if(D=1/OIMO.sqrt(D),$t*=D,ti*=D,ii*=D,D=$t*$+ti*tt+ii*it,u=D>0,u||(D=-D),_=$t*rt+ti*lt+ii*ct,Y=$t*ut+ti*xt+ii*yt,_<0&&(_=-_),Y<0&&(Y=-Y),B=_*st+Y*et,_=$t*gt+ti*wt+ii*Lt,Y=$t*Vt+ti*Ct+ii*Tt,_<0&&(_=-_),Y<0&&(Y=-Y),E=_*at+Y*nt,g=D-B-E,g>0)return}else u=!1,g=0,Ni=!0;if(D=si*si+hi*hi+ei*ei,D>1e-5){if(D=1/OIMO.sqrt(D),si*=D,hi*=D,ei*=D,D=si*$+hi*tt+ei*it,x=D>0,x||(D=-D),_=si*rt+hi*lt+ei*ct,Y=si*ut+hi*xt+ei*yt,_<0&&(_=-_),Y<0&&(Y=-Y),B=_*st+Y*et,_=si*kt+hi*St+ei*Pt,Y=si*Vt+hi*Ct+ei*Tt,_<0&&(_=-_),Y<0&&(Y=-Y),E=_*ot+Y*nt,w=D-B-E,w>0)return}else x=!1,w=0,fi=!0;if(D=oi*oi+ai*ai+ni*ni,D>1e-5){if(D=1/OIMO.sqrt(D),oi*=D,ai*=D,ni*=D,D=oi*$+ai*tt+ni*it,y=D>0,y||(D=-D),_=oi*rt+ai*lt+ni*ct,Y=oi*ut+ai*xt+ni*yt,_<0&&(_=-_),Y<0&&(Y=-Y),B=_*st+Y*et,_=oi*kt+ai*St+ni*Pt,Y=oi*gt+ai*wt+ni*Lt,_<0&&(_=-_),Y<0&&(Y=-Y),E=_*ot+Y*at,L=D-B-E,L>0)return}else y=!1,L=0,zi=!0;if(D=ri*ri+li*li+ci*ci,D>1e-5){if(D=1/OIMO.sqrt(D),ri*=D,li*=D,ci*=D,D=ri*$+li*tt+ci*it,I=D>0,I||(D=-D),_=ri*rt+li*lt+ci*ct,Y=ri*mt+li*pt+ci*Ot,_<0&&(_=-_),Y<0&&(Y=-Y),B=_*st+Y*ht,_=ri*gt+li*wt+ci*Lt,Y=ri*Vt+li*Ct+ci*Tt,_<0&&(_=-_),Y<0&&(Y=-Y),E=_*at+Y*nt,V=D-B-E,V>0)return}else I=!1,V=0,vi=!0;if(D=mi*mi+pi*pi+Oi*Oi,D>1e-5){if(D=1/OIMO.sqrt(D),mi*=D,pi*=D,Oi*=D,D=mi*$+pi*tt+Oi*it,M=D>0,M||(D=-D),_=mi*rt+pi*lt+Oi*ct,Y=mi*mt+pi*pt+Oi*Ot,_<0&&(_=-_),Y<0&&(Y=-Y),B=_*st+Y*ht,_=mi*kt+pi*St+Oi*Pt,Y=mi*Vt+pi*Ct+Oi*Tt,_<0&&(_=-_),Y<0&&(Y=-Y),E=_*ot+Y*nt,C=D-B-E,C>0)return}else M=!1,C=0,bi=!0;if(D=ui*ui+xi*xi+yi*yi,D>1e-5){if(D=1/OIMO.sqrt(D),ui*=D,xi*=D,yi*=D,D=ui*$+xi*tt+yi*it,
d=D>0,d||(D=-D),_=ui*rt+xi*lt+yi*ct,Y=ui*mt+xi*pt+yi*Ot,_<0&&(_=-_),Y<0&&(Y=-Y),B=_*st+Y*ht,_=ui*kt+xi*St+yi*Pt,Y=ui*gt+xi*wt+yi*Lt,_<0&&(_=-_),Y<0&&(Y=-Y),E=_*ot+Y*at,T=D-B-E,T>0)return}else d=!1,T=0,Ai=!0;var ki=N,Si=N,Pi=0,gi=o;f>Si&&(ki=f,Si=f,Pi=1,gi=a),z>Si&&(ki=z,Si=z,Pi=2,gi=n),v>Si&&(ki=v,Si=v,Pi=3,gi=r),b>Si&&(ki=b,Si=b,Pi=4,gi=l),A>Si&&(ki=A,Si=A,Pi=5,gi=c),k-.01>Si&&!Ii&&(ki=k,Si=k-.01,Pi=6,gi=m),S-.01>Si&&!Mi&&(ki=S,Si=S-.01,Pi=7,gi=p),P-.01>Si&&!di&&(ki=P,Si=P-.01,Pi=8,gi=O),g-.01>Si&&!Ni&&(ki=g,Si=g-.01,Pi=9,gi=u),w-.01>Si&&!fi&&(ki=w,Si=w-.01,Pi=10,gi=x),L-.01>Si&&!zi&&(ki=L,Si=L-.01,Pi=11,gi=y),V-.01>Si&&!vi&&(ki=V,Si=V-.01,Pi=12,gi=I),C-.01>Si&&!bi&&(ki=C,Si=C-.01,Pi=13,gi=M),T-.01>Si&&!Ai&&(ki=T,Pi=14,gi=d);var wi=0,Li=0,Vi=0,Ci=0,Ti=0,Di=0,Bi=0,Ei=0,_i=0,Yi=0,Xi=0,Ri=0,Zi=0,Ui=0,Ji=0,qi=0,Fi=0,ji=0,Hi=!1;0==Pi?(gi?(Yi=j+It,Xi=H+Mt,Ri=W+dt,wi=rt,Li=lt,Vi=ct):(Yi=j-It,Xi=H-Mt,Ri=W-dt,wi=-rt,Li=-lt,Vi=-ct),Zi=Nt,Ui=ft,Ji=zt,Ci=-mt,Ti=-pt,Di=-Ot,qi=vt,Fi=bt,ji=At,Bi=-ut,Ei=-xt,_i=-yt):1==Pi?(gi?(Yi=j+Nt,Xi=H+ft,Ri=W+zt,wi=mt,Li=pt,Vi=Ot):(Yi=j-Nt,Xi=H-ft,Ri=W-zt,wi=-mt,Li=-pt,Vi=-Ot),Zi=It,Ui=Mt,Ji=dt,Ci=-rt,Ti=-lt,Di=-ct,qi=vt,Fi=bt,ji=At,Bi=-ut,Ei=-xt,_i=-yt):2==Pi?(gi?(Yi=j+vt,Xi=H+bt,Ri=W+At,wi=ut,Li=xt,Vi=yt):(Yi=j-vt,Xi=H-bt,Ri=W-At,wi=-ut,Li=-xt,Vi=-yt),Zi=It,Ui=Mt,Ji=dt,Ci=-rt,Ti=-lt,Di=-ct,qi=Nt,Fi=ft,ji=zt,Bi=-mt,Ei=-pt,_i=-Ot):3==Pi?(Hi=!0,gi?(Yi=Q-Dt,Xi=G-Bt,Ri=K-Et,wi=-kt,Li=-St,Vi=-Pt):(Yi=Q+Dt,Xi=G+Bt,Ri=K+Et,wi=kt,Li=St,Vi=Pt),Zi=_t,Ui=Yt,Ji=Xt,Ci=-gt,Ti=-wt,Di=-Lt,qi=Rt,Fi=Zt,ji=Ut,Bi=-Vt,Ei=-Ct,_i=-Tt):4==Pi?(Hi=!0,gi?(Yi=Q-_t,Xi=G-Yt,Ri=K-Xt,wi=-gt,Li=-wt,Vi=-Lt):(Yi=Q+_t,Xi=G+Yt,Ri=K+Xt,wi=gt,Li=wt,Vi=Lt),Zi=Dt,Ui=Bt,Ji=Et,Ci=-kt,Ti=-St,Di=-Pt,qi=Rt,Fi=Zt,ji=Ut,Bi=-Vt,Ei=-Ct,_i=-Tt):5==Pi?(Hi=!0,gi?(Yi=Q-Rt,Xi=G-Zt,Ri=K-Ut,wi=-Vt,Li=-Ct,Vi=-Tt):(Yi=Q+Rt,Xi=G+Zt,Ri=K+Ut,wi=Vt,Li=Ct,Vi=Tt),Zi=Dt,Ui=Bt,Ji=Et,Ci=-kt,Ti=-St,Di=-Pt,qi=_t,Fi=Yt,ji=Xt,Bi=-gt,Ei=-wt,_i=-Lt):6==Pi?(wi=Jt,Li=qt,Vi=Ft,Ci=rt,Ti=lt,Di=ct,Bi=kt,Ei=St,_i=Pt):7==Pi?(wi=jt,Li=Ht,Vi=Wt,Ci=rt,Ti=lt,Di=ct,Bi=gt,Ei=wt,_i=Lt):8==Pi?(wi=Qt,Li=Gt,Vi=Kt,Ci=rt,Ti=lt,Di=ct,Bi=Vt,Ei=Ct,_i=Tt):9==Pi?(wi=$t,Li=ti,Vi=ii,Ci=mt,Ti=pt,Di=Ot,Bi=kt,Ei=St,_i=Pt):10==Pi?(wi=si,Li=hi,Vi=ei,Ci=mt,Ti=pt,Di=Ot,Bi=gt,Ei=wt,_i=Lt):11==Pi?(wi=oi,Li=ai,Vi=ni,Ci=mt,Ti=pt,Di=Ot,Bi=Vt,Ei=Ct,_i=Tt):12==Pi?(wi=ri,Li=li,Vi=ci,Ci=ut,Ti=xt,Di=yt,Bi=kt,Ei=St,_i=Pt):13==Pi?(wi=mi,Li=pi,Vi=Oi,Ci=ut,Ti=xt,Di=yt,Bi=gt,Ei=wt,_i=Lt):14==Pi&&(wi=ui,Li=xi,Vi=yi,Ci=ut,Ti=xt,Di=yt,Bi=Vt,Ei=Ct,_i=Tt);if(Pi>5){gi||(wi=-wi,Li=-Li,Vi=-Vi);var Wi,Qi,Gi,Ki,$i,ts,is,ss,hs,es,os;ts=R[0],is=R[1],ss=R[2],Qi=wi*ts+Li*is+Vi*ss,Gi=R[3],Ki=R[4],$i=R[5],Wi=wi*Gi+Li*Ki+Vi*$i,Wi>Qi&&(Qi=Wi,ts=Gi,is=Ki,ss=$i),Gi=R[6],Ki=R[7],$i=R[8],Wi=wi*Gi+Li*Ki+Vi*$i,Wi>Qi&&(Qi=Wi,ts=Gi,is=Ki,ss=$i),Gi=R[9],Ki=R[10],$i=R[11],Wi=wi*Gi+Li*Ki+Vi*$i,Wi>Qi&&(Qi=Wi,ts=Gi,is=Ki,ss=$i),Gi=R[12],Ki=R[13],$i=R[14],Wi=wi*Gi+Li*Ki+Vi*$i,Wi>Qi&&(Qi=Wi,ts=Gi,is=Ki,ss=$i),Gi=R[15],Ki=R[16],$i=R[17],Wi=wi*Gi+Li*Ki+Vi*$i,Wi>Qi&&(Qi=Wi,ts=Gi,is=Ki,ss=$i),Gi=R[18],Ki=R[19],$i=R[20],Wi=wi*Gi+Li*Ki+Vi*$i,Wi>Qi&&(Qi=Wi,ts=Gi,is=Ki,ss=$i),Gi=R[21],Ki=R[22],$i=R[23],Wi=wi*Gi+Li*Ki+Vi*$i,Wi>Qi&&(Qi=Wi,ts=Gi,is=Ki,ss=$i),hs=Z[0],es=Z[1],os=Z[2],Qi=wi*hs+Li*es+Vi*os,Gi=Z[3],Ki=Z[4],$i=Z[5],Wi=wi*Gi+Li*Ki+Vi*$i,Wi<Qi&&(Qi=Wi,hs=Gi,es=Ki,os=$i),Gi=Z[6],Ki=Z[7],$i=Z[8],Wi=wi*Gi+Li*Ki+Vi*$i,Wi<Qi&&(Qi=Wi,hs=Gi,es=Ki,os=$i),Gi=Z[9],Ki=Z[10],$i=Z[11],Wi=wi*Gi+Li*Ki+Vi*$i,Wi<Qi&&(Qi=Wi,hs=Gi,es=Ki,os=$i),Gi=Z[12],Ki=Z[13],$i=Z[14],Wi=wi*Gi+Li*Ki+Vi*$i,Wi<Qi&&(Qi=Wi,hs=Gi,es=Ki,os=$i),Gi=Z[15],Ki=Z[16],$i=Z[17],Wi=wi*Gi+Li*Ki+Vi*$i,Wi<Qi&&(Qi=Wi,hs=Gi,es=Ki,os=$i),Gi=Z[18],Ki=Z[19],$i=Z[20],Wi=wi*Gi+Li*Ki+Vi*$i,Wi<Qi&&(Qi=Wi,hs=Gi,es=Ki,os=$i),Gi=Z[21],Ki=Z[22],$i=Z[23],Wi=wi*Gi+Li*Ki+Vi*$i,Wi<Qi&&(Qi=Wi,hs=Gi,es=Ki,os=$i),Gi=hs-ts,Ki=es-is,$i=os-ss,_=Ci*Bi+Ti*Ei+Di*_i;var as=(Gi*(Ci-Bi*_)+Ki*(Ti-Ei*_)+$i*(Di-_i*_))/(1-_*_);return void s.addPoint(ts+Ci*as+wi*ki*.5,is+Ti*as+Li*ki*.5,ss+Di*as+Vi*ki*.5,wi,Li,Vi,ki,!1)}var ns,rs,ls,cs,ms,ps,Os,us,xs,ys,Is,Ms,ds=1,Ns=0,fs=0;Hi?(Ns=rt*wi+lt*Li+ct*Vi,Ns<ds&&(ds=Ns,fs=0),-Ns<ds&&(ds=-Ns,fs=1),Ns=mt*wi+pt*Li+Ot*Vi,Ns<ds&&(ds=Ns,fs=2),-Ns<ds&&(ds=-Ns,fs=3),Ns=ut*wi+xt*Li+yt*Vi,Ns<ds&&(ds=Ns,fs=4),-Ns<ds&&(ds=-Ns,fs=5),0==fs?(ns=R[0],rs=R[1],ls=R[2],cs=R[6],ms=R[7],ps=R[8],Os=R[9],us=R[10],xs=R[11],ys=R[3],Is=R[4],Ms=R[5]):1==fs?(ns=R[15],rs=R[16],ls=R[17],cs=R[21],ms=R[22],ps=R[23],Os=R[18],us=R[19],xs=R[20],ys=R[12],Is=R[13],Ms=R[14]):2==fs?(ns=R[12],rs=R[13],ls=R[14],cs=R[0],ms=R[1],ps=R[2],Os=R[3],us=R[4],xs=R[5],ys=R[15],Is=R[16],Ms=R[17]):3==fs?(ns=R[21],rs=R[22],ls=R[23],cs=R[9],ms=R[10],ps=R[11],Os=R[6],us=R[7],xs=R[8],ys=R[18],Is=R[19],Ms=R[20]):4==fs?(ns=R[12],rs=R[13],ls=R[14],cs=R[18],ms=R[19],ps=R[20],Os=R[6],us=R[7],xs=R[8],ys=R[0],Is=R[1],Ms=R[2]):5==fs&&(ns=R[3],rs=R[4],ls=R[5],cs=R[6],ms=R[7],ps=R[8],Os=R[21],us=R[22],xs=R[23],ys=R[15],Is=R[16],Ms=R[17])):(Ns=kt*wi+St*Li+Pt*Vi,Ns<ds&&(ds=Ns,fs=0),-Ns<ds&&(ds=-Ns,fs=1),Ns=gt*wi+wt*Li+Lt*Vi,Ns<ds&&(ds=Ns,fs=2),-Ns<ds&&(ds=-Ns,fs=3),Ns=Vt*wi+Ct*Li+Tt*Vi,Ns<ds&&(ds=Ns,fs=4),-Ns<ds&&(ds=-Ns,fs=5),0==fs?(ns=Z[0],rs=Z[1],ls=Z[2],cs=Z[6],ms=Z[7],ps=Z[8],Os=Z[9],us=Z[10],xs=Z[11],ys=Z[3],Is=Z[4],Ms=Z[5]):1==fs?(ns=Z[15],rs=Z[16],ls=Z[17],cs=Z[21],ms=Z[22],ps=Z[23],Os=Z[18],us=Z[19],xs=Z[20],ys=Z[12],Is=Z[13],Ms=Z[14]):2==fs?(ns=Z[12],rs=Z[13],ls=Z[14],cs=Z[0],ms=Z[1],ps=Z[2],Os=Z[3],us=Z[4],xs=Z[5],ys=Z[15],Is=Z[16],Ms=Z[17]):3==fs?(ns=Z[21],rs=Z[22],ls=Z[23],cs=Z[9],ms=Z[10],ps=Z[11],Os=Z[6],us=Z[7],xs=Z[8],ys=Z[18],Is=Z[19],Ms=Z[20]):4==fs?(ns=Z[12],rs=Z[13],ls=Z[14],cs=Z[18],ms=Z[19],ps=Z[20],Os=Z[6],us=Z[7],xs=Z[8],ys=Z[0],Is=Z[1],Ms=Z[2]):5==fs&&(ns=Z[3],rs=Z[4],ls=Z[5],cs=Z[9],ms=Z[10],ps=Z[11],Os=Z[21],us=Z[22],xs=Z[23],ys=Z[15],Is=Z[16],Ms=Z[17]));var zs,vs,bs,As,ks,Ss,Ps,gs,ws;this.clipVertices1[0]=ns,this.clipVertices1[1]=rs,this.clipVertices1[2]=ls,this.clipVertices1[3]=cs,this.clipVertices1[4]=ms,this.clipVertices1[5]=ps,this.clipVertices1[6]=Os,this.clipVertices1[7]=us,this.clipVertices1[8]=xs,this.clipVertices1[9]=ys,this.clipVertices1[10]=Is,this.clipVertices1[11]=Ms,vs=0,As=this.clipVertices1[9],ks=this.clipVertices1[10],Ss=this.clipVertices1[11],_=(As-Yi-Zi)*Ci+(ks-Xi-Ui)*Ti+(Ss-Ri-Ji)*Di;for(var Ls=0;Ls<4;Ls++)bs=3*Ls,Ps=this.clipVertices1[bs],gs=this.clipVertices1[bs+1],ws=this.clipVertices1[bs+2],Y=(Ps-Yi-Zi)*Ci+(gs-Xi-Ui)*Ti+(ws-Ri-Ji)*Di,_>0?Y>0?(bs=3*vs,vs++,this.clipVertices2[bs]=Ps,this.clipVertices2[bs+1]=gs,this.clipVertices2[bs+2]=ws):(bs=3*vs,vs++,as=_/(_-Y),this.clipVertices2[bs]=As+(Ps-As)*as,this.clipVertices2[bs+1]=ks+(gs-ks)*as,this.clipVertices2[bs+2]=Ss+(ws-Ss)*as):Y>0&&(bs=3*vs,vs++,as=_/(_-Y),this.clipVertices2[bs]=As+(Ps-As)*as,this.clipVertices2[bs+1]=ks+(gs-ks)*as,this.clipVertices2[bs+2]=Ss+(ws-Ss)*as,bs=3*vs,vs++,this.clipVertices2[bs]=Ps,this.clipVertices2[bs+1]=gs,this.clipVertices2[bs+2]=ws),As=Ps,ks=gs,Ss=ws,_=Y;if(zs=vs,0!=zs){for(vs=0,bs=3*(zs-1),As=this.clipVertices2[bs],ks=this.clipVertices2[bs+1],Ss=this.clipVertices2[bs+2],_=(As-Yi-qi)*Bi+(ks-Xi-Fi)*Ei+(Ss-Ri-ji)*_i,Ls=0;Ls<zs;Ls++)bs=3*Ls,Ps=this.clipVertices2[bs],gs=this.clipVertices2[bs+1],ws=this.clipVertices2[bs+2],Y=(Ps-Yi-qi)*Bi+(gs-Xi-Fi)*Ei+(ws-Ri-ji)*_i,_>0?Y>0?(bs=3*vs,vs++,this.clipVertices1[bs]=Ps,this.clipVertices1[bs+1]=gs,this.clipVertices1[bs+2]=ws):(bs=3*vs,vs++,as=_/(_-Y),this.clipVertices1[bs]=As+(Ps-As)*as,this.clipVertices1[bs+1]=ks+(gs-ks)*as,this.clipVertices1[bs+2]=Ss+(ws-Ss)*as):Y>0&&(bs=3*vs,vs++,as=_/(_-Y),this.clipVertices1[bs]=As+(Ps-As)*as,this.clipVertices1[bs+1]=ks+(gs-ks)*as,this.clipVertices1[bs+2]=Ss+(ws-Ss)*as,bs=3*vs,vs++,this.clipVertices1[bs]=Ps,this.clipVertices1[bs+1]=gs,this.clipVertices1[bs+2]=ws),As=Ps,ks=gs,Ss=ws,_=Y;if(zs=vs,0!=zs){for(vs=0,bs=3*(zs-1),As=this.clipVertices1[bs],ks=this.clipVertices1[bs+1],Ss=this.clipVertices1[bs+2],_=(As-Yi+Zi)*-Ci+(ks-Xi+Ui)*-Ti+(Ss-Ri+Ji)*-Di,Ls=0;Ls<zs;Ls++)bs=3*Ls,Ps=this.clipVertices1[bs],gs=this.clipVertices1[bs+1],ws=this.clipVertices1[bs+2],Y=(Ps-Yi+Zi)*-Ci+(gs-Xi+Ui)*-Ti+(ws-Ri+Ji)*-Di,_>0?Y>0?(bs=3*vs,vs++,this.clipVertices2[bs]=Ps,this.clipVertices2[bs+1]=gs,this.clipVertices2[bs+2]=ws):(bs=3*vs,vs++,as=_/(_-Y),this.clipVertices2[bs]=As+(Ps-As)*as,this.clipVertices2[bs+1]=ks+(gs-ks)*as,this.clipVertices2[bs+2]=Ss+(ws-Ss)*as):Y>0&&(bs=3*vs,vs++,as=_/(_-Y),this.clipVertices2[bs]=As+(Ps-As)*as,this.clipVertices2[bs+1]=ks+(gs-ks)*as,this.clipVertices2[bs+2]=Ss+(ws-Ss)*as,bs=3*vs,vs++,this.clipVertices2[bs]=Ps,this.clipVertices2[bs+1]=gs,this.clipVertices2[bs+2]=ws),As=Ps,ks=gs,Ss=ws,_=Y;if(zs=vs,0!=zs){for(vs=0,bs=3*(zs-1),As=this.clipVertices2[bs],ks=this.clipVertices2[bs+1],Ss=this.clipVertices2[bs+2],_=(As-Yi+qi)*-Bi+(ks-Xi+Fi)*-Ei+(Ss-Ri+ji)*-_i,Ls=0;Ls<zs;Ls++)bs=3*Ls,Ps=this.clipVertices2[bs],gs=this.clipVertices2[bs+1],ws=this.clipVertices2[bs+2],Y=(Ps-Yi+qi)*-Bi+(gs-Xi+Fi)*-Ei+(ws-Ri+ji)*-_i,_>0?Y>0?(bs=3*vs,vs++,this.clipVertices1[bs]=Ps,this.clipVertices1[bs+1]=gs,this.clipVertices1[bs+2]=ws):(bs=3*vs,vs++,as=_/(_-Y),this.clipVertices1[bs]=As+(Ps-As)*as,this.clipVertices1[bs+1]=ks+(gs-ks)*as,this.clipVertices1[bs+2]=Ss+(ws-Ss)*as):Y>0&&(bs=3*vs,vs++,as=_/(_-Y),this.clipVertices1[bs]=As+(Ps-As)*as,this.clipVertices1[bs+1]=ks+(gs-ks)*as,this.clipVertices1[bs+2]=Ss+(ws-Ss)*as,bs=3*vs,vs++,this.clipVertices1[bs]=Ps,this.clipVertices1[bs+1]=gs,this.clipVertices1[bs+2]=ws),As=Ps,ks=gs,Ss=ws,_=Y;if(zs=vs,Hi){var Vs=h;h=e,e=Vs}if(0!=zs){var Cs=h!=t;if(zs>4){As=.25*(ns+cs+Os+ys),ks=.25*(rs+ms+us+Is),Ss=.25*(ls+ps+xs+Ms),Ci=ns-As,Ti=rs-ks,Di=ls-Ss,Bi=cs-As,Ei=ms-ks,_i=ps-Ss;var Ts=0,Ds=0,Bs=0,Es=0,_s=-this.INF;for(ds=this.INF,Ls=0;Ls<zs;Ls++)this.used[Ls]=!1,bs=3*Ls,As=this.clipVertices1[bs],ks=this.clipVertices1[bs+1],Ss=this.clipVertices1[bs+2],Ns=As*Ci+ks*Ti+Ss*Di,Ns<ds&&(ds=Ns,Ts=Ls),Ns>_s&&(_s=Ns,Bs=Ls);for(this.used[Ts]=!0,this.used[Bs]=!0,_s=-this.INF,ds=this.INF,Ls=0;Ls<zs;Ls++)this.used[Ls]||(bs=3*Ls,As=this.clipVertices1[bs],ks=this.clipVertices1[bs+1],Ss=this.clipVertices1[bs+2],Ns=As*Bi+ks*Ei+Ss*_i,Ns<ds&&(ds=Ns,Ds=Ls),Ns>_s&&(_s=Ns,Es=Ls));bs=3*Ts,As=this.clipVertices1[bs],ks=this.clipVertices1[bs+1],Ss=this.clipVertices1[bs+2],Ns=(As-Yi)*wi+(ks-Xi)*Li+(Ss-Ri)*Vi,Ns<0&&s.addPoint(As,ks,Ss,wi,Li,Vi,Ns,Cs),bs=3*Ds,As=this.clipVertices1[bs],ks=this.clipVertices1[bs+1],Ss=this.clipVertices1[bs+2],Ns=(As-Yi)*wi+(ks-Xi)*Li+(Ss-Ri)*Vi,Ns<0&&s.addPoint(As,ks,Ss,wi,Li,Vi,Ns,Cs),bs=3*Bs,As=this.clipVertices1[bs],ks=this.clipVertices1[bs+1],Ss=this.clipVertices1[bs+2],Ns=(As-Yi)*wi+(ks-Xi)*Li+(Ss-Ri)*Vi,Ns<0&&s.addPoint(As,ks,Ss,wi,Li,Vi,Ns,Cs),bs=3*Es,As=this.clipVertices1[bs],ks=this.clipVertices1[bs+1],Ss=this.clipVertices1[bs+2],Ns=(As-Yi)*wi+(ks-Xi)*Li+(Ss-Ri)*Vi,Ns<0&&s.addPoint(As,ks,Ss,wi,Li,Vi,Ns,Cs)}else for(Ls=0;Ls<zs;Ls++)bs=3*Ls,As=this.clipVertices1[bs],ks=this.clipVertices1[bs+1],Ss=this.clipVertices1[bs+2],Ns=(As-Yi)*wi+(ks-Xi)*Li+(Ss-Ri)*Vi,Ns<0&&s.addPoint(As,ks,Ss,wi,Li,Vi,Ns,Cs)}}}}}},OIMO.SphereBoxCollisionDetector=function(t){OIMO.CollisionDetector.call(this),this.flip=t},OIMO.SphereBoxCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype),OIMO.SphereBoxCollisionDetector.prototype.constructor=OIMO.SphereBoxCollisionDetector,OIMO.SphereBoxCollisionDetector.prototype.detectCollision=function(t,i,s){var h,e;this.flip?(h=i,e=t):(h=t,e=i);var o,a,n,r,l,c=e.dimentions,m=h.position,p=m.x,O=m.y,u=m.z,x=e.position,y=x.x,I=x.y,M=x.z,d=h.radius,N=e.halfWidth,f=e.halfHeight,z=e.halfDepth,v=p-y,b=O-I,A=u-M,k=c[0]*v+c[1]*b+c[2]*A,S=c[3]*v+c[4]*b+c[5]*A,P=c[6]*v+c[7]*b+c[8]*A,g=0;k>N?k=N:k<-N?k=-N:g=1,S>f?S=f:S<-f?S=-f:g|=2,P>z?P=z:P<-z?P=-z:g|=4,7==g?(v=k<0?N+k:N-k,b=S<0?f+S:f-S,A=P<0?z+P:z-P,v<b?v<A?(r=v-N,k<0?(k=-N,v=c[0],b=c[1],A=c[2]):(k=N,v=-c[0],b=-c[1],A=-c[2])):(r=A-z,P<0?(P=-z,v=c[6],b=c[7],A=c[8]):(P=z,v=-c[6],b=-c[7],A=-c[8])):b<A?(r=b-f,S<0?(S=-f,v=c[3],b=c[4],A=c[5]):(S=f,v=-c[3],b=-c[4],A=-c[5])):(r=A-z,P<0?(P=-z,v=c[6],b=c[7],A=c[8]):(P=z,v=-c[6],b=-c[7],A=-c[8])),o=y+k*c[0]+S*c[3]+P*c[6],a=I+k*c[1]+S*c[4]+P*c[7],n=M+k*c[2]+S*c[5]+P*c[8],s.addPoint(p+d*v,O+d*b,u+d*A,v,b,A,r-d,this.flip)):(o=y+k*c[0]+S*c[3]+P*c[6],a=I+k*c[1]+S*c[4]+P*c[7],n=M+k*c[2]+S*c[5]+P*c[8],v=o-m.x,b=a-m.y,A=n-m.z,r=v*v+b*b+A*A,r>0&&r<d*d&&(r=OIMO.sqrt(r),l=1/r,v*=l,b*=l,A*=l,s.addPoint(p+d*v,O+d*b,u+d*A,v,b,A,r-d,this.flip)))},OIMO.SphereSphereCollisionDetector=function(){OIMO.CollisionDetector.call(this)},OIMO.SphereSphereCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype),OIMO.SphereSphereCollisionDetector.prototype.constructor=OIMO.SphereSphereCollisionDetector,OIMO.SphereSphereCollisionDetector.prototype.detectCollision=function(t,i,s){var h=t,e=i,o=h.position,a=e.position,n=a.x-o.x,r=a.y-o.y,l=a.z-o.z,c=n*n+r*r+l*l,m=h.radius,p=e.radius,O=m+p;if(c>0&&c<O*O){c=OIMO.sqrt(c);var u=1/c;n*=u,r*=u,l*=u,s.addPoint(o.x+n*m,o.y+r*m,o.z+l*m,n,r,l,c-O,!1)}},OIMO.BoxCylinderCollisionDetector=function(t){OIMO.CollisionDetector.call(this),this.flip=t},OIMO.BoxCylinderCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype),OIMO.BoxCylinderCollisionDetector.prototype.constructor=OIMO.BoxCylinderCollisionDetector,OIMO.BoxCylinderCollisionDetector.prototype.getSep=function(t,i,s,h,e){var o,a,n,r,l,c,m,p,O,u,x,y,I,M=new OIMO.Vec3,d=t.position.x,N=t.position.y,f=t.position.z,z=i.position.x,v=i.position.y,b=i.position.z,A=z-d,k=v-N,S=b-f;A*A+k*k+S*S==0&&(k=.001);var P=-A,g=-k,w=-S;this.supportPointB(t,-P,-g,-w,M);var L=M.x,V=M.y,C=M.z;this.supportPointC(i,P,g,w,M);var T=M.x,D=M.y,B=M.z,E=T-L,_=D-V,Y=B-C;if(E*P+_*g+Y*w<=0)return!1;if(P=_*S-Y*k,g=Y*A-E*S,w=E*k-_*A,P*P+g*g+w*w==0)return s.init(E-A,_-k,Y-S),s.normalize(s),h.init(.5*(L+T),.5*(V+D),.5*(C+B)),!0;this.supportPointB(t,-P,-g,-w,M);var X=M.x,R=M.y,Z=M.z;this.supportPointC(i,P,g,w,M);var U=M.x,J=M.y,q=M.z,F=U-X,j=J-R,H=q-Z;if(F*P+j*g+H*w<=0)return!1;o=E-A,a=_-k,n=Y-S,r=F-A,l=j-k,c=H-S,P=a*c-n*l,g=n*r-o*c,w=o*l-a*r,P*A+g*k+w*S>0&&(o=E,a=_,n=Y,E=F,_=j,Y=H,F=o,j=a,H=n,o=L,a=V,n=C,L=X,V=R,C=Z,X=o,R=a,Z=n,o=T,a=D,n=B,T=U,D=J,B=q,U=o,J=a,q=n,P=-P,g=-g,w=-w);for(var W=0;;){if(++W>100)return!1;this.supportPointB(t,-P,-g,-w,M);var Q=M.x,G=M.y,K=M.z;this.supportPointC(i,P,g,w,M);var $=M.x,tt=M.y,it=M.z,st=$-Q,ht=tt-G,et=it-K;if(st*P+ht*g+et*w<=0)return!1;if((_*et-Y*ht)*A+(Y*st-E*et)*k+(E*ht-_*st)*S<0)F=st,j=ht,H=et,X=Q,R=G,Z=K,U=$,J=tt,q=it,o=E-A,a=_-k,n=Y-S,r=st-A,l=ht-k,c=et-S,P=a*c-n*l,g=n*r-o*c,w=o*l-a*r;else if((ht*H-et*j)*A+(et*F-st*H)*k+(st*j-ht*F)*S<0)E=st,_=ht,Y=et,L=Q,V=G,C=K,T=$,D=tt,B=it,o=st-A,a=ht-k,n=et-S,r=F-A,l=j-k,c=H-S,P=a*c-n*l,g=n*r-o*c,w=o*l-a*r;else for(var ot=!1;;){if(o=F-E,a=j-_,n=H-Y,r=st-E,l=ht-_,c=et-Y,P=a*c-n*l,g=n*r-o*c,w=o*l-a*r,m=1/OIMO.sqrt(P*P+g*g+w*w),P*=m,g*=m,w*=m,P*E+g*_+w*Y>=0&&!ot){var at=(_*H-Y*j)*st+(Y*F-E*H)*ht+(E*j-_*F)*et,nt=(ht*H-et*j)*A+(et*F-st*H)*k+(st*j-ht*F)*S,rt=(k*Y-S*_)*st+(S*E-A*Y)*ht+(A*_-k*E)*et,lt=(j*Y-H*_)*A+(H*E-F*Y)*k+(F*_-j*E)*S,ct=at+nt+rt+lt;ct<=0&&(at=0,nt=(j*et-H*ht)*P+(H*st-F*et)*g+(F*ht-j*st)*w,rt=(ht*H-et*j)*P+(et*F-st*H)*g+(st*j-ht*F)*w,lt=(_*H-Y*j)*P+(Y*F-E*H)*g+(E*j-_*F)*w,ct=nt+rt+lt);var mt=1/ct;p=(d*at+L*nt+X*rt+Q*lt)*mt,O=(N*at+V*nt+R*rt+G*lt)*mt,u=(f*at+C*nt+Z*rt+K*lt)*mt,x=(z*at+T*nt+U*rt+$*lt)*mt,y=(v*at+D*nt+J*rt+tt*lt)*mt,I=(b*at+B*nt+q*rt+it*lt)*mt,ot=!0}this.supportPointB(t,-P,-g,-w,M);var pt=M.x,Ot=M.y,ut=M.z;this.supportPointC(i,P,g,w,M);var xt=M.x,yt=M.y,It=M.z,Mt=xt-pt,dt=yt-Ot,Nt=It-ut,ft=-(Mt*P+dt*g+Nt*w);if((Mt-st)*P+(dt-ht)*g+(Nt-et)*w<=.01||ft>=0)return!!ot&&(s.init(-P,-g,-w),h.init(.5*(p+x),.5*(O+y),.5*(u+I)),e.x=ft,!0);(dt*Y-Nt*_)*A+(Nt*E-Mt*Y)*k+(Mt*_-dt*E)*S<0?(dt*H-Nt*j)*A+(Nt*F-Mt*H)*k+(Mt*j-dt*F)*S<0?(E=Mt,_=dt,Y=Nt,L=pt,V=Ot,C=ut,T=xt,D=yt,B=It):(st=Mt,ht=dt,et=Nt,Q=pt,G=Ot,K=ut,$=xt,tt=yt,it=It):(dt*et-Nt*ht)*A+(Nt*st-Mt*et)*k+(Mt*ht-dt*st)*S<0?(F=Mt,j=dt,H=Nt,X=pt,R=Ot,Z=ut,U=xt,J=yt,q=It):(E=Mt,_=dt,Y=Nt,L=pt,V=Ot,C=ut,T=xt,D=yt,B=It)}}},OIMO.BoxCylinderCollisionDetector.prototype.supportPointB=function(t,i,s,h,e){var o,a,n,r=t.rotation.elements,l=r[0]*i+r[3]*s+r[6]*h,c=r[1]*i+r[4]*s+r[7]*h,m=r[2]*i+r[5]*s+r[8]*h,p=t.halfWidth,O=t.halfHeight,u=t.halfDepth;o=l<0?-p:p,a=c<0?-O:O,n=m<0?-u:u,l=r[0]*o+r[1]*a+r[2]*n+t.position.x,c=r[3]*o+r[4]*a+r[5]*n+t.position.y,m=r[6]*o+r[7]*a+r[8]*n+t.position.z,e.init(l,c,m)},OIMO.BoxCylinderCollisionDetector.prototype.supportPointC=function(t,i,s,h,e){var o,a,n,r=t.rotation.elements,l=r[0]*i+r[3]*s+r[6]*h,c=r[1]*i+r[4]*s+r[7]*h,m=r[2]*i+r[5]*s+r[8]*h,p=l,O=m,u=p*p+O*O,x=t.radius,y=t.halfHeight;0==u?c<0?(o=x,a=-y,n=0):(o=x,a=y,n=0):(u=t.radius/OIMO.sqrt(u),c<0?(o=p*u,a=-y,n=O*u):(o=p*u,a=y,n=O*u)),l=r[0]*o+r[1]*a+r[2]*n+t.position.x,c=r[3]*o+r[4]*a+r[5]*n+t.position.y,m=r[6]*o+r[7]*a+r[8]*n+t.position.z,e.init(l,c,m)},OIMO.BoxCylinderCollisionDetector.prototype.detectCollision=function(t,i,s){var h,e;this.flip?(h=i,e=t):(h=t,e=i);var o=new OIMO.Vec3,a=new OIMO.Vec3,n=new OIMO.Vec3;if(this.getSep(h,e,o,a,n)){var r=h.position.x,l=h.position.y,c=h.position.z,m=e.position.x,p=e.position.y,O=e.position.z,u=h.halfWidth,x=h.halfHeight,y=h.halfDepth,I=e.halfHeight,M=e.radius,d=h.dimentions,N=d[0],f=d[1],z=d[2],v=d[3],b=d[4],A=d[5],k=d[6],S=d[7],P=d[8],g=d[9],w=d[10],L=d[11],V=d[12],C=d[13],T=d[14],D=d[15],B=d[16],E=d[17],_=e.normalDirection.x,Y=e.normalDirection.y,X=e.normalDirection.z,R=e.halfDirection.x,Z=e.halfDirection.y,U=e.halfDirection.z,J=o.x,q=o.y,F=o.z,j=J*N+q*f+F*z,H=J*v+q*b+F*A,W=J*k+q*S+F*P,Q=J*_+q*Y+F*X,G=j>0,K=H>0,$=W>0,tt=Q>0;G||(j=-j),K||(H=-H),$||(W=-W),tt||(Q=-Q);var it=0;Q>.999?it=j>.999?j>Q?1:4:H>.999?H>Q?2:4:W>.999&&W>Q?3:4:j>.999?it=1:H>.999?it=2:W>.999&&(it=3);var st,ht,et,ot,at,nt,rt,lt,ct,mt,pt,Ot,ut,xt,yt,It,Mt,dt,Nt,ft,zt,vt,bt,At,kt,St,Pt,gt,wt,Lt,Vt,Ct,Tt,Dt,Bt,Et,_t,Yt,Xt,Rt,Zt,Ut,Jt,qt,Ft,jt,Ht,Wt,Qt,Gt,Kt,$t,ti;if(0==it)s.addPoint(a.x,a.y,a.z,J,q,F,n.x,this.flip);else if(4==it){tt?(ot=m-R,at=p-Z,nt=O-U,J=-_,q=-Y,F=-X):(ot=m+R,at=p+Z,nt=O+U,J=_,q=Y,F=X);var ii,si,hi,ei,oi,ai,ni,ri,li,ci,mi,pi;ft=1,it=0,Jt=N*J+f*q+z*F,Jt<ft&&(ft=Jt,it=0),-Jt<ft&&(ft=-Jt,it=1),Jt=v*J+b*q+A*F,Jt<ft&&(ft=Jt,it=2),-Jt<ft&&(ft=-Jt,it=3),Jt=k*J+S*q+P*F,Jt<ft&&(ft=Jt,it=4),-Jt<ft&&(ft=-Jt,it=5);var Oi=h.elements;switch(it){case 0:ii=Oi[0],si=Oi[1],hi=Oi[2],ei=Oi[6],oi=Oi[7],ai=Oi[8],ni=Oi[9],ri=Oi[10],li=Oi[11],ci=Oi[3],mi=Oi[4],pi=Oi[5];break;case 1:ii=Oi[15],si=Oi[16],hi=Oi[17],ei=Oi[21],oi=Oi[22],ai=Oi[23],ni=Oi[18],ri=Oi[19],li=Oi[20],ci=Oi[12],mi=Oi[13],pi=Oi[14];break;case 2:ii=Oi[12],si=Oi[13],hi=Oi[14],ei=Oi[0],oi=Oi[1],ai=Oi[2],ni=Oi[3],ri=Oi[4],li=Oi[5],ci=Oi[15],mi=Oi[16],pi=Oi[17];break;case 3:ii=Oi[21],si=Oi[22],hi=Oi[23],ei=Oi[9],oi=Oi[10],ai=Oi[11],ni=Oi[6],ri=Oi[7],li=Oi[8],ci=Oi[18],mi=Oi[19],pi=Oi[20];break;case 4:ii=Oi[12],si=Oi[13],hi=Oi[14],ei=Oi[18],oi=Oi[19],ai=Oi[20],ni=Oi[6],ri=Oi[7],li=Oi[8],ci=Oi[0],mi=Oi[1],pi=Oi[2];break;case 5:ii=Oi[3],si=Oi[4],hi=Oi[5],ei=Oi[9],oi=Oi[10],ai=Oi[11],ni=Oi[21],ri=Oi[22],li=Oi[23],ci=Oi[15],mi=Oi[16],pi=Oi[17]}Nt=J*(ii-ot)+q*(si-at)+F*(hi-nt),Nt<=0&&s.addPoint(ii,si,hi,-J,-q,-F,Nt,this.flip),Nt=J*(ei-ot)+q*(oi-at)+F*(ai-nt),Nt<=0&&s.addPoint(ei,oi,ai,-J,-q,-F,Nt,this.flip),Nt=J*(ni-ot)+q*(ri-at)+F*(li-nt),Nt<=0&&s.addPoint(ni,ri,li,-J,-q,-F,Nt,this.flip),Nt=J*(ci-ot)+q*(mi-at)+F*(pi-nt),Nt<=0&&s.addPoint(ci,mi,pi,-J,-q,-F,Nt,this.flip)}else{switch(it){case 1:G?(st=r+g,ht=l+w,et=c+L,J=N,q=f,F=z):(st=r-g,ht=l-w,et=c-L,J=-N,q=-f,F=-z),jt=v,Ht=b,Wt=A,$t=x,Qt=k,Gt=S,Kt=P,ti=y;break;case 2:K?(st=r+V,ht=l+C,et=c+T,J=v,q=b,F=A):(st=r-V,ht=l-C,et=c-T,J=-v,q=-b,F=-A),jt=N,Ht=f,Wt=z,$t=u,Qt=k,Gt=S,Kt=P,ti=y;break;case 3:$?(st=r+D,ht=l+B,et=c+E,J=k,q=S,F=P):(st=r-D,ht=l-B,et=c-E,J=-k,q=-S,F=-P),jt=N,Ht=f,Wt=z,$t=u,Qt=v,Gt=b,Kt=A,ti=x}if(ft=J*_+q*Y+F*X,zt=ft<0?I:-I,ot=m+zt*_,at=p+zt*Y,nt=O+zt*X,Q>=.999999?(vt=-q,bt=F,At=J):(vt=J,bt=q,At=F),zt=vt*_+bt*Y+At*X,St=zt*_-vt,Pt=zt*Y-bt,gt=zt*X-At,zt=OIMO.sqrt(St*St+Pt*Pt+gt*gt),0==zt)return;if(zt=M/zt,St*=zt,Pt*=zt,gt*=zt,vt=ot+St,bt=at+Pt,At=nt+gt,ft<-.96||ft>.96)rt=_*_*1.5-.5,lt=_*Y*1.5-.866025403*X,ct=_*X*1.5+.866025403*Y,mt=Y*_*1.5+.866025403*X,pt=Y*Y*1.5-.5,Ot=Y*X*1.5-.866025403*_,ut=X*_*1.5-.866025403*Y,xt=X*Y*1.5+.866025403*_,yt=X*X*1.5-.5,It=vt,Mt=bt,dt=At,Nt=J*(It-st)+q*(Mt-ht)+F*(dt-et),vt=It-Nt*J-st,bt=Mt-Nt*q-ht,At=dt-Nt*F-et,Yt=jt*vt+Ht*bt+Wt*At,Ut=Qt*vt+Gt*bt+Kt*At,Yt<-$t?Yt=-$t:Yt>$t&&(Yt=$t),Ut<-ti?Ut=-ti:Ut>ti&&(Ut=ti),vt=Yt*jt+Ut*Qt,bt=Yt*Ht+Ut*Gt,At=Yt*Wt+Ut*Kt,It=st+vt,Mt=ht+bt,dt=et+At,s.addPoint(It,Mt,dt,J,q,F,Nt,this.flip),It=St*rt+Pt*lt+gt*ct,Mt=St*mt+Pt*pt+gt*Ot,dt=St*ut+Pt*xt+gt*yt,It=(St=It)+ot,Mt=(Pt=Mt)+at,dt=(gt=dt)+nt,Nt=J*(It-st)+q*(Mt-ht)+F*(dt-et),Nt<=0&&(vt=It-Nt*J-st,bt=Mt-Nt*q-ht,At=dt-Nt*F-et,Yt=jt*vt+Ht*bt+Wt*At,Ut=Qt*vt+Gt*bt+Kt*At,Yt<-$t?Yt=-$t:Yt>$t&&(Yt=$t),Ut<-ti?Ut=-ti:Ut>ti&&(Ut=ti),vt=Yt*jt+Ut*Qt,bt=Yt*Ht+Ut*Gt,At=Yt*Wt+Ut*Kt,It=st+vt,Mt=ht+bt,dt=et+At,s.addPoint(It,Mt,dt,J,q,F,Nt,this.flip)),It=St*rt+Pt*lt+gt*ct,Mt=St*mt+Pt*pt+gt*Ot,dt=St*ut+Pt*xt+gt*yt,It=(St=It)+ot,Mt=(Pt=Mt)+at,dt=(gt=dt)+nt,Nt=J*(It-st)+q*(Mt-ht)+F*(dt-et),Nt<=0&&(vt=It-Nt*J-st,bt=Mt-Nt*q-ht,At=dt-Nt*F-et,Yt=jt*vt+Ht*bt+Wt*At,Ut=Qt*vt+Gt*bt+Kt*At,Yt<-$t?Yt=-$t:Yt>$t&&(Yt=$t),Ut<-ti?Ut=-ti:Ut>ti&&(Ut=ti),vt=Yt*jt+Ut*Qt,bt=Yt*Ht+Ut*Gt,At=Yt*Wt+Ut*Kt,It=st+vt,Mt=ht+bt,dt=et+At,s.addPoint(It,Mt,dt,J,q,F,Nt,this.flip));else{if(Bt=vt,Et=bt,_t=At,Yt=J*(Bt-st)+q*(Et-ht)+F*(_t-et),Bt-=Yt*J,Et-=Yt*q,_t-=Yt*F,ft>0?(Xt=vt+2*R,Rt=bt+2*Z,Zt=At+2*U):(Xt=vt-2*R,Rt=bt-2*Z,Zt=At-2*U),Ut=J*(Xt-st)+q*(Rt-ht)+F*(Zt-et),Xt-=Ut*J,Rt-=Ut*q,Zt-=Ut*F,wt=Bt-st,Lt=Et-ht,Vt=_t-et,Ct=Xt-st,Tt=Rt-ht,Dt=Zt-et,vt=Xt-Bt,bt=Rt-Et,At=Zt-_t,kt=Ut-Yt,j=wt*jt+Lt*Ht+Vt*Wt,H=Ct*jt+Tt*Ht+Dt*Wt,Jt=j-$t,qt=H-$t,Jt>0){if(qt>0)return;Ft=Jt/(Jt-qt),Bt+=vt*Ft,Et+=bt*Ft,_t+=At*Ft,Yt+=kt*Ft,wt=Bt-st,Lt=Et-ht,Vt=_t-et,j=wt*jt+Lt*Ht+Vt*Wt,vt=Xt-Bt,bt=Rt-Et,At=Zt-_t,kt=Ut-Yt}else qt>0&&(Ft=Jt/(Jt-qt),Xt=Bt+vt*Ft,Rt=Et+bt*Ft,Zt=_t+At*Ft,Ut=Yt+kt*Ft,Ct=Xt-st,Tt=Rt-ht,Dt=Zt-et,H=Ct*jt+Tt*Ht+Dt*Wt,vt=Xt-Bt,bt=Rt-Et,At=Zt-_t,kt=Ut-Yt);if(Jt=j+$t,qt=H+$t,Jt<0){if(qt<0)return;Ft=Jt/(Jt-qt),Bt+=vt*Ft,Et+=bt*Ft,_t+=At*Ft,Yt+=kt*Ft,wt=Bt-st,Lt=Et-ht,Vt=_t-et,vt=Xt-Bt,bt=Rt-Et,At=Zt-_t,kt=Ut-Yt}else qt<0&&(Ft=Jt/(Jt-qt),Xt=Bt+vt*Ft,Rt=Et+bt*Ft,Zt=_t+At*Ft,Ut=Yt+kt*Ft,Ct=Xt-st,Tt=Rt-ht,Dt=Zt-et,vt=Xt-Bt,bt=Rt-Et,At=Zt-_t,kt=Ut-Yt);if(j=wt*Qt+Lt*Gt+Vt*Kt,H=Ct*Qt+Tt*Gt+Dt*Kt,Jt=j-ti,qt=H-ti,Jt>0){if(qt>0)return;Ft=Jt/(Jt-qt),Bt+=vt*Ft,Et+=bt*Ft,_t+=At*Ft,Yt+=kt*Ft,wt=Bt-st,Lt=Et-ht,Vt=_t-et,j=wt*Qt+Lt*Gt+Vt*Kt,vt=Xt-Bt,bt=Rt-Et,At=Zt-_t,kt=Ut-Yt}else qt>0&&(Ft=Jt/(Jt-qt),Xt=Bt+vt*Ft,Rt=Et+bt*Ft,Zt=_t+At*Ft,Ut=Yt+kt*Ft,Ct=Xt-st,Tt=Rt-ht,Dt=Zt-et,H=Ct*Qt+Tt*Gt+Dt*Kt,vt=Xt-Bt,bt=Rt-Et,At=Zt-_t,kt=Ut-Yt);if(Jt=j+ti,qt=H+ti,Jt<0){if(qt<0)return;Ft=Jt/(Jt-qt),Bt+=vt*Ft,Et+=bt*Ft,_t+=At*Ft,Yt+=kt*Ft}else qt<0&&(Ft=Jt/(Jt-qt),Xt=Bt+vt*Ft,Rt=Et+bt*Ft,Zt=_t+At*Ft,Ut=Yt+kt*Ft);Yt<0&&s.addPoint(Bt,Et,_t,J,q,F,Yt,this.flip),Ut<0&&s.addPoint(Xt,Rt,Zt,J,q,F,Ut,this.flip)}}}},OIMO.CylinderCylinderCollisionDetector=function(){OIMO.CollisionDetector.call(this)},OIMO.CylinderCylinderCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype),OIMO.CylinderCylinderCollisionDetector.prototype.constructor=OIMO.CylinderCylinderCollisionDetector,OIMO.CylinderCylinderCollisionDetector.prototype.getSep=function(t,i,s,h,e){var o,a,n,r,l,c,m,p,O,u,x,y,I,M=new OIMO.Vec3,d=t.position.x,N=t.position.y,f=t.position.z,z=i.position.x,v=i.position.y,b=i.position.z,A=z-d,k=v-N,S=b-f;A*A+k*k+S*S==0&&(k=.001);var P=-A,g=-k,w=-S;this.supportPoint(t,-P,-g,-w,M);var L=M.x,V=M.y,C=M.z;this.supportPoint(i,P,g,w,M);var T=M.x,D=M.y,B=M.z,E=T-L,_=D-V,Y=B-C;if(E*P+_*g+Y*w<=0)return!1;if(P=_*S-Y*k,g=Y*A-E*S,w=E*k-_*A,P*P+g*g+w*w==0)return s.init(E-A,_-k,Y-S),s.normalize(s),h.init(.5*(L+T),.5*(V+D),.5*(C+B)),!0;this.supportPoint(t,-P,-g,-w,M);var X=M.x,R=M.y,Z=M.z;this.supportPoint(i,P,g,w,M);var U=M.x,J=M.y,q=M.z,F=U-X,j=J-R,H=q-Z;if(F*P+j*g+H*w<=0)return!1;o=E-A,a=_-k,n=Y-S,r=F-A,l=j-k,c=H-S,P=a*c-n*l,g=n*r-o*c,w=o*l-a*r,P*A+g*k+w*S>0&&(o=E,a=_,n=Y,E=F,_=j,Y=H,F=o,j=a,H=n,o=L,a=V,n=C,L=X,V=R,C=Z,X=o,R=a,Z=n,o=T,a=D,n=B,T=U,D=J,B=q,U=o,J=a,q=n,P=-P,g=-g,w=-w);for(var W=0;;){if(++W>100)return!1;this.supportPoint(t,-P,-g,-w,M);var Q=M.x,G=M.y,K=M.z;this.supportPoint(i,P,g,w,M);var $=M.x,tt=M.y,it=M.z,st=$-Q,ht=tt-G,et=it-K;if(st*P+ht*g+et*w<=0)return!1;if((_*et-Y*ht)*A+(Y*st-E*et)*k+(E*ht-_*st)*S<0)F=st,j=ht,H=et,X=Q,R=G,Z=K,U=$,J=tt,q=it,o=E-A,a=_-k,n=Y-S,r=st-A,l=ht-k,c=et-S,P=a*c-n*l,g=n*r-o*c,w=o*l-a*r;else if((ht*H-et*j)*A+(et*F-st*H)*k+(st*j-ht*F)*S<0)E=st,_=ht,Y=et,L=Q,V=G,C=K,T=$,D=tt,B=it,o=st-A,a=ht-k,n=et-S,r=F-A,l=j-k,c=H-S,P=a*c-n*l,g=n*r-o*c,w=o*l-a*r;else for(var ot=!1;;){if(o=F-E,a=j-_,n=H-Y,r=st-E,l=ht-_,c=et-Y,P=a*c-n*l,g=n*r-o*c,w=o*l-a*r,m=1/OIMO.sqrt(P*P+g*g+w*w),P*=m,g*=m,w*=m,P*E+g*_+w*Y>=0&&!ot){var at=(_*H-Y*j)*st+(Y*F-E*H)*ht+(E*j-_*F)*et,nt=(ht*H-et*j)*A+(et*F-st*H)*k+(st*j-ht*F)*S,rt=(k*Y-S*_)*st+(S*E-A*Y)*ht+(A*_-k*E)*et,lt=(j*Y-H*_)*A+(H*E-F*Y)*k+(F*_-j*E)*S,ct=at+nt+rt+lt;ct<=0&&(at=0,nt=(j*et-H*ht)*P+(H*st-F*et)*g+(F*ht-j*st)*w,rt=(ht*H-et*j)*P+(et*F-st*H)*g+(st*j-ht*F)*w,lt=(_*H-Y*j)*P+(Y*F-E*H)*g+(E*j-_*F)*w,ct=nt+rt+lt);var mt=1/ct;p=(d*at+L*nt+X*rt+Q*lt)*mt,O=(N*at+V*nt+R*rt+G*lt)*mt,u=(f*at+C*nt+Z*rt+K*lt)*mt,x=(z*at+T*nt+U*rt+$*lt)*mt,y=(v*at+D*nt+J*rt+tt*lt)*mt,I=(b*at+B*nt+q*rt+it*lt)*mt,ot=!0}this.supportPoint(t,-P,-g,-w,M);var pt=M.x,Ot=M.y,ut=M.z;this.supportPoint(i,P,g,w,M);var xt=M.x,yt=M.y,It=M.z,Mt=xt-pt,dt=yt-Ot,Nt=It-ut,ft=-(Mt*P+dt*g+Nt*w);if((Mt-st)*P+(dt-ht)*g+(Nt-et)*w<=.01||ft>=0)return!!ot&&(s.init(-P,-g,-w),h.init(.5*(p+x),.5*(O+y),.5*(u+I)),e.x=ft,!0);(dt*Y-Nt*_)*A+(Nt*E-Mt*Y)*k+(Mt*_-dt*E)*S<0?(dt*H-Nt*j)*A+(Nt*F-Mt*H)*k+(Mt*j-dt*F)*S<0?(E=Mt,_=dt,Y=Nt,L=pt,V=Ot,C=ut,T=xt,D=yt,B=It):(st=Mt,ht=dt,et=Nt,Q=pt,G=Ot,K=ut,$=xt,tt=yt,it=It):(dt*et-Nt*ht)*A+(Nt*st-Mt*et)*k+(Mt*ht-dt*st)*S<0?(F=Mt,j=dt,H=Nt,X=pt,R=Ot,Z=ut,U=xt,J=yt,q=It):(E=Mt,_=dt,Y=Nt,L=pt,V=Ot,C=ut,T=xt,D=yt,B=It)}}},OIMO.CylinderCylinderCollisionDetector.prototype.supportPoint=function(t,i,s,h,e){var o,a,n,r=t.rotation.elements,l=r[0]*i+r[3]*s+r[6]*h,c=r[1]*i+r[4]*s+r[7]*h,m=r[2]*i+r[5]*s+r[8]*h,p=l,O=m,u=p*p+O*O,x=t.radius,y=t.halfHeight;0==u?c<0?(o=x,a=-y,n=0):(o=x,a=y,n=0):(u=t.radius/OIMO.sqrt(u),c<0?(o=p*u,a=-y,n=O*u):(o=p*u,a=y,n=O*u)),l=r[0]*o+r[1]*a+r[2]*n+t.position.x,c=r[3]*o+r[4]*a+r[5]*n+t.position.y,m=r[6]*o+r[7]*a+r[8]*n+t.position.z,e.init(l,c,m)},OIMO.CylinderCylinderCollisionDetector.prototype.detectCollision=function(t,i,s){var h,e;t.id<i.id?(h=t,e=i):(h=i,e=t);var o,a,n,r,l,c,m,p,O,u,x,y,I,M,d,N,f,z,v,b,A,k=h.position,S=e.position,P=k.x,g=k.y,w=k.z,L=S.x,V=S.y,C=S.z,T=h.halfHeight,D=e.halfHeight,B=h.normalDirection,E=e.normalDirection,_=h.halfDirection,Y=e.halfDirection,X=h.radius,R=e.radius,Z=B.x,U=B.y,J=B.z,q=E.x,F=E.y,j=E.z,H=_.x,W=_.y,Q=_.z,G=Y.x,K=Y.y,$=Y.z,tt=P-L,it=g-V,st=w-C,ht=new OIMO.Vec3,et=new OIMO.Vec3,ot=new OIMO.Vec3;if(this.getSep(h,e,ht,et,ot)){var at=ht.x*Z+ht.y*U+ht.z*J,nt=ht.x*q+ht.y*F+ht.z*j,rt=at>0,lt=nt>0;rt||(at=-at),lt||(nt=-nt);var ct=0;(at>.999||nt>.999)&&(ct=at>nt?1:2);var mt,pt,Ot,ut,xt,yt,It,Mt,dt,Nt,ft,zt,vt,bt,At,kt,St,Pt,gt,wt,Lt=ot.x;switch(mt=ht.x,pt=ht.y,Ot=ht.z,ct){case 0:s.addPoint(et.x,et.y,et.z,mt,pt,Ot,Lt,!1);break;case 1:if(rt?(a=P+H,n=g+W,r=w+Q,mt=Z,pt=U,Ot=J):(a=P-H,n=g-W,r=w-Q,mt=-Z,pt=-U,Ot=-J),v=mt*q+pt*F+Ot*j,o=v<0?D:-D,l=L+o*q,c=V+o*F,m=C+o*j,nt>=.999999?(p=-pt,O=Ot,u=mt):(p=mt,O=pt,u=Ot),o=p*q+O*F+u*j,tt=o*q-p,it=o*F-O,st=o*j-u,o=OIMO.sqrt(tt*tt+it*it+st*st),0==o)break;if(o=R/o,tt*=o,it*=o,st*=o,p=l+tt,O=c+it,u=m+st,v<-.96||v>.96)ut=q*q*1.5-.5,xt=q*F*1.5-.866025403*j,yt=q*j*1.5+.866025403*F,It=F*q*1.5+.866025403*j,Mt=F*F*1.5-.5,dt=F*j*1.5-.866025403*q,Nt=j*q*1.5-.866025403*F,ft=j*F*1.5+.866025403*q,zt=j*j*1.5-.5,vt=p,bt=O,At=u,kt=mt*(vt-a)+pt*(bt-n)+Ot*(At-r),p=vt-kt*mt-a,O=bt-kt*pt-n,u=At-kt*Ot-r,o=p*p+O*O+u*u,o>X*X&&(o=X/OIMO.sqrt(o),p*=o,O*=o,u*=o),vt=a+p,bt=n+O,At=r+u,s.addPoint(vt,bt,At,mt,pt,Ot,kt,!1),vt=tt*ut+it*xt+st*yt,bt=tt*It+it*Mt+st*dt,At=tt*Nt+it*ft+st*zt,vt=(tt=vt)+l,bt=(it=bt)+c,At=(st=At)+m,kt=mt*(vt-a)+pt*(bt-n)+Ot*(At-r),kt<=0&&(p=vt-kt*mt-a,O=bt-kt*pt-n,u=At-kt*Ot-r,o=p*p+O*O+u*u,o>X*X&&(o=X/OIMO.sqrt(o),p*=o,O*=o,u*=o),vt=a+p,bt=n+O,At=r+u,s.addPoint(vt,bt,At,mt,pt,Ot,kt,!1)),vt=tt*ut+it*xt+st*yt,bt=tt*It+it*Mt+st*dt,At=tt*Nt+it*ft+st*zt,vt=(tt=vt)+l,bt=(it=bt)+c,At=(st=At)+m,kt=mt*(vt-a)+pt*(bt-n)+Ot*(At-r),kt<=0&&(p=vt-kt*mt-a,O=bt-kt*pt-n,u=At-kt*Ot-r,o=p*p+O*O+u*u,o>X*X&&(o=X/OIMO.sqrt(o),p*=o,O*=o,u*=o),vt=a+p,bt=n+O,At=r+u,s.addPoint(vt,bt,At,mt,pt,Ot,kt,!1));else{if(x=p,y=O,I=u,f=mt*(x-a)+pt*(y-n)+Ot*(I-r),x-=f*mt,y-=f*pt,I-=f*Ot,v>0?(M=p+q*D*2,d=O+F*D*2,N=u+j*D*2):(M=p-q*D*2,d=O-F*D*2,N=u-j*D*2),z=mt*(M-a)+pt*(d-n)+Ot*(N-r),M-=z*mt,d-=z*pt,N-=z*Ot,tt=a-x,it=n-y,st=r-I,p=M-x,O=d-y,u=N-I,St=tt*tt+it*it+st*st,Pt=tt*p+it*O+st*u,gt=p*p+O*O+u*u,wt=Pt*Pt-gt*(St-X*X),wt<0)break;wt=OIMO.sqrt(wt),b=(Pt+wt)/gt,A=(Pt-wt)/gt,A<b&&(o=b,b=A,A=o),A>1&&(A=1),b<0&&(b=0),p=x+(M-x)*b,O=y+(d-y)*b,u=I+(N-I)*b,M=x+(M-x)*A,d=y+(d-y)*A,N=I+(N-I)*A,x=p,y=O,I=u,o=f+(z-f)*b,z=f+(z-f)*A,f=o,f<0&&s.addPoint(x,y,I,mt,pt,Ot,kt,!1),z<0&&s.addPoint(M,d,N,mt,pt,Ot,kt,!1)}break;case 2:if(lt?(l=L-G,c=V-K,m=C-$,mt=-q,pt=-F,Ot=-j):(l=L+G,c=V+K,m=C+$,mt=q,pt=F,Ot=j),v=mt*Z+pt*U+Ot*J,o=v<0?T:-T,a=P+o*Z,n=g+o*U,r=w+o*J,at>=.999999?(p=-pt,O=Ot,u=mt):(p=mt,O=pt,u=Ot),o=p*Z+O*U+u*J,tt=o*Z-p,it=o*U-O,st=o*J-u,o=OIMO.sqrt(tt*tt+it*it+st*st),0==o)break;if(o=X/o,tt*=o,it*=o,st*=o,p=a+tt,O=n+it,u=r+st,v<-.96||v>.96)ut=Z*Z*1.5-.5,xt=Z*U*1.5-.866025403*J,yt=Z*J*1.5+.866025403*U,It=U*Z*1.5+.866025403*J,Mt=U*U*1.5-.5,dt=U*J*1.5-.866025403*Z,Nt=J*Z*1.5-.866025403*U,ft=J*U*1.5+.866025403*Z,zt=J*J*1.5-.5,vt=p,bt=O,At=u,kt=mt*(vt-l)+pt*(bt-c)+Ot*(At-m),p=vt-kt*mt-l,O=bt-kt*pt-c,u=At-kt*Ot-m,o=p*p+O*O+u*u,o>R*R&&(o=R/OIMO.sqrt(o),p*=o,O*=o,u*=o),vt=l+p,bt=c+O,At=m+u,s.addPoint(vt,bt,At,-mt,-pt,-Ot,kt,!1),vt=tt*ut+it*xt+st*yt,bt=tt*It+it*Mt+st*dt,At=tt*Nt+it*ft+st*zt,vt=(tt=vt)+a,bt=(it=bt)+n,At=(st=At)+r,kt=mt*(vt-l)+pt*(bt-c)+Ot*(At-m),kt<=0&&(p=vt-kt*mt-l,O=bt-kt*pt-c,u=At-kt*Ot-m,o=p*p+O*O+u*u,o>R*R&&(o=R/OIMO.sqrt(o),p*=o,O*=o,u*=o),vt=l+p,bt=c+O,At=m+u,s.addPoint(vt,bt,At,-mt,-pt,-Ot,kt,!1)),vt=tt*ut+it*xt+st*yt,bt=tt*It+it*Mt+st*dt,At=tt*Nt+it*ft+st*zt,vt=(tt=vt)+a,bt=(it=bt)+n,At=(st=At)+r,kt=mt*(vt-l)+pt*(bt-c)+Ot*(At-m),kt<=0&&(p=vt-kt*mt-l,O=bt-kt*pt-c,u=At-kt*Ot-m,o=p*p+O*O+u*u,o>R*R&&(o=R/OIMO.sqrt(o),p*=o,O*=o,u*=o),vt=l+p,bt=c+O,At=m+u,s.addPoint(vt,bt,At,-mt,-pt,-Ot,kt,!1));else{if(x=p,y=O,I=u,f=mt*(x-l)+pt*(y-c)+Ot*(I-m),x-=f*mt,y-=f*pt,I-=f*Ot,v>0?(M=p+Z*T*2,d=O+U*T*2,N=u+J*T*2):(M=p-Z*T*2,d=O-U*T*2,N=u-J*T*2),z=mt*(M-l)+pt*(d-c)+Ot*(N-m),M-=z*mt,d-=z*pt,N-=z*Ot,tt=l-x,it=c-y,st=m-I,p=M-x,O=d-y,u=N-I,St=tt*tt+it*it+st*st,Pt=tt*p+it*O+st*u,gt=p*p+O*O+u*u,wt=Pt*Pt-gt*(St-R*R),wt<0)break;wt=OIMO.sqrt(wt),b=(Pt+wt)/gt,A=(Pt-wt)/gt,A<b&&(o=b,b=A,A=o),A>1&&(A=1),b<0&&(b=0),p=x+(M-x)*b,O=y+(d-y)*b,u=I+(N-I)*b,M=x+(M-x)*A,d=y+(d-y)*A,N=I+(N-I)*A,x=p,y=O,I=u,o=f+(z-f)*b,z=f+(z-f)*A,f=o,f<0&&s.addPoint(x,y,I,-mt,-pt,-Ot,f,!1),z<0&&s.addPoint(M,d,N,-mt,-pt,-Ot,z,!1)}}}},OIMO.SphereCylinderCollisionDetector=function(t){OIMO.CollisionDetector.call(this),this.flip=t},OIMO.SphereCylinderCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype),OIMO.SphereCylinderCollisionDetector.prototype.constructor=OIMO.SphereCylinderCollisionDetector,OIMO.SphereCylinderCollisionDetector.prototype.detectCollision=function(t,i,s){var h,e;this.flip?(h=i,e=t):(h=t,e=i);var o=h.position,a=o.x,n=o.y,r=o.z,l=e.position,c=l.x,m=l.y,p=l.z,O=e.normalDirection.x,u=e.normalDirection.y,x=e.normalDirection.z,y=h.radius,I=e.radius,M=y+I,d=e.halfHeight,N=a-c,f=n-m,z=r-p,v=N*O+f*u+z*x;if(!(v<-d-y||v>d+y)){var b=c+v*O,A=m+v*u,k=p+v*x,S=a-b,P=n-A,g=r-k,w=S*S+P*P+g*g;if(!(w>M*M)){w>I*I&&(w=I/OIMO.sqrt(w),S*=w,P*=w,g*=w),v<-d?v=-d:v>d&&(v=d),b=c+v*O+S,A=m+v*u+P,k=p+v*x+g,N=b-a,f=A-n,z=k-r,w=N*N+f*f+z*z;var L;w>0&&w<y*y&&(w=OIMO.sqrt(w),L=1/w,N*=L,f*=L,z*=L,s.addPoint(a+N*y,n+f*y,r+z*y,N,f,z,w-y,this.flip))}}},OIMO.TetraTetraCollisionDetector=function(){OIMO.CollisionDetector.call(this)},OIMO.TetraTetraCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype),OIMO.TetraTetraCollisionDetector.prototype.constructor=OIMO.TetraTetraCollisionDetector,
OIMO.TetraTetraCollisionDetector.prototype.detectCollision=function(t,i,s){var h,e,o,a,n,r,l=t.faces,c=t.verts,m=(i.faces,i.verts),p=0,O=l;for(h=0;h<4;h++)for(o=c[h],e=0;e<4;e++)a=m[O[h].a],n=m[O[h].b],r=m[O[h].c],tricheck(pt(o.x,o.y),pt(a.x,a.y),pt(n.x,n.y),pt(r.x,r.y))&&tricheck(pt(o.x,o.z),pt(a.x,a.z),pt(n.x,n.z),pt(r.x,r.z))&&tricheck(pt(o.z,o.y),pt(a.z,a.y),pt(n.z,n.y),pt(r.z,r.y))&&p++,4===p&&s.addPoint(o)},OIMO.AABB=function(t,i,s,h,e,o){this.elements=new OIMO_ARRAY_TYPE(6);var a=this.elements;a[0]=t||0,a[1]=s||0,a[2]=e||0,a[3]=i||0,a[4]=h||0,a[5]=o||0},OIMO.AABB.prototype={constructor:OIMO.AABB,set:function(t,i,s,h,e,o){var a=this.elements;return a[0]=t,a[3]=i,a[1]=s,a[4]=h,a[2]=e,a[5]=o,this},intersectTest:function(t){var i=this.elements,s=t.elements;return i[0]>s[3]||i[1]>s[4]||i[2]>s[5]||i[3]<s[0]||i[4]<s[1]||i[5]<s[2]},intersectTestTwo:function(t){var i=this.elements,s=t.elements;return i[0]<s[0]||i[1]<s[1]||i[2]<s[2]||i[3]>s[3]||i[4]>s[4]||i[5]>s[5]},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(t,i){var s=i||0,h=t.elements;return this.set(h[0]-s,h[3]+s,h[1]-s,h[4]+s,h[2]-s,h[5]+s),this},fromArray:function(t){return this.elements.set(t),this},combine:function(t,i){var s=t.elements,h=i.elements,e=this.elements;return e[0]=s[0]<h[0]?s[0]:h[0],e[1]=s[1]<h[1]?s[1]:h[1],e[2]=s[2]<h[2]?s[2]:h[2],e[3]=s[3]>h[3]?s[3]:h[3],e[4]=s[4]>h[4]?s[4]:h[4],e[5]=s[5]>h[5]?s[5]:h[5],this},surfaceArea:function(){var t=this.elements,i=t[3]-t[0],s=t[4]-t[1],h=t[5]-t[2];return 2*(i*(s+h)+s*h)},intersectsWithPoint:function(t,i,s){var h=this.elements;return t>=h[0]&&t<=h[3]&&i>=h[1]&&i<=h[4]&&s>=h[2]&&s<=h[5]},setFromPoints:function(t){this.makeEmpty();for(var i=0;i<t.length;i++)this.expandByPoint(t[i])},makeEmpty:function(){this.set(-(1/0),-(1/0),-(1/0),1/0,1/0,1/0)},expandByPoint:function(t){var i=this.elements;this.set(OIMO.min(i[0],t.x),OIMO.min(i[1],t.y),OIMO.min(i[2],t.z),OIMO.max(i[3],t.x),OIMO.max(i[4],t.y),OIMO.max(i[5],t.z))}},OIMO.Proxy=function(t){this.shape=t,this.aabb=t.aabb},OIMO.Proxy.prototype={constructor:OIMO.Proxy,update:function(){OIMO.Error("Proxy","Inheritance error.")}},OIMO.BasicProxy=function(t){OIMO.Proxy.call(this,t),this.id=OIMO.proxyID++},OIMO.BasicProxy.prototype=Object.create(OIMO.Proxy.prototype),OIMO.BasicProxy.prototype.constructor=OIMO.BasicProxy,OIMO.BasicProxy.prototype.update=function(){},OIMO.BroadPhase=function(){this.types=OIMO.BR_NULL,this.numPairChecks=0,this.numPairs=0,this.pairs=[]},OIMO.BroadPhase.prototype={constructor:OIMO.BroadPhase,createProxy:function(t){OIMO.Error("BroadPhase","Inheritance error.")},addProxy:function(t){OIMO.Error("BroadPhase","Inheritance error.")},removeProxy:function(t){OIMO.Error("BroadPhase","Inheritance error.")},isAvailablePair:function(t,i){var s=t.parent,h=i.parent;if(s==h||!s.isDynamic&&!h.isDynamic||0==(t.belongsTo&i.collidesWith)||0==(i.belongsTo&t.collidesWith))return!1;var e;for(e=s.numJoints<h.numJoints?s.jointLink:h.jointLink;null!==e;){var o=e.joint;if(!o.allowCollision&&(o.body1==s&&o.body2==h||o.body1==h&&o.body2==s))return!1;e=e.next}return!0},detectPairs:function(){this.pairs=[],this.numPairs=0,this.numPairChecks=0,this.collectPairs()},collectPairs:function(){OIMO.Error("BroadPhase","Inheritance error.")},addPair:function(t,i){var s=new OIMO.Pair(t,i);this.pairs.push(s),this.numPairs++}},OIMO.BruteForceBroadPhase=function(){OIMO.BroadPhase.call(this),this.types=OIMO.BR_BRUTE_FORCE,this.proxies=[]},OIMO.BruteForceBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype),OIMO.BruteForceBroadPhase.prototype.constructor=OIMO.BruteForceBroadPhase,OIMO.BruteForceBroadPhase.prototype.createProxy=function(t){return new OIMO.BasicProxy(t)},OIMO.BruteForceBroadPhase.prototype.addProxy=function(t){this.proxies.push(t)},OIMO.BruteForceBroadPhase.prototype.removeProxy=function(t){var i=this.proxies.indexOf(t);i>-1&&this.proxies.splice(i,1)},OIMO.BruteForceBroadPhase.prototype.collectPairs=function(){var t,i,s,h=0,e=this.proxies,o=e.length;for(this.numPairChecks=o*(o-1)>>1;h<o;)for(i=e[h++],t=h+1;t<o;)s=e[t++],!i.aabb.intersectTest(s.aabb)&&this.isAvailablePair(i.shape,s.shape)&&this.addPair(i.shape,s.shape)},OIMO.Pair=function(t,i){this.shape1=t||null,this.shape2=i||null},OIMO.SAPAxis=function(){this.numElements=0,this.bufferSize=256,this.elements=[],this.elements.length=this.bufferSize,this.stack=new OIMO_ARRAY_TYPE(64)},OIMO.SAPAxis.prototype={constructor:OIMO.SAPAxis,addElements:function(t,i){if(this.numElements+2>=this.bufferSize){this.bufferSize*=2;for(var s=[],h=this.numElements;h--;)s[h]=this.elements[h]}this.elements[this.numElements++]=t,this.elements[this.numElements++]=i},removeElements:function(t,i){for(var s=-1,h=-1,e=0,o=this.numElements;e<o;e++){var a=this.elements[e];if(a==t||a==i){if(s!=-1){h=e;break}s=e}}for(e=s+1,o=h;e<o;e++)this.elements[e-1]=this.elements[e];for(e=h+1,o=this.numElements;e<o;e++)this.elements[e-2]=this.elements[e];this.elements[--this.numElements]=null,this.elements[--this.numElements]=null},sort:function(){for(var t=0,i=1;this.numElements>>i!=0;)i++;i=i*this.numElements>>2,t=0;for(var s=!1,h=this.elements,e=1,o=this.numElements;e<o;e++){var a=h[e],n=a.value,r=h[e-1];if(r.value>n){var l=e;do{if(h[l]=r,0==--l)break;r=h[l-1]}while(r.value>n);if(h[l]=a,t+=e-l,t>i){s=!0;break}}}if(s){t=2;var c=this.stack;for(c[0]=0,c[1]=this.numElements-1;t>0;){var m=c[--t],p=c[--t],O=m-p;if(O>16){var u=p+OIMO.floor(.5*O);for(a=h[u],h[u]=h[m],h[m]=a,n=a.value,e=p-1,l=m;;){var x,y;do x=h[++e];while(x.value<n);do y=h[--l];while(n<y.value&&l!=p);if(e>=l)break;h[e]=y,h[l]=x}h[m]=h[e],h[e]=a,e-p>m-e?(c[t++]=p,c[t++]=e-1,c[t++]=e+1,c[t++]=m):(c[t++]=e+1,c[t++]=m,c[t++]=p,c[t++]=e-1)}else for(e=p+1;e<=m;e++)if(a=h[e],n=a.value,r=h[e-1],r.value>n){l=e;do{if(h[l]=r,0==--l)break;r=h[l-1]}while(r.value>n);h[l]=a}}}},calculateTestCount:function(){for(var t=1,i=0,s=1,h=this.numElements;s<h;s++)this.elements[s].max?t--:(i+=t,t++);return i}},OIMO.SAPBroadPhase=function(){OIMO.BroadPhase.call(this),this.types=OIMO.BR_SWEEP_AND_PRUNE,this.numElementsD=0,this.numElementsS=0,this.axesD=[new OIMO.SAPAxis,new OIMO.SAPAxis,new OIMO.SAPAxis],this.axesS=[new OIMO.SAPAxis,new OIMO.SAPAxis,new OIMO.SAPAxis],this.index1=0,this.index2=1},OIMO.SAPBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype),OIMO.SAPBroadPhase.prototype.constructor=OIMO.SAPBroadPhase,OIMO.SAPBroadPhase.prototype.createProxy=function(t){return new OIMO.SAPProxy(this,t)},OIMO.SAPBroadPhase.prototype.addProxy=function(t){var i=t;i.isDynamic()?(this.axesD[0].addElements(i.min[0],i.max[0]),this.axesD[1].addElements(i.min[1],i.max[1]),this.axesD[2].addElements(i.min[2],i.max[2]),i.belongsTo=1,this.numElementsD+=2):(this.axesS[0].addElements(i.min[0],i.max[0]),this.axesS[1].addElements(i.min[1],i.max[1]),this.axesS[2].addElements(i.min[2],i.max[2]),i.belongsTo=2,this.numElementsS+=2)},OIMO.SAPBroadPhase.prototype.removeProxy=function(t){var i=t;if(0!=i.belongsTo){switch(i.belongsTo){case 1:this.axesD[0].removeElements(i.min[0],i.max[0]),this.axesD[1].removeElements(i.min[1],i.max[1]),this.axesD[2].removeElements(i.min[2],i.max[2]),this.numElementsD-=2;break;case 2:this.axesS[0].removeElements(i.min[0],i.max[0]),this.axesS[1].removeElements(i.min[1],i.max[1]),this.axesS[2].removeElements(i.min[2],i.max[2]),this.numElementsS-=2}i.belongsTo=0}},OIMO.SAPBroadPhase.prototype.collectPairs=function(){if(0!=this.numElementsD){var t=this.axesD[this.index1],i=this.axesD[this.index2];t.sort(),i.sort();var s,h,e=t.calculateTestCount(),o=i.calculateTestCount();e<=o?(i=this.axesS[this.index1],i.sort(),s=t.elements,h=i.elements):(t=this.axesS[this.index2],t.sort(),s=i.elements,h=t.elements,this.index1^=this.index2,this.index2^=this.index1,this.index1^=this.index2);for(var a,n,r=0,l=0;r<this.numElementsD;){var c,m;if(l==this.numElementsS)c=s[r],m=!0,r++;else{var p=s[r],O=h[l];p.value<O.value?(c=p,m=!0,r++):(c=O,m=!1,l++)}if(c.max){var u=c.pair;if(m){if(u==a){a=a.pair;continue}c=a}else{if(u==n){n=n.pair;continue}c=n}do{if(N=c.pair,N==u){c.pair=N.pair;break}c=N}while(null!=c)}else{for(var x=c.proxy.shape,y=c.min1.value,I=c.max1.value,M=c.min2.value,d=c.max2.value,N=a;null!=N;N=N.pair){var f=N.proxy.shape;this.numPairChecks++,y>N.max1.value||I<N.min1.value||M>N.max2.value||d<N.min2.value||!this.isAvailablePair(x,f)||this.addPair(x,f)}if(m){for(N=n;null!=N;N=N.pair)f=N.proxy.shape,this.numPairChecks++,y>N.max1.value||I<N.min1.value||M>N.max2.value||d<N.min2.value||!this.isAvailablePair(x,f)||this.addPair(x,f);c.pair=a,a=c}else c.pair=n,n=c}}this.index2=3^(this.index1|this.index2)}},OIMO.SAPElement=function(t,i){this.proxy=t,this.pair=null,this.min1=null,this.max1=null,this.min2=null,this.max2=null,this.max=i,this.value=0},OIMO.SAPProxy=function(t,i){OIMO.Proxy.call(this,i),this.belongsTo=0,this.max=[],this.min=[],this.sap=t,this.min[0]=new OIMO.SAPElement(this,(!1)),this.max[0]=new OIMO.SAPElement(this,(!0)),this.min[1]=new OIMO.SAPElement(this,(!1)),this.max[1]=new OIMO.SAPElement(this,(!0)),this.min[2]=new OIMO.SAPElement(this,(!1)),this.max[2]=new OIMO.SAPElement(this,(!0)),this.max[0].pair=this.min[0],this.max[1].pair=this.min[1],this.max[2].pair=this.min[2],this.min[0].min1=this.min[1],this.min[0].max1=this.max[1],this.min[0].min2=this.min[2],this.min[0].max2=this.max[2],this.min[1].min1=this.min[0],this.min[1].max1=this.max[0],this.min[1].min2=this.min[2],this.min[1].max2=this.max[2],this.min[2].min1=this.min[0],this.min[2].max1=this.max[0],this.min[2].min2=this.min[1],this.min[2].max2=this.max[1]},OIMO.SAPProxy.prototype=Object.create(OIMO.Proxy.prototype),OIMO.SAPProxy.prototype.constructor=OIMO.SAPProxy,OIMO.SAPProxy.prototype.isDynamic=function(){var t=this.shape.parent;return t.isDynamic&&!t.sleeping},OIMO.SAPProxy.prototype.update=function(){var t=this.aabb.elements;this.min[0].value=t[0],this.min[1].value=t[1],this.min[2].value=t[2],this.max[0].value=t[3],this.max[1].value=t[4],this.max[2].value=t[5],(1==this.belongsTo&&!this.isDynamic()||2==this.belongsTo&&this.isDynamic())&&(this.sap.removeProxy(this),this.sap.addProxy(this))},OIMO.DBVT=function(){this.root=null,this.freeNodes=[],this.freeNodes.length=16384,this.numFreeNodes=0,this.aabb=new OIMO.AABB},OIMO.DBVT.prototype={constructor:OIMO.DBVT,moveLeaf:function(t){this.deleteLeaf(t),this.insertLeaf(t)},insertLeaf:function(t){if(null==this.root)return void(this.root=t);for(var i,s,h=t.aabb,e=this.root;null==e.proxy;){var o=e.child1,a=e.child2,n=e.aabb,r=o.aabb,l=a.aabb;i=n.surfaceArea(),this.aabb.combine(h,n),s=this.aabb.surfaceArea();var c=2*s,m=2*(s-i),p=m;this.aabb.combine(h,r),p+=null!=o.proxy?this.aabb.surfaceArea():this.aabb.surfaceArea()-r.surfaceArea();var O=m;if(this.aabb.combine(h,l),O+=null!=a.proxy?this.aabb.surfaceArea():this.aabb.surfaceArea()-l.surfaceArea(),p<O){if(c<p)break;e=o}else{if(c<O)break;e=a}}var u,x=e.parent;u=this.numFreeNodes>0?this.freeNodes[--this.numFreeNodes]:new OIMO.DBVTNode,u.parent=x,u.child1=t,u.child2=e,u.aabb.combine(t.aabb,e.aabb),u.height=e.height+1,e.parent=u,t.parent=u,e==this.root?this.root=u:x.child1==e?x.child1=u:x.child2=u;do u=this.balance(u),this.fix(u),u=u.parent;while(null!=u)},getBalance:function(t){return null!=t.proxy?0:t.child1.height-t.child2.height},deleteLeaf:function(t){if(t==this.root)return void(this.root=null);var i,s=t.parent;if(i=s.child1==t?s.child2:s.child1,s==this.root)return this.root=i,void(i.parent=null);var h=s.parent;i.parent=h,h.child1==s?h.child1=i:h.child2=i,this.numFreeNodes<16384&&(this.freeNodes[this.numFreeNodes++]=s);do h=this.balance(h),this.fix(h),h=h.parent;while(null!=h)},balance:function(t){var i=t.height;if(i<2)return t;var s,h=t.parent,e=t.child1,o=t.child2,a=e.height,n=o.height,r=a-n;if(r>1){var l=e.child1,c=e.child2,m=l.height,p=c.height;return m>p?(e.child2=t,t.parent=e,t.child1=c,c.parent=t,t.aabb.combine(c.aabb,o.aabb),s=p-n,t.height=p-(s&s>>31)+1,e.aabb.combine(l.aabb,t.aabb),s=m-i,e.height=m-(s&s>>31)+1):(e.child1=t,t.parent=e,t.child1=l,l.parent=t,t.aabb.combine(l.aabb,o.aabb),s=m-n,t.height=m-(s&s>>31)+1,e.aabb.combine(t.aabb,c.aabb),s=i-p,e.height=i-(s&s>>31)+1),null!=h?h.child1==t?h.child1=e:h.child2=e:this.root=e,e.parent=h,e}if(r<-1){var O=o.child1,u=o.child2,x=O.height,y=u.height;return x>y?(o.child2=t,t.parent=o,t.child2=u,u.parent=t,t.aabb.combine(e.aabb,u.aabb),s=a-y,t.height=a-(s&s>>31)+1,o.aabb.combine(O.aabb,t.aabb),s=x-i,o.height=x-(s&s>>31)+1):(o.child1=t,t.parent=o,t.child2=O,O.parent=t,t.aabb.combine(e.aabb,O.aabb),s=a-x,t.height=a-(s&s>>31)+1,o.aabb.combine(t.aabb,u.aabb),s=i-y,o.height=i-(s&s>>31)+1),null!=h?h.child1==t?h.child1=o:h.child2=o:this.root=o,o.parent=h,o}return t},fix:function(t){var i=t.child1,s=t.child2;t.aabb.combine(i.aabb,s.aabb),t.height=i.height<s.height?s.height+1:i.height+1}},OIMO.DBVTBroadPhase=function(){OIMO.BroadPhase.call(this),this.types=OIMO.BR_BOUNDING_VOLUME_TREE,this.tree=new OIMO.DBVT,this.stack=[],this.leaves=[],this.numLeaves=0},OIMO.DBVTBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype),OIMO.DBVTBroadPhase.prototype.constructor=OIMO.DBVTBroadPhase,OIMO.DBVTBroadPhase.prototype.createProxy=function(t){return new OIMO.DBVTProxy(t)},OIMO.DBVTBroadPhase.prototype.addProxy=function(t){this.tree.insertLeaf(t.leaf),this.leaves.push(t.leaf),this.numLeaves++},OIMO.DBVTBroadPhase.prototype.removeProxy=function(t){this.tree.deleteLeaf(t.leaf);var i=this.leaves.indexOf(t.leaf);i>-1&&(this.leaves.splice(i,1),this.numLeaves--)},OIMO.DBVTBroadPhase.prototype.collectPairs=function(){if(!(this.numLeaves<2))for(var t,i=.1,s=this.numLeaves;s--;)t=this.leaves[s],t.proxy.aabb.intersectTestTwo(t.aabb)&&(t.aabb.copy(t.proxy.aabb,i),this.tree.deleteLeaf(t),this.tree.insertLeaf(t),this.collide(t,this.tree.root))},OIMO.DBVTBroadPhase.prototype.collide=function(t,i){var s,h,e,o,a,n,r=2;for(this.stack[0]=t,this.stack[1]=i;r>0;)if(e=this.stack[--r],o=this.stack[--r],a=null!=e.proxy,n=null!=o.proxy,this.numPairChecks++,a&&n){if(s=e.proxy.shape,h=o.proxy.shape,s==h||s.aabb.intersectTest(h.aabb)||!this.isAvailablePair(s,h))continue;this.addPair(s,h)}else{if(e.aabb.intersectTest(o.aabb))continue;n||!a&&e.aabb.surfaceArea()>o.aabb.surfaceArea()?(this.stack[r++]=e.child1,this.stack[r++]=o,this.stack[r++]=e.child2,this.stack[r++]=o):(this.stack[r++]=e,this.stack[r++]=o.child1,this.stack[r++]=e,this.stack[r++]=o.child2)}},OIMO.DBVTNode=function(){this.child1=null,this.child2=null,this.parent=null,this.proxy=null,this.height=0,this.aabb=new OIMO.AABB},OIMO.DBVTProxy=function(t){OIMO.Proxy.call(this,t),this.leaf=new OIMO.DBVTNode,this.leaf.proxy=this},OIMO.DBVTProxy.prototype=Object.create(OIMO.Proxy.prototype),OIMO.DBVTProxy.prototype.constructor=OIMO.DBVTProxy,OIMO.DBVTProxy.prototype.update=function(){},OIMO.World.prototype.add=function(t){t=t||{};var i=t.type||"box";if("string"==typeof i&&(i=[i]),"joint"==i[0].substring(0,5)){"joint"===i[0]&&(i[0]="jointHinge");var s=t.axe1||[1,0,0],h=t.axe2||[1,0,0],e=t.pos1||[0,0,0],o=t.pos2||[0,0,0];e=e.map(function(t){return t*OIMO.INV_SCALE}),o=o.map(function(t){return t*OIMO.INV_SCALE});var a,n;"jointDistance"===i[0]?(a=t.min||0,n=t.max||10,a*=OIMO.INV_SCALE,n*=OIMO.INV_SCALE):(a=t.min||57.29578,n=t.max||0,a*=OIMO.degtorad,n*=OIMO.degtorad);var r=t.limit||null,l=t.spring||null,c=t.motor||null,m=new OIMO.JointConfig;m.allowCollision=t.collision||!1,m.localAxis1.init(s[0],s[1],s[2]),m.localAxis2.init(h[0],h[1],h[2]),m.localAnchorPoint1.init(e[0],e[1],e[2]),m.localAnchorPoint2.init(o[0],o[1],o[2]),("string"==typeof t.body1||t.body1 instanceof String)&&(t.body1=this.getByName(t.body1)),("string"==typeof t.body2||t.body2 instanceof String)&&(t.body2=this.getByName(t.body2)),m.body1=t.body1,m.body2=t.body2;var p;switch(i[0]){case"jointDistance":p=new OIMO.DistanceJoint(m,a,n),null!==l&&p.limitMotor.setSpring(l[0],l[1]),null!==c&&p.limitMotor.setSpring(c[0],c[1]);break;case"jointHinge":p=new OIMO.HingeJoint(m,a,n),null!==l&&p.limitMotor.setSpring(l[0],l[1]),null!==c&&p.limitMotor.setSpring(c[0],c[1]);break;case"jointPrisme":p=new OIMO.PrismaticJoint(m,a,n);break;case"jointSlide":p=new OIMO.SliderJoint(m,a,n);break;case"jointBall":p=new OIMO.BallAndSocketJoint(m);break;case"jointWheel":p=new OIMO.WheelJoint(m),null!==r&&p.rotationalLimitMotor1.setLimit(r[0],r[1]),null!==l&&p.rotationalLimitMotor1.setSpring(l[0],l[1]),null!==c&&p.rotationalLimitMotor1.setSpring(c[0],c[1])}return p.name=t.name||"",this.addJoint(p),p}var O=t.move||!1,u=t.noSleep||!1,x=t.pos||[0,0,0];x=x.map(function(t){return t*OIMO.INV_SCALE});var y=t.size||[1,1,1];y=y.map(function(t){return t*OIMO.INV_SCALE});var I=t.rot||[0,0,0];I=I.map(function(t){return t*OIMO.degtorad});for(var M=[],d=0;d<I.length/3;d++){var N=OIMO.EulerToAxis(I[d+0],I[d+1],I[d+2]);M.push(N[0]),M.push(N[1]),M.push(N[2]),M.push(N[3])}var f=new OIMO.ShapeConfig;void 0!==t.sc&&(f=t.sc),t.config&&(f.density=void 0===t.config[0]?1:t.config[0],f.friction=void 0===t.config[1]?.4:t.config[1],f.restitution=void 0===t.config[2]?.2:t.config[2],f.belongsTo=t.config[3]||1,f.collidesWith=t.config[4]||4294967295),void 0!==t.density&&(f.density=t.density),void 0!==t.friction&&(f.friction=t.friction),void 0!==t.restitution&&(f.restitution=t.restitution),void 0!==t.belongsTo&&(f.belongsTo=t.belongsTo),void 0!==t.collidesWith&&(f.collidesWith=t.collidesWith),t.massPos&&(t.massPos=t.massPos.map(function(t){return t*OIMO.INV_SCALE}),f.relativePosition.init(t.massPos[0],t.massPos[1],t.massPos[2])),t.massRot&&(t.massRot=t.massRot.map(function(t){return t*OIMO.degtorad}),f.relativeRotation=OIMO.EulerToMatrix(t.massRot[0],t.massRot[1],t.massRot[2]));for(var z,v,b=new OIMO.RigidBody(x[0],x[1],x[2],M[0],M[1],M[2],M[3]),A=[],d=0;d<i.length;d++){switch(z=3*d,v=4*d,i[d]){case"sphere":A[d]=new OIMO.SphereShape(f,y[z]);break;case"cylinder":A[d]=new OIMO.CylinderShape(f,y[z],y[z+1]);break;case"box":A[d]=new OIMO.BoxShape(f,y[z],y[z+1],y[z+2])}b.addShape(A[d]),d>0&&(A[d].relativePosition=new OIMO.Vec3(x[z],x[z+1],x[z+2]),M[v+0]&&(A[d].relativeRotation=[M[v],M[v+1],M[v+2],M[v+3]]))}return O?(t.massPos||t.massRot?b.setupMass(1,!1):b.setupMass(1,!0),u?b.allowSleep=!1:b.allowSleep=!0):b.setupMass(2),b.name=t.name||" ",this.addRigidBody(b),b};